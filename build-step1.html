<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="/favicon.png">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Basic Information - LessonBuilders</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{--navy:#0D2847;--orange:#FF8C42;--green:#10B981;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#F7FAFC 0%,#FFF 100%);color:#0D2847;}

/* =========================
   TOP NAV (FIXED)
   - Always keeps "LessonBuilders" + LB on SAME line
   - Nav menu becomes the line below on mobile (scrolls horizontally)
   ========================= */
.top-nav{
  background:white;
  border-bottom:2px solid rgba(13,40,71,0.1);
  padding:16px 40px;
  position:sticky;
  top:0;
  z-index:1000;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
.nav-top-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
}
.logo-text{
  font-family:'Crimson Pro',serif;
  font-size:24px;
  font-weight:700;
  color:var(--navy);
  text-decoration:none;
  white-space:nowrap;
}
.nav-right{display:flex;align-items:center;gap:16px;}
.user-profile{
  width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,var(--orange),#FFB380);
  display:flex;align-items:center;justify-content:center;
  color:white;font-weight:600;font-size:14px;cursor:pointer;
  flex:0 0 auto;
}

/* desktop menu sits under the top row (clean + consistent) */
.nav-menu{
  display:flex;
  gap:32px;
  align-items:center;
  margin-top:10px;
}
.nav-link{
  text-decoration:none;
  color:#4A5568;
  font-weight:500;
  font-size:15px;
  transition:color 0.2s;
  white-space:nowrap;
}
.nav-link:hover{color:var(--navy);}

/* =========================
   PAGE LAYOUT
   ========================= */
.container{display:flex;max-width:1400px;margin:0 auto;}
.sidebar{width:280px;background:white;border-right:1px solid rgba(13,40,71,0.1);padding:30px 20px;}
.nav-step{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;cursor:default;transition:all 0.2s;border-left:3px solid transparent;text-decoration:none;color:#4A5568;}
.nav-step.active{background:rgba(255,140,66,0.1);border-left-color:var(--orange);color:var(--navy);font-weight:600;}
.step-number{width:28px;height:28px;border-radius:50%;background:#F7FAFC;border:2px solid #E2E8F0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:#999;}
.nav-step.active .step-number{background:var(--orange);border-color:var(--orange);color:white;}
.main-content{flex:1;padding:40px 60px;max-width:900px;}
.page-title{font-family:'Crimson Pro',serif;font-size:42px;font-weight:700;margin-bottom:12px;color:var(--navy);}
.page-subtitle{font-size:18px;color:#4A5568;margin-bottom:40px;}
.progress-bar{height:6px;background:#E2E8F0;border-radius:3px;margin-bottom:40px;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--orange),#FFB380);border-radius:3px;}
.form-group{margin-bottom:24px;}
.form-label{display:block;font-weight:600;margin-bottom:8px;color:var(--navy);font-size:15px;}
.form-input,.form-select{width:100%;padding:12px 16px;border:2px solid #E2E8F0;border-radius:10px;font-size:15px;font-family:'DM Sans',sans-serif;transition:all 0.2s;}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--orange);}
.slider{width:100%;height:8px;border-radius:4px;background:#E2E8F0;appearance:none;cursor:pointer;}
.slider::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--orange);cursor:pointer;}
.slider-value{text-align:center;margin-top:8px;font-weight:600;color:var(--navy);}
.btn{padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s;text-decoration:none;display:inline-block;border:none;}
.btn-primary{background:linear-gradient(135deg,var(--orange),#FFB380);color:white;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,140,66,0.4);}
.btn-secondary{background:white;border:2px solid #E2E8F0;color:var(--navy);}
.btn-secondary:hover{border-color:var(--orange);}
.btn-group{display:flex;justify-content:space-between;margin-top:40px;}

.optional-section{background:rgba(255,140,66,0.05);border:2px dashed rgba(255,140,66,0.3);border-radius:12px;padding:20px;margin:32px 0;transition:all 0.3s;}
.optional-section:hover{background:rgba(255,140,66,0.1);}
.optional-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;}
.optional-title{font-weight:600;color:var(--navy);font-size:16px;}
.optional-icon{font-size:20px;transition:transform 0.3s;}
.optional-icon.expanded{transform:rotate(180deg);}
.optional-content{max-height:0;overflow:hidden;transition:max-height 0.3s;}
.optional-content.show{max-height:1000px;margin-top:24px;}

/* Inspiration Uploads (Dropdown) */
.inspiration-wrap{margin-bottom:18px;}
.insp-header{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px;border:2px solid #E2E8F0;border-radius:12px;background:white;
  cursor:pointer;user-select:none;transition:all .2s;
}
.insp-header:hover{border-color:rgba(255,140,66,0.55);}
.insp-title{
  font-weight:800;color:var(--navy);font-size:13px;
  text-transform:uppercase;letter-spacing:.6px;
  display:flex;align-items:center;gap:10px;
}
.badge{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:22px;height:22px;padding:0 8px;border-radius:999px;
  background:rgba(255,140,66,0.12);color:var(--navy);font-weight:800;font-size:12px;
  border:1px solid rgba(255,140,66,0.25);
}
.insp-caret{font-size:12px;color:#718096;transition:transform .25s;}
.insp-caret.expanded{transform:rotate(180deg);}
.insp-body{margin-top:10px;max-height:0;overflow:hidden;transition:max-height .3s ease;}
.insp-body.show{max-height:1200px;}
.dropzone{
  border:2px dashed rgba(13,40,71,0.25);
  border-radius:12px;
  padding:14px;
  background:rgba(247,250,252,0.6);
  color:#4A5568;
  font-size:13px;
  line-height:1.35;
  text-align:center;
  cursor:pointer;
  transition:all .2s;
}
.dropzone:hover{border-color:rgba(255,140,66,0.55);background:rgba(255,140,66,0.06);}
.dropzone.dragover{border-color:var(--orange);background:rgba(255,140,66,0.10);}

.sidebar-actions{display:flex;gap:10px;margin-top:10px;}
.mini-btn{
  width:100%;
  padding:10px 12px;border-radius:10px;
  font-size:13px;font-weight:700;cursor:pointer;border:none;
  transition:all .2s;font-family:'DM Sans',sans-serif;
}
.mini-primary{background:linear-gradient(135deg,var(--orange),#FFB380);color:white;}
.mini-primary:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(255,140,66,0.25);}
.mini-secondary{background:white;border:2px solid #E2E8F0;color:var(--navy);}
.mini-secondary:hover{border-color:var(--orange);}

.file-list{margin-top:10px;display:grid;gap:8px;}
.sidebar-note{margin-top:12px;}
.sidebar-note textarea{
  width:100%;
  padding:12px 12px;
  border:2px solid #E2E8F0;border-radius:12px;
  font-size:13px;font-family:'DM Sans',sans-serif;
  resize:vertical;min-height:88px;
}
.sidebar-note textarea:focus{outline:none;border-color:var(--orange);}
.sidebar-hint{margin-top:10px;font-size:12px;color:#718096;line-height:1.35;}

/* ================================
   Mobile / Tablet responsiveness
   ================================ */
@media (max-width: 900px){
  .top-nav{padding:12px 16px;}
  /* menu becomes the second line and scrolls horizontally */
  .nav-menu{
    margin-top:10px;
    gap:14px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    flex-wrap:nowrap;
    padding-bottom:2px;
  }
  .nav-menu::-webkit-scrollbar{display:none;}
  .nav-link{font-size:14px;}

  .container{flex-direction:column;max-width:100%;}
  .sidebar{
    width:100%;
    border-right:none;
    border-bottom:1px solid rgba(13,40,71,0.1);
    padding:14px 12px;
    display:block;
  }
  .steps-label{display:none;}
  .steps-links{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;}
  .nav-step{
    flex:0 0 auto;
    margin-bottom:0;
    padding:10px 12px;
    border-left:none;
    border-bottom:3px solid transparent;
    border-radius:10px;
    background:#fff;
    white-space:nowrap;
  }
  .nav-step.active{
    border-bottom-color:var(--orange);
    background:rgba(255,140,66,0.08);
  }
  .nav-step.completed{color:var(--green);}
  .step-number{flex:0 0 auto;}
  .main-content{padding:22px 16px;max-width:100%;}
  .btn-group{gap:10px;}
  .btn{width:auto;padding:12px 14px;}
}

@media (max-width: 520px){
  .logo-text{font-size:20px;}
  .page-title{font-size:32px;}
  .page-subtitle{font-size:15px;}
}
</style>
</head>

<body>

<!-- ✅ NAV UPDATED: title + LB always share top row -->
<nav class="top-nav">
  <div class="nav-top-row">
    <a href="index.html" class="logo-text">LessonBuilders</a>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </div>

  <div class="nav-menu">
    <a href="build-step1.html" class="nav-link">Build</a>
    <a href="library.html" class="nav-link">My Lessons</a>
    <a href="assessments.html" class="nav-link">Assessments</a>
    <a href="discover.html" class="nav-link">Discover</a>
    <a href="about.html" class="nav-link">Help</a>
  </div>
</nav>

<div class="container">
  <aside class="sidebar">

    <!-- Inspiration Uploads dropdown -->
    <div class="inspiration-wrap" id="inspirationPanel">
      <div class="insp-header" id="inspHeader" role="button" tabindex="0" aria-expanded="false">
        <div class="insp-title">
          INSPIRATION UPLOADS <span class="badge" id="inspCountBadge">0</span>
        </div>
        <div class="insp-caret" id="inspCaret">▼</div>
      </div>

      <div class="insp-body" id="inspBody">
        <div class="dropzone" id="dropzone" tabindex="0" role="button" aria-label="Upload inspiration">
          <strong>Drag &amp; drop</strong> PDF, DOC, or image<br>
          or click “Browse Files”
        </div>

        <input id="filePicker" type="file" multiple
          accept="image/*,.pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
          style="display:none;">

        <div class="sidebar-actions">
          <button class="mini-btn mini-primary" type="button" onclick="openFilePicker()">Browse Files</button>
          <button class="mini-btn mini-secondary" type="button" onclick="clearAllInspiration()">Clear</button>
        </div>

        <div class="file-list" id="fileList" aria-live="polite"></div>

        <div class="sidebar-note">
          <label style="display:block;font-weight:700;color:var(--navy);font-size:13px;margin-bottom:6px;">Describe what you see in the upload and what you want to focus on?</label>
          <textarea id="inspirationNotes" placeholder="Example: The image is of a... The document consist of... Use the described image/document as the hook, modeling, guided practice, and the assessment."></textarea>
        </div>

        <div class="sidebar-hint">
          Stored locally for this lesson build, deleted after lesson save/export
        </div>
      </div>
    </div>

    <div class="steps-label" style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#999;margin-bottom:16px;">BUILD LESSON</div>

    <div class="steps-links">
      <div class="nav-step active"><div class="step-number">1</div><div>Basic Information</div></div>
      <div class="nav-step"><div class="step-number">2</div><div>Teaching Style</div></div>
      <div class="nav-step"><div class="step-number">3</div><div>Choose Template</div></div>
      <div class="nav-step"><div class="step-number">4</div><div>Assessments</div></div>
      <div class="nav-step"><div class="step-number">5</div><div>Build Method</div></div>
      <div class="nav-step"><div class="step-number">6</div><div>Preview & Export</div></div>
      <div class="nav-step"><div class="step-number">7</div><div>Collaborate</div></div>
    </div>
  </aside>

  <main class="main-content">
    <h1 class="page-title">Describe what you want</h1>
    <p class="page-subtitle">We&apos;ll align it to state standards</p>
    <div class="progress-bar"><div class="progress-fill" style="width:12%;"></div></div>

    <div class="form-group">
      <label class="form-label">Grade Level</label>
      <select class="form-select" id="gradeSelect">
        <option>Kindergarten</option>
        <option>1st Grade</option>
        <option>2nd Grade</option>
        <option>3rd Grade</option>
        <option>4th Grade</option>
        <option selected>5th Grade</option>
        <option>6th Grade</option>
        <option>7th Grade</option>
        <option>8th Grade</option>
        <option>9th Grade</option>
        <option>10th Grade</option>
        <option>11th Grade</option>
        <option>12th Grade</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Subject</label>
      <select class="form-select" id="subjectSelect">
        <option selected>Mathematics</option>
        <option>English Language Arts (ELA)</option>
        <option>Science</option>
        <option>Social Studies / History</option>
        <option>Physical Education</option>
        <option>Visual and Performing Arts (Arts)</option>
        <option>Other</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Lesson Topic</label>
      <input type="text" class="form-input" id="topicInput" placeholder="Example: Introduction to fractions">
    </div>

    <div class="form-group">
      <label class="form-label">State</label>
      <select class="form-select" id="stateSelect">
        <option selected>California</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Lesson Duration</label>
      <input type="range" min="15" max="120" value="45" class="slider" id="durationSlider">
      <div class="slider-value" id="durationValue">45 minutes</div>
    </div>

    <div class="optional-section" id="optionalSection">
      <div class="optional-header" id="optionalHeader">
        <div class="optional-title">+ Additional Details (Optional)</div>
        <div class="optional-icon" id="optionalIcon">&#9660;</div>
      </div>
      <div class="optional-content" id="optionalContent">
        <div class="form-group">
          <label class="form-label">Class Size</label>
          <select class="form-select" id="classSizeSelect">
            <option>Small (1-15 students)</option>
            <option selected>Medium (16-25 students)</option>
            <option>Large (26-35 students)</option>
            <option>Very large (36+ students)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">My students include (select all that apply)</label>
          <div style="display:grid;gap:8px;">
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb1"> English Language Learners</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb2"> Students with IEPs</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb3"> Students with 504 plans</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb4"> Gifted/advanced learners</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb5"> Below grade level</label>
            <label style="display:flex;align-items:center;gap:8px;"><input type="checkbox" id="cb6"> Mixed ability classroom</label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Focus on specific standard (optional)</label>
          <input type="text" class="form-input" id="standardInput" placeholder="e.g., 5.NF.A.1">
          <div style="font-size:13px;color:#718096;margin-top:4px;">Leave blank to auto-select best standards</div>
        </div>

        <div class="form-group">
          <label class="form-label">Prior knowledge</label>
          <select class="form-select" id="priorKnowledgeSelect">
            <option>First time seeing this concept</option>
            <option selected>Have some background</option>
            <option>Review/reinforcement</option>
            <option>Advanced/extension</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Additional context</label>
          <textarea class="form-input" id="contextTextarea" rows="4" style="resize:vertical;" placeholder="Special needs, timing, classroom setup, reading materials used, vocabulary to include, etc."></textarea>
        </div>
      </div>
    </div>

    <div class="btn-group">
      <a href="index.html" class="btn btn-secondary">&larr; Back to Home</a>
      <button class="btn btn-primary" onclick="saveAndContinue()">Next: Teaching Style &rarr;</button>
    </div>
  </main>
</div>

<script>
/* ===== LessonBuilders Step 1 (MVP) =====
   - Keeps Inspiration Uploads interactive
   - DOES NOT store file contents (prevents localStorage quota errors)
   - Resets build data only when starting a brand-new build (session-based)
*/
(function(){
  const BUILD_FLAG = "LB_BUILD_ACTIVE";

  // Reset only when starting a new build (not when navigating back from other steps)
  if (!sessionStorage.getItem(BUILD_FLAG)) {
    try {
      localStorage.removeItem("lessonData");
      localStorage.removeItem("verifiedStandards");
    } catch(e){}
    sessionStorage.setItem(BUILD_FLAG, "1");
  }
})();

function safeParse(jsonStr){
  try { return JSON.parse(jsonStr); } catch { return null; }
}

function getLessonData(){
  const saved = localStorage.getItem("lessonData");
  return saved ? (safeParse(saved) || {}) : {};
}
function setLessonData(data){
  localStorage.setItem("lessonData", JSON.stringify(data));
}

/* ---------- Inspiration Uploads (sidebar dropdown) ---------- */
let inspirationFiles = []; // metadata only: {name,type,size}

function setInspirationCountBadge(){
  const badge = document.getElementById("inspCountBadge");
  if (!badge) return;
  badge.textContent = String(inspirationFiles.length);
}

function renderFileList(){
  const list = document.getElementById("fileList");
  if (!list) return;
  if (!inspirationFiles.length){
    list.innerHTML = "";
    setInspirationCountBadge();
    return;
  }
  list.innerHTML = inspirationFiles.map((f, idx) => {
    const sizeKb = Math.round((Number(f.size||0)/1024));
    const label = `${escapeHtml(f.name)} <span style="color:#718096;">(${sizeKb} KB)</span>`;
    return `
      <div class="file-pill" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;">${label}</div>
        <button type="button" class="mini-btn mini-secondary" style="padding:6px 10px;" onclick="removeInspirationFile(${idx})">Remove</button>
      </div>
    `;
  }).join("");
  setInspirationCountBadge();
}

function removeInspirationFile(idx){
  inspirationFiles.splice(idx, 1);
  renderFileList();
  persistInspirationToLessonData();
}

function openFilePicker(){
  const picker = document.getElementById("filePicker");
  if (picker) picker.click();
}

function clearAllInspiration(){
  inspirationFiles = [];
  const notes = document.getElementById("inspirationNotes");
  if (notes) notes.value = "";
  renderFileList();
  persistInspirationToLessonData();
}

function persistInspirationToLessonData(){
  const data = getLessonData();
  data.step1 = data.step1 || {};
  const notes = (document.getElementById("inspirationNotes")?.value || "").trim();
  data.step1.inspiration = {
    notes,
    files: inspirationFiles.map(f => ({ name:f.name, type:f.type, size:f.size })),
    storedLocally: true,
    deleteAfter: "save/export"
  };
  setLessonData(data);
}

function handlePickedFiles(fileList){
  const files = Array.from(fileList || []);
  if (!files.length) return;

  const MAX_FILES = 5;
  const remaining = Math.max(0, MAX_FILES - inspirationFiles.length);
  const toAdd = files.slice(0, remaining);

  for (const f of toAdd){
    inspirationFiles.push({
      name: f.name || "file",
      type: f.type || "",
      size: f.size || 0
    });
  }

  renderFileList();
  persistInspirationToLessonData();
}

function setupInspirationUI(){
  const header = document.getElementById("inspHeader");
  const body = document.getElementById("inspBody");
  const caret = document.getElementById("inspCaret");
  const dropzone = document.getElementById("dropzone");
  const picker = document.getElementById("filePicker");
  const notes = document.getElementById("inspirationNotes");

  if (body) body.classList.remove("show");
  if (caret) caret.classList.remove("expanded");
  if (header) header.setAttribute("aria-expanded", "false");

  const toggle = () => {
    if (!body || !caret || !header) return;
    const isOpen = body.classList.toggle("show");
    caret.classList.toggle("expanded", isOpen);
    header.setAttribute("aria-expanded", isOpen ? "true" : "false");
  };

  if (header){
    header.addEventListener("click", toggle);
    header.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault(); toggle();
      }
    });
  }

  if (dropzone){
    dropzone.addEventListener("click", openFilePicker);

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.style.borderColor = "var(--orange)";
      dropzone.style.background = "rgba(255,140,66,0.08)";
    });
    dropzone.addEventListener("dragleave", () => {
      dropzone.style.borderColor = "rgba(13,40,71,0.18)";
      dropzone.style.background = "rgba(255,255,255,0.7)";
    });
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.style.borderColor = "rgba(13,40,71,0.18)";
      dropzone.style.background = "rgba(255,255,255,0.7)";
      handlePickedFiles(e.dataTransfer?.files);
    });
  }

  if (picker){
    picker.addEventListener("change", (e) => {
      handlePickedFiles(e.target.files);
      picker.value = "";
    });
  }

  if (notes){
    notes.addEventListener("input", () => {
      persistInspirationToLessonData();
    });
  }

  const data = getLessonData();
  const insp = data?.step1?.inspiration || {};
  const savedFiles = Array.isArray(insp.files) ? insp.files : [];
  inspirationFiles = savedFiles.map(f => ({ name:f.name, type:f.type, size:f.size }));
  if (notes && typeof insp.notes === "string") notes.value = insp.notes;
  renderFileList();
}

window.addEventListener('DOMContentLoaded', function() {
  try{
    const apiUrl = localStorage.getItem('API_URL');
    const savedLessons = localStorage.getItem('savedLessons');
    localStorage.removeItem('lessonData');
    localStorage.removeItem('prebuiltLesson');
    localStorage.removeItem('generatedLesson');
    if (apiUrl) localStorage.setItem('API_URL', apiUrl);
    if (savedLessons) localStorage.setItem('savedLessons', savedLessons);
  }catch(e){}

  setupInspirationUI();

  document.getElementById('gradeSelect').value = '5th Grade';
  document.getElementById('subjectSelect').value = 'Mathematics';
  document.getElementById('topicInput').value = '';
  document.getElementById('stateSelect').value = 'California';
  document.getElementById('durationSlider').value = 45;
  document.getElementById('durationValue').textContent = '45 minutes';
});

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function saveAndContinue() {
  const grade = document.getElementById('gradeSelect').value;
  const subject = document.getElementById('subjectSelect').value;
  const topic = document.getElementById('topicInput').value;
  const state = document.getElementById('stateSelect').value;
  const duration = document.getElementById('durationSlider').value;

  const classSize = document.getElementById('classSizeSelect').value;
  const standardFocus = document.getElementById('standardInput').value;
  const priorKnowledge = document.getElementById('priorKnowledgeSelect').value;
  const additionalContext = document.getElementById('contextTextarea').value;

  const studentNeeds = [];
  for (let i = 1; i <= 6; i++) {
    const cb = document.getElementById('cb' + i);
    studentNeeds.push(cb ? cb.checked : false);
  }

  if (!topic.trim()) {
    alert('Please enter a lesson topic');
    return;
  }

  persistInspirationToLessonData();

  const data = getLessonData();
  data.step1 = {
    grade,
    subject,
    topic,
    state,
    duration: parseInt(duration, 10),
    classSize,
    standardFocus,
    priorKnowledge,
    additionalContext,
    studentNeeds,
    inspiration: data?.step1?.inspiration || { notes:"", files:[] }
  };

  setLessonData(data);
  window.location.href = 'build-step2.html';
}

document.getElementById('durationSlider').addEventListener('input', function(){
  document.getElementById('durationValue').textContent = this.value + ' minutes';
});

const header = document.getElementById('optionalHeader');
const content = document.getElementById('optionalContent');
const icon = document.getElementById('optionalIcon');

header.addEventListener('click', function(e){
  e.stopPropagation();
  content.classList.toggle('show');
  icon.classList.toggle('expanded');
});
content.addEventListener('click', function(e){ e.stopPropagation(); });
</script>

<script type="module">
  function initialsFromEmail(email) {
    if (!email) return "LB";
    const namePart = String(email).split("@")[0] || "";
    const tokens = namePart.split(/[.\-_]/).filter(Boolean);
    const a = tokens[0]?.[0] || "";
    const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
    const ini = (a + b).toUpperCase();
    return ini || "LB";
  }

  const el = document.getElementById("userProfile");
  if (!el) return;

  try {
    const raw = localStorage.getItem("lb_user") || localStorage.getItem("user") || "";
    if (raw) {
      const u = JSON.parse(raw);
      const email = u?.email || u?.user?.email;
      el.textContent = initialsFromEmail(email);
    } else {
      el.textContent = "LB";
    }
  } catch {
    el.textContent = "LB";
  }
</script>

</body>
</html>
