// server.js

const express = require("express");
const cors = require("cors");
const AnthropicSDK = require("@anthropic-ai/sdk");
const AnthropicClient = AnthropicSDK?.Anthropic || AnthropicSDK?.default || AnthropicSDK;
require("dotenv").config();

const { findLocalStandards } = require("./standardsStore");

// Node 18+ has global fetch
const fetchFn = global.fetch
  ? global.fetch.bind(global)
  : (...args) => import("node-fetch").then(({ default: fetch }) => fetch(...args));

const app = express();
const PORT = Number(process.env.PORT || 3000);

// -----------------------------------------------------------------------------
// Middleware
// -----------------------------------------------------------------------------
app.use(cors());
app.use(express.json({ limit: "10mb" }));

// -----------------------------------------------------------------------------
// Root
// -----------------------------------------------------------------------------
app.get("/", (req, res) => {
  res.status(200).send("OK");
});

// -----------------------------------------------------------------------------
// Health check
// -----------------------------------------------------------------------------
app.get("/api/health", (req, res) => {
  res.json({
    status: "ok",
    hasAnthropicKey: !!process.env.ANTHROPIC_API_KEY,
    time: new Date().toISOString(),
  });
});

// -----------------------------------------------------------------------------
// Initialize Claude
// -----------------------------------------------------------------------------
const anthropic = new AnthropicClient({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

// -----------------------------------------------------------------------------
// Claude helper
// -----------------------------------------------------------------------------
async function callClaude({
  prompt,
  model = process.env.ANTHROPIC_MODEL || "claude-3-haiku-20240307",
  max_tokens = 3000,
  temperature = 0.3,
}) {
  if (!anthropic?.messages?.create) {
    throw new Error("Anthropic SDK not initialized");
  }

  return anthropic.messages.create({
    model,
    max_tokens,
    temperature,
    messages: [{ role: "user", content: prompt }],
  });
}

// =============================================================================
// STANDARDS VERIFICATION (LOCAL FIRST â€” CORE OF PRODUCT)
// =============================================================================
app.post("/api/verify-standards", async (req, res) => {
  try {
    const body = req.body || {};
    const step1 = body.step1 || body;

    const grade = step1.grade;
    const subject = step1.subject;
    const topic = step1.topic;

    if (!grade || !subject || !topic) {
      return res.status(400).json({
        error: "Missing grade, subject, or topic",
        standards: [],
        verifiedStandards: [],
      });
    }

    // âœ… STEP 1: LOCAL CALIFORNIA STANDARDS (GUARANTEED)
    const local = findLocalStandards({
      grade,
      subject,
      topic,
      limit: 6,
      minReturn: 3,
    });

    if (local.standards.length > 0) {
      return res.json({
        standards: local.standards,
        verifiedStandards: local.standards,
        source: "local-ca",
        totalFound: local.standards.length,
        relevantCount: local.standards.length,
      });
    }

    // âŒ If local ever fails (should not once seeded), we return explicit failure
    return res.json({
      standards: [],
      verifiedStandards: [],
      source: "local-empty",
      message:
        "No local California standards found. Local dataset may be missing this grade/subject.",
      totalFound: 0,
      relevantCount: 0,
    });
  } catch (err) {
    console.error("verify-standards error:", err);
    return res.status(500).json({
      error: "Failed to verify standards",
      message: err.message,
      standards: [],
      verifiedStandards: [],
    });
  }
});

// =============================================================================
// LESSON GENERATION
// =============================================================================
app.post("/api/generate-lesson", async (req, res) => {
  try {
    const lessonData = req.body;

    if (!lessonData?.step1?.topic) {
      return res.status(400).json({ error: "Missing lesson topic" });
    }

    const prompt = buildLessonPrompt(lessonData);
    const response = await callClaude({ prompt });

    return res.json(response);
  } catch (err) {
    console.error("generate-lesson error:", err);
    return res.status(500).json({
      error: "Failed to generate lesson",
      message: err.message,
    });
  }
});

// =============================================================================
// PROMPT BUILDER
// =============================================================================
function buildLessonPrompt(lessonData) {
  const { step1, step2, step3, step5 } = lessonData;
  const standards = lessonData.verifiedStandards || [];

  return `Create a California standards-aligned lesson.

TOPIC: ${step1.topic}
GRADE: ${step1.grade}
SUBJECT: ${step1.subject}
DURATION: ${step1.duration} minutes

VERIFIED STANDARDS:
${standards.map((s) => `- ${s.code}: ${s.text}`).join("\n")}

REQUIREMENTS:
- Summary
- Objectives
- Materials
- Procedures with timing
- Assessments

Return ONLY valid JSON.`;
}

// =============================================================================
// START SERVER
// =============================================================================
app.listen(PORT, "0.0.0.0", () => {
  console.log("ğŸš€ LessonBuilders backend running on port", PORT);
});
