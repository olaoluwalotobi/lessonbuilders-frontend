<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Preview & Export - LessonBuilders</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--navy:#0D2847;--orange:#FF8C42;--green:#10B981;--yellow:#F59E0B;--red:#EF4444;--blue:#3B82F6;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#F7FAFC 0%,#FFF 100%);color:#0D2847;}
.top-nav{background:white;border-bottom:1px solid rgba(13,40,71,0.12);padding:14px 32px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.nav-left{display:flex;align-items:center;gap:34px;}
.logo-text{font-family:'Crimson Pro',serif;font-size:22px;font-weight:700;color:var(--navy);text-decoration:none;}
.nav-menu{display:flex;gap:26px;align-items:center;}
.nav-link{text-decoration:none;color:#4A5568;font-weight:500;font-size:14px;transition:color 0.2s;}
.nav-link:hover{color:var(--navy);}
.nav-right{display:flex;align-items:center;gap:16px;}
.user-profile{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--orange),#FFB380);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:13px;cursor:pointer;}

.container{display:flex;max-width:1400px;margin:0 auto;}
.sidebar{width:270px;background:white;border-right:1px solid rgba(13,40,71,0.1);padding:24px 18px;}
.nav-step{display:flex;align-items:center;gap:12px;padding:10px;margin-bottom:6px;cursor:pointer;transition:all 0.2s;border-left:3px solid transparent;text-decoration:none;color:#4A5568;border-radius:8px;}
.nav-step.active{background:rgba(255,140,66,0.10);border-left-color:var(--orange);color:var(--navy);font-weight:600;}
.nav-step.completed{color:#10B981;}
.step-number{width:26px;height:26px;border-radius:50%;background:#F7FAFC;border:2px solid #E2E8F0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#999;}
.nav-step.active .step-number{background:var(--orange);border-color:var(--orange);color:white;}
.nav-step.completed .step-number{background:#10B981;border-color:#10B981;color:white;}

.main-content{flex:1;padding:28px 44px;max-width:980px;}
.page-title{font-family:'Crimson Pro',serif;font-size:34px;font-weight:700;margin-bottom:6px;color:var(--navy);}
.page-subtitle{font-size:15px;color:#4A5568;margin-bottom:18px;}
.progress-bar{height:6px;background:#E2E8F0;border-radius:3px;margin-bottom:18px;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--orange),#FFB380);border-radius:3px;}

/* Standards Verification Banner */
.verification-banner{background:rgba(16,185,129,0.05);border:2px solid rgba(16,185,129,0.18);border-radius:12px;padding:14px 16px;margin-bottom:16px;}
.banner-header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
.banner-left{display:flex;align-items:center;gap:10px;}
.banner-icon{font-size:18px;color:var(--green);display:flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:50%;background:rgba(16,185,129,0.12);}
.banner-text{font-weight:700;color:var(--navy);font-size:15px;}
.banner-meta{font-size:12px;color:#718096;margin-left:40px;margin-top:3px;}
.view-details-btn{background:white;border:2px solid rgba(16,185,129,0.25);color:var(--green);padding:7px 12px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
.view-details-btn:hover{background:rgba(16,185,129,0.05);border-color:var(--green);transform:translateY(-1px);}
.details-icon{font-size:11px;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);}
.details-icon.expanded{transform:rotate(180deg);}

.details-section{max-height:0;overflow:hidden;transition:max-height 0.5s cubic-bezier(0.4,0,0.2,1);}
.details-section.show{max-height:1400px;padding-top:14px;}

.legend-bar{background:white;border:2px solid rgba(59,130,246,0.18);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;justify-content:center;align-items:center;gap:18px;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:8px;font-size:12px;color:#4A5568;font-weight:600;}

.standard-card{background:white;border:2px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:10px;}
.standard-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;}
.standard-number{font-weight:800;color:var(--orange);font-size:14px;background:rgba(255,140,66,0.10);padding:3px 10px;border-radius:6px;}
.standard-text{color:#4A5568;line-height:1.55;margin-bottom:10px;font-size:13px;}
.standard-meta{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;padding-top:10px;border-top:1px solid #E2E8F0;}
.confidence-badge{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:800;display:inline-flex;align-items:center;gap:4px;}
.confidence-badge.high{background:rgba(16,185,129,0.10);color:#059669;}
.confidence-badge.medium{background:rgba(245,158,11,0.10);color:#B45309;}
.confidence-badge.low{background:rgba(239,68,68,0.10);color:#B91C1C;}
.source-link{color:var(--blue);text-decoration:none;font-size:12px;font-weight:800;transition:all 0.2s;display:inline-flex;align-items:center;gap:4px;}
.source-link:hover{color:var(--orange);}

.details-footer{margin-top:12px;padding-top:12px;border-top:1px solid #E2E8F0;display:flex;justify-content:center;gap:14px;flex-wrap:wrap;}
.btn-text{background:none;border:none;color:#718096;font-size:12px;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;font-weight:700;padding:6px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;}
.btn-text:hover{color:var(--orange);background:rgba(255,140,66,0.05);}

/* Lesson Preview (tight + teacher friendly) */
.lesson-preview{background:white;border:2px solid #E2E8F0;border-radius:14px;padding:22px;margin-bottom:14px;}
.lesson-title{font-size:26px;font-weight:800;color:var(--navy);margin-bottom:10px;text-align:center;}
.lesson-meta{text-align:center;color:#4A5568;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #E2E8F0;font-size:13px;line-height:1.4;}
.lesson-summary{text-align:left;color:#4A5568;font-size:14px;line-height:1.45;margin:12px 0 12px 0;}
.lesson-section{margin-bottom:14px;}
.lesson-section h3{font-size:18px;font-weight:900;color:var(--navy);margin-bottom:6px;}
.lesson-section p{color:#4A5568;line-height:1.42;margin-bottom:6px;font-size:13.5px;}
.lesson-section ul{margin-left:18px;color:#4A5568;line-height:1.42;font-size:13.5px;}
.lesson-section li{margin-bottom:5px;}

.rule-line{height:1px;background:#E2E8F0;margin:10px 0;}

/* Buttons */
.btn{padding:12px 18px;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;transition:all 0.3s;text-decoration:none;display:inline-block;border:none;}
.btn-primary{background:linear-gradient(135deg,var(--orange),#FFB380);color:white;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,140,66,0.35);}
.btn-secondary{background:white;border:2px solid #E2E8F0;color:var(--navy);}
.btn-secondary:hover{border-color:var(--orange);}
.btn-group{display:flex;gap:12px;margin-top:0;flex-wrap:wrap;align-items:center;}

.export-wrap{position:relative;display:inline-block;}
.export-menu{
  position:absolute; top:48px; left:0;
  background:white; border:2px solid #E2E8F0; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.10);
  min-width:260px;
  padding:10px;
  z-index:1500;
  display:none;
}
.export-menu.show{display:block;}
.export-item{
  width:100%;
  text-align:left;
  padding:10px 10px;
  border-radius:10px;
  border:none;
  background:white;
  cursor:pointer;
  font-family:'DM Sans',sans-serif;
  color:var(--navy);
  font-size:13px;
  font-weight:900;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.export-item:hover{background:rgba(255,140,66,0.08);}
.export-sub{font-size:12px;color:#718096;font-weight:700;margin-top:2px;}
.export-sep{height:1px;background:#E2E8F0;margin:8px 0;}

/* Feedback */
.feedback-box{background:white;border:2px solid #E2E8F0;border-radius:14px;padding:18px;margin-top:14px;margin-bottom:14px;}
.feedback-title{font-size:16px;font-weight:900;color:var(--navy);margin-bottom:6px;}
.feedback-subtitle{font-size:12px;color:#718096;margin-bottom:12px;}
.feedback-textarea{width:100%;padding:12px;border:2px solid #E2E8F0;border-radius:10px;font-size:14px;font-family:'DM Sans',sans-serif;transition:all 0.2s;resize:vertical;min-height:110px;}
.feedback-textarea:focus{outline:none;border-color:var(--orange);}
.feedback-button{width:100%;margin-top:12px;}

/* Errors (no silent fallback) */
.hard-error{
  background:rgba(239,68,68,0.06);
  border:2px solid rgba(239,68,68,0.25);
  border-radius:14px;
  padding:16px;
  margin:14px 0;
}
.hard-error h4{font-size:14px;font-weight:900;color:#991B1B;margin-bottom:6px;}
.hard-error p{font-size:13px;color:#7F1D1D;line-height:1.4;margin-bottom:10px;}
.hard-error ul{margin-left:18px;color:#7F1D1D;font-size:13px;line-height:1.4;}
.hard-error .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
.loading-overlay.hidden{display:none;}
.blocks-loader{position:relative;width:73px;height:66px;margin-bottom:18px;}
.block{position:absolute;border-radius:6px;opacity:0;animation-duration:2.6s;animation-timing-function:cubic-bezier(.2,.9,.2,1);animation-iteration-count:infinite;will-change:transform, opacity;}
.bl{width:48px;height:20px;left:0;bottom:0;background:var(--navy);animation-name:bl-in;}
.tl{width:22px;height:20px;left:26px;bottom:24px;background:var(--navy);animation-name:tl-in;}
.br{width:22px;height:44px;left:51px;bottom:0;background:var(--navy);animation-name:br-in;}
.tr{width:22px;height:20px;left:51px;top:0;background:var(--orange);animation-name:tr-in;}
@keyframes bl-in{0%{opacity:0;transform:translateX(16px);}12%{opacity:1;transform:translateX(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes br-in{0%,14%{opacity:0;transform:translateY(16px);}26%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes tl-in{0%,28%{opacity:0;transform:translateX(-16px);}40%{opacity:1;transform:translateX(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes tr-in{0%,42%{opacity:0;transform:translateY(-18px) scale(.96);}54%{opacity:1;transform:translateY(0) scale(1.06);}66%{transform:translateY(0) scale(1);}80%{opacity:1;}100%{opacity:0;}}
.loading-message{font-size:14px;color:var(--navy);font-weight:800;text-align:center;min-height:24px;padding:0 16px;}

@media print{
  body * {visibility: hidden;}
  .lesson-preview, .lesson-preview * {visibility: visible;}
  .lesson-preview {position:absolute;left:0;top:0;width:100%;border:none;box-shadow:none;padding:0;margin:0;}
  .top-nav,.sidebar,.btn-group,.verification-banner,.page-title,.page-subtitle,.progress-bar,.feedback-box,#loadingOverlay,.hard-error{display:none !important;}
  .export-menu{display:none !important;}
}
</style>
</head>
<body>
<nav class="top-nav">
  <div class="nav-left">
    <a href="index.html" class="logo-text">LessonBuilders</a>
    <div class="nav-menu">
      <a href="library.html" class="nav-link">My Lessons</a>
      <a href="discover.html" class="nav-link">Discover</a>
      <a href="about.html" class="nav-link">Help</a>
    </div>
  </div>
  <div class="nav-right">
    <div class="user-profile">JD</div>
  </div>
</nav>

<div class="container">
  <aside class="sidebar">
    <div style="font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:0.5px;color:#999;margin-bottom:12px;">BUILD LESSON</div>
    <a href="build-step1.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Basic Information</div></a>
    <a href="build-step2.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Teaching Style</div></a>
    <a href="build-step3.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Choose Template</div></a>
    <a href="build-step4.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Build Method</div></a>
    <a href="build-step5.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Assessments</div></a>
    <a href="build-step6.html" class="nav-step active"><div class="step-number">6</div><div>Preview & Export</div></a>
    <a href="build-step7.html" class="nav-step"><div class="step-number">7</div><div>Collaborate</div></a>
  </aside>

  <main class="main-content">
    <h1 class="page-title">Preview & Export</h1>
    <p class="page-subtitle">Review, export, or save</p>
    <div class="progress-bar"><div class="progress-fill" style="width:86%;"></div></div>

    <!-- Standards Verification Banner -->
    <div class="verification-banner" id="verificationBanner">
      <div class="banner-header">
        <div class="banner-left">
          <div class="banner-icon">‚úì</div>
          <div>
            <div class="banner-text" id="bannerText">Verifying California Standards...</div>
            <div class="banner-meta" id="bannerMeta">This will take 5-15 seconds</div>
          </div>
        </div>
        <button class="view-details-btn" id="viewDetailsBtn" onclick="toggleDetails()" style="display:none;">
          View Details
          <span class="details-icon" id="detailsIcon">‚ñº</span>
        </button>
      </div>

      <div class="details-section" id="detailsSection">
        <div class="legend-bar">
          <div class="legend-item"><span class="confidence-badge high">High ‚úì‚úì</span><span>Exact match</span></div>
          <div class="legend-item"><span class="confidence-badge medium">Medium ‚úì</span><span>Paraphrased</span></div>
          <div class="legend-item"><span class="confidence-badge low">Manual ‚ö†Ô∏è</span><span>Check</span></div>
        </div>

        <div id="standardsContainer"></div>

        <div class="details-footer">
          <button class="btn-text" onclick="reportError()">‚ö†Ô∏è Report an Error</button>
          <button class="btn-text" onclick="reverifyStandards()">üîÑ Re-verify</button>
        </div>
      </div>
    </div>

    <!-- Hard error area (no silent fallbacks) -->
    <div id="hardError" class="hard-error" style="display:none;"></div>

    <!-- Lesson -->
    <div class="lesson-preview" id="lessonPreview">
      <div class="lesson-title" id="lessonTitle">Loading...</div>
      <div class="lesson-meta" id="lessonMeta"></div>
      <div class="lesson-summary" id="lessonSummary"></div>
      <div id="lessonContent"></div>
    </div>

    <!-- Feedback -->
    <div class="feedback-box" id="feedbackBox" style="display:none;">
      <div class="feedback-title">Want changes? Describe what to adjust.</div>
      <div class="feedback-subtitle">Example: ‚ÄúMake the hook more engaging‚Äù or ‚ÄúDifferentiate for EL students.‚Äù</div>
      <textarea class="feedback-textarea" id="feedbackTextarea" placeholder="Describe your changes here..."></textarea>
      <button class="btn btn-primary feedback-button" id="updateLessonBtn" onclick="regenerateLesson()">Update Lesson</button>
    </div>

    <!-- Actions -->
    <div class="btn-group">
      <button class="btn btn-secondary" id="printBtn" onclick="window.print()">üñ® Print</button>

      <div class="export-wrap">
        <button class="btn btn-secondary" id="exportBtn" onclick="toggleExportMenu(event)">‚¨á Export</button>
        <div class="export-menu" id="exportMenu" role="menu" aria-label="Export options">
          <button class="export-item" onclick="exportPDF()">
            <div>PDF<div class="export-sub">Uses Print ‚Üí Save as PDF</div></div><span>‚Üí</span>
          </button>
          <div class="export-sep"></div>
          <button class="export-item" onclick="exportDOC()">
            <div>DOC<div class="export-sub">Downloads .doc (HTML-based)</div></div><span>‚Üí</span>
          </button>
        </div>
      </div>

      <button class="btn btn-primary" onclick="saveToLibrary()">Save to Library</button>
    </div>
  </main>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay hidden" id="loadingOverlay" role="status" aria-live="polite">
  <div class="blocks-loader" aria-hidden="true">
    <div class="block bl"></div>
    <div class="block tl"></div>
    <div class="block br"></div>
    <div class="block tr"></div>
  </div>
  <div class="loading-message" id="loadingMessage">Building a great lesson, one block at a time</div>
</div>

<script>
/**
 * Step 6 (strict):
 * - Standards show in banner AND inside lesson document + print (no source links in document)
 * - Claude MUST provide: keyVocabulary, udlConnections, assessmentSummary
 * - If missing, Step 6 does NOT fallback. It shows a hard error and retries once.
 * - Update Lesson always sends feedback and triggers regeneration.
 */
const API_URL = (localStorage.getItem('API_URL') || "https://lessonbuilders-backend-production.up.railway.app").replace(/\/$/, "");

const messages = [
  "Building a great lesson, one block at a time",
  "Verifying California standards‚Ä¶",
  "Aligning to learning standards‚Ä¶",
  "Designing engaging activities‚Ä¶",
  "Finalizing your lesson plan‚Ä¶"
];
let msgIndex = 0;
let msgTimer;

function showLoading(){
  const overlay = document.getElementById("loadingOverlay");
  const msgEl = document.getElementById("loadingMessage");
  overlay.classList.remove("hidden");
  msgEl.textContent = messages[0];
  msgIndex = 0;
  clearInterval(msgTimer);
  msgTimer = setInterval(() => {
    msgIndex = (msgIndex + 1) % messages.length;
    msgEl.textContent = messages[msgIndex];
  }, 2200);
}
function hideLoading(){
  document.getElementById("loadingOverlay").classList.add("hidden");
  clearInterval(msgTimer);
}

let lessonData = {};
let verifiedStandards = [];
let lastLessonJSON = null;

// Framework labels (explicit ‚ÄúStep 1: Hook‚Äù, etc.)
const frameworkNames = {
  'madeline-hunter': 'Madeline Hunter',
  '5e-model': '5E Model',
  'ubd': 'Understanding by Design',
  'gradual-release': 'Gradual Release'
};
const frameworkStepLabels = {
  "madeline-hunter": [
    "Hook / Anticipatory Set",
    "Objective & Purpose",
    "Direct Instruction (Input/Modeling)",
    "Guided Practice",
    "Check for Understanding",
    "Independent Practice",
    "Closure"
  ],
  "5e-model": ["Engage","Explore","Explain","Elaborate","Evaluate"],
  "ubd": [
    "Essential Question / Big Idea",
    "Learning Goals & Success Criteria",
    "Learning Plan (Activities)",
    "Formative Checks",
    "Closure / Reflection"
  ],
  "gradual-release": [
    "I Do (Model)",
    "We Do (Guided)",
    "You Do Together (Collaborative)",
    "You Do Alone (Independent)",
    "Closure"
  ]
};

// Export menu close on outside click / escape
document.addEventListener('click', (e) => {
  const menu = document.getElementById('exportMenu');
  const btn = document.getElementById('exportBtn');
  if (!menu.classList.contains('show')) return;
  if (menu.contains(e.target) || btn.contains(e.target)) return;
  menu.classList.remove('show');
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') document.getElementById('exportMenu').classList.remove('show');
});

window.addEventListener('DOMContentLoaded', function() {
  const saved = localStorage.getItem('lessonData');
  if (!saved) {
    document.getElementById('lessonTitle').textContent = "Missing lesson data";
    document.getElementById('lessonSummary').textContent = "Go back to Step 1 to start building a lesson.";
    return;
  }

  lessonData = JSON.parse(saved);
  verifiedStandards = Array.isArray(lessonData.verifiedStandards) ? lessonData.verifiedStandards : [];

  generateLesson({ feedback: null, strictRetry: false });
});

function toggleExportMenu(evt){
  evt.preventDefault();
  document.getElementById('exportMenu').classList.toggle('show');
}
function exportPDF(){
  document.getElementById('exportMenu').classList.remove('show');
  window.print();
}
function exportDOC(){
  document.getElementById('exportMenu').classList.remove('show');

  const title = (lastLessonJSON?.title || lessonData?.step1?.topic || "Lesson").toString();
  const safeName = title.replace(/[^\w\-]+/g, "_").slice(0, 80) || "Lesson";
  const preview = document.getElementById('lessonPreview');
  const html = preview.outerHTML;

  const doc =
`<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:Arial, sans-serif; color:#0D2847;}
  .lesson-preview{border:none; padding:0; margin:0;}
</style>
</head>
<body>${html}</body>
</html>`;

  const blob = new Blob([doc], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${safeName}.doc`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function toggleDetails() {
  const section = document.getElementById('detailsSection');
  const icon = document.getElementById('detailsIcon');
  const btn = document.getElementById('viewDetailsBtn');

  section.classList.toggle('show');
  icon.classList.toggle('expanded');

  if (section.classList.contains('show')) {
    btn.innerHTML = 'Hide Details <span class="details-icon expanded" id="detailsIcon">‚ñº</span>';
  } else {
    btn.innerHTML = 'View Details <span class="details-icon" id="detailsIcon">‚ñº</span>';
  }
}

function setBannerVerifying() {
  document.getElementById('bannerText').textContent = "Verifying California Standards...";
  document.getElementById('bannerMeta').textContent = "This will take 5-15 seconds";
  document.getElementById('viewDetailsBtn').style.display = "none";
  document.getElementById('standardsContainer').innerHTML = "";
  document.getElementById('detailsSection').classList.remove('show');
}
function setBannerFallback(message) {
  document.getElementById('bannerText').textContent = "Standards verification unavailable";
  document.getElementById('bannerMeta').textContent = message || "Continuing without verified standards.";
  document.getElementById('viewDetailsBtn').style.display = "none";
  document.getElementById('standardsContainer').innerHTML = "";
  document.getElementById('detailsSection').classList.remove('show');
}

async function safeJson(res) {
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { _raw: text }; }
}

function normalizeLessonFromBackend(payload) {
  if (!payload) return null;
  if (payload.error) throw new Error(payload.error);

  // If backend returns Anthropic format
  if (payload.content && Array.isArray(payload.content) && payload.content[0] && typeof payload.content[0].text === "string") {
    const t = payload.content[0].text.trim();
    const match = t.match(/\{[\s\S]*\}/);
    if (!match) throw new Error("Could not parse lesson JSON from AI response.");
    return JSON.parse(match[0]);
  }

  // If backend returns lesson JSON directly
  if (payload.summary && payload.objectives && payload.procedures) return payload;

  if (payload._raw && typeof payload._raw === "string") {
    const match = payload._raw.match(/\{[\s\S]*\}/);
    if (!match) throw new Error("Could not parse lesson JSON from server response.");
    return JSON.parse(match[0]);
  }

  throw new Error("Unexpected response format from backend.");
}

/**
 * STRICT: Required core fields.
 * No placeholders. No defaults. If missing => hard error + retry once.
 */
function validateRequiredLessonFields(lesson){
  const missing = [];

  const vocab = lesson?.keyVocabulary;
  if (!Array.isArray(vocab) || vocab.length < 6 || !vocab.every(v => typeof v === "string" && v.trim().length)) {
    missing.push("keyVocabulary (array of 6+ topic-specific terms)");
  }

  const udl = lesson?.udlConnections;
  if (!udl || typeof udl !== "object") {
    missing.push("udlConnections (object with engagement, representation, actionExpression)");
  } else {
    if (typeof udl.engagement !== "string" || !udl.engagement.trim()) missing.push("udlConnections.engagement");
    if (typeof udl.representation !== "string" || !udl.representation.trim()) missing.push("udlConnections.representation");
    if (typeof udl.actionExpression !== "string" || !udl.actionExpression.trim()) missing.push("udlConnections.actionExpression");
  }

  if (typeof lesson?.assessmentSummary !== "string" || !lesson.assessmentSummary.trim()) {
    missing.push("assessmentSummary (a paragraph describing how learning is assessed)");
  }

  return missing;
}

function showHardError(title, message, items, actionsHtml){
  const box = document.getElementById('hardError');
  const list = (items && items.length)
    ? `<ul>${items.map(i => `<li>${escapeHtml(i)}</li>`).join('')}</ul>`
    : "";

  box.innerHTML = `
    <h4>${escapeHtml(title)}</h4>
    <p>${escapeHtml(message)}</p>
    ${list}
    ${actionsHtml || ""}
  `;
  box.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function clearHardError(){
  const box = document.getElementById('hardError');
  box.style.display = 'none';
  box.innerHTML = '';
}

function persistVerifiedStandards(standardsArr) {
  try {
    if (!lessonData || typeof lessonData !== "object") lessonData = {};
    lessonData.verifiedStandards = Array.isArray(standardsArr) ? standardsArr : [];
    localStorage.setItem("lessonData", JSON.stringify(lessonData));
  } catch (e) {
    console.warn("Could not persist verifiedStandards:", e);
  }
}

function getStandardsForDocument() {
  const a = Array.isArray(lastLessonJSON?.verifiedStandards) ? lastLessonJSON.verifiedStandards : null;
  const b = Array.isArray(lastLessonJSON?.standards) ? lastLessonJSON.standards : null;
  const c = Array.isArray(verifiedStandards) ? verifiedStandards : null;
  const d = Array.isArray(lessonData?.verifiedStandards) ? lessonData.verifiedStandards : null;
  const picked = (a && a.length ? a : (b && b.length ? b : (c && c.length ? c : (d && d.length ? d : []))));
  return Array.isArray(picked) ? picked : [];
}

// Document standards renderer (NO links, NO ‚ÄúVerified‚Äù label)
function renderStandardsSectionForDocument(standardsArr) {
  if (!Array.isArray(standardsArr) || !standardsArr.length) return "";
  const items = standardsArr.map(std => {
    const code = escapeHtml((std.code || std.standardCode || std.id || "").toString());
    const text = escapeHtml((std.text || std.description || "").toString());
    return `
      <li>
        ${code ? `<strong style="color:var(--navy);">${code}</strong><br>` : ""}
        <span>${text}</span>
      </li>
    `;
  }).join("");
  return `
    <div class="lesson-section">
      <h3>California Standards</h3>
      <ul>${items}</ul>
    </div>
  `;
}

async function generateLesson({ feedback, strictRetry }) {
  clearHardError();

  const step1 = lessonData.step1 || {};
  const step2 = lessonData.step2 || {};
  const step3 = lessonData.step3 || {};
  const step5 = lessonData.step5 || {};

  const topic = step1.topic || 'Untitled Lesson';
  const grade = step1.grade || '5th Grade';
  const subject = step1.subject || 'Mathematics';
  const duration = step1.duration || 45;
  const framework = step3.framework || 'madeline-hunter';

  document.getElementById('lessonTitle').textContent = topic;
  document.getElementById('lessonMeta').innerHTML = `
    <div><strong>Grade:</strong> ${escapeHtml(grade)} &nbsp;|&nbsp; <strong>Subject:</strong> ${escapeHtml(subject)} &nbsp;|&nbsp; <strong>Duration:</strong> ${escapeHtml(String(duration))} min</div>
    <div><strong>Framework:</strong> ${escapeHtml(frameworkNames[framework] || framework)}</div>
  `;

  setBannerVerifying();
  showLoading();

  // 1) Verify standards (best-effort ‚Äî lesson still generates even if this fails)
  let standards = [];
  try {
    const verifyRes = await fetch(`${API_URL}/api/verify-standards`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ grade, subject, topic })
    });
    const verifyData = await safeJson(verifyRes);
    if (verifyRes.ok && verifyData && Array.isArray(verifyData.standards)) {
      standards = verifyData.standards;
      verifiedStandards = standards;
      persistVerifiedStandards(verifiedStandards);
      updateVerificationBanner(standards, verifyData.source);
    } else {
      setBannerFallback(verifyData?.message || "Continuing without verified standards.");
    }
  } catch (e) {
    setBannerFallback("Continuing without verified standards.");
  }

  // 2) Generate lesson
  const payload = {
    step1: { topic, grade, subject, duration },
    step2: step2 || { handsOn: 0, direct: 0, collaborative: 0, independent: 0, technology: 0 },
    step3: { framework },
    step5: step5 || {},
    verifiedStandards: standards && standards.length ? standards : (Array.isArray(verifiedStandards) ? verifiedStandards : [])
  };

  // feedback MUST flow to backend
  if (feedback && typeof feedback === "string" && feedback.trim()) {
    payload.feedback = feedback.trim();
  }

  // strict retry hint (works only if backend passes feedback into Claude prompt)
  if (strictRetry) {
    payload.feedback = (payload.feedback ? payload.feedback + "\n\n" : "") +
      "CRITICAL: Output MUST include: keyVocabulary (6-12 terms), udlConnections {engagement,representation,actionExpression}, and assessmentSummary. Do not omit these fields.";
  }

  try {
    const genRes = await fetch(`${API_URL}/api/generate-lesson`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const genData = await safeJson(genRes);
    if (!genRes.ok) throw new Error(genData?.error || genData?.details || "Lesson generation failed.");

    const lesson = normalizeLessonFromBackend(genData);

    // Keep last lesson + standards for document
    lastLessonJSON = lesson;
    lastLessonJSON.verifiedStandards = Array.isArray(payload.verifiedStandards) ? payload.verifiedStandards : [];

    // STRICT validation (no fallback)
    const missing = validateRequiredLessonFields(lesson);

    // If missing and we haven't retried yet: retry ONCE automatically
    if (missing.length && !strictRetry) {
      hideLoading();
      showHardError(
        "Claude returned an incomplete lesson",
        "LessonBuilders requires UDL, Vocabulary, and Assessment Summary for every lesson. Retrying once with stricter instructions‚Ä¶",
        missing,
        `<div class="row">
           <button class="btn btn-secondary" onclick="retryStrict()">Retry Now</button>
         </div>`
      );
      return;
    }

    // If still missing after strict retry: hard stop (visible)
    if (missing.length && strictRetry) {
      hideLoading();
      showHardError(
        "Lesson generation failed validation",
        "The backend/Claude response is missing required fields. This must be fixed in the backend prompt/schema. Step 6 will not show placeholders for core product fields.",
        missing,
        `<div class="row">
           <button class="btn btn-secondary" onclick="retryStrict()">Retry Again</button>
           <button class="btn btn-primary" onclick="copyDebug()">Copy Debug</button>
         </div>`
      );
      return;
    }

    hideLoading();
    displayLessonStrict(lesson, framework);
    document.getElementById('feedbackBox').style.display = 'block';

  } catch (err) {
    hideLoading();
    showHardError(
      "Lesson generation error",
      err?.message || "Unknown error.",
      [],
      `<div class="row">
         <button class="btn btn-secondary" onclick="retryStrict()">Retry</button>
       </div>`
    );
  }
}

function retryStrict(){
  const feedback = document.getElementById('feedbackTextarea')?.value || null;
  generateLesson({ feedback, strictRetry: true });
}

function copyDebug(){
  try{
    const payload = {
      lessonData,
      verifiedStandards,
      lastLessonJSON
    };
    navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    alert("Debug copied to clipboard.");
  }catch(e){
    alert("Could not copy debug.");
  }
}

function displayLessonStrict(lesson, framework) {
  clearHardError();

  document.getElementById('lessonSummary').textContent = lesson.summary || "";

  // Standards
  const standardsHTML = renderStandardsSectionForDocument(getStandardsForDocument());

  // Required core sections (no fallbacks)
  const vocab = lesson.keyVocabulary;
  const udl = lesson.udlConnections;
  const assessmentSummary = lesson.assessmentSummary;

  const vocabHTML = `
    <div class="lesson-section">
      <h3>Key Vocabulary</h3>
      <ul>${vocab.map(v => `<li>${escapeHtml(v)}</li>`).join('')}</ul>
    </div>
  `;

  const udlHTML = `
    <div class="lesson-section">
      <h3>UDL Connections</h3>
      <p><strong>Engagement:</strong> ${escapeHtml(udl.engagement)}</p>
      <p><strong>Representation:</strong> ${escapeHtml(udl.representation)}</p>
      <p><strong>Action & Expression:</strong> ${escapeHtml(udl.actionExpression)}</p>
    </div>
  `;

  const objectives = Array.isArray(lesson.objectives) ? lesson.objectives : [];
  const materials = Array.isArray(lesson.materials) ? lesson.materials : [];
  const procedures = Array.isArray(lesson.procedures) ? lesson.procedures : [];

  const labels = frameworkStepLabels[framework] || [];

  const proceduresHTML = procedures.map((step, index) => {
    const label = labels[index] ? labels[index] : (step.name || `Step ${index+1}`);
    return `<p><strong>Step ${index + 1}: ${escapeHtml(label)} (${escapeHtml(String(step.time ?? ""))} min):</strong> ${escapeHtml(step.description || "")}</p>`;
  }).join('');

  const assessmentHTML = `
    <div class="lesson-section">
      <h3>Assessment Summary</h3>
      <p>${escapeHtml(assessmentSummary)}</p>
    </div>
  `;

  const content = `
    ${standardsHTML}
    ${udlHTML}
    ${vocabHTML}

    <div class="lesson-section">
      <h3>Learning Objectives</h3>
      <ul>${objectives.map(obj => `<li>${escapeHtml(obj)}</li>`).join('')}</ul>
    </div>

    <div class="lesson-section">
      <h3>Materials Needed</h3>
      <ul>${materials.map(mat => `<li>${escapeHtml(mat)}</li>`).join('')}</ul>
    </div>

    <div class="lesson-section">
      <h3>Procedures</h3>
      ${proceduresHTML}
    </div>

    ${assessmentHTML}
  `;

  document.getElementById('lessonContent').innerHTML = content;
}

function regenerateLesson() {
  const feedback = document.getElementById('feedbackTextarea').value.trim();
  if (!feedback) {
    alert('Please describe what changes you want to make.');
    return;
  }
  showLoading();
  generateLesson({ feedback, strictRetry: false });
}

function updateVerificationBanner(standards, source) {
  const bannerText = document.getElementById('bannerText');
  const bannerMeta = document.getElementById('bannerMeta');
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  const standardsContainer = document.getElementById('standardsContainer');

  const count = standards.length;
  const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  bannerText.textContent = `${count} California Standard${count !== 1 ? 's' : ''} Verified`;
  bannerMeta.textContent = `Verified on ${today}${source ? ` (${source})` : ""}`;
  viewDetailsBtn.style.display = 'inline-flex';

  standardsContainer.innerHTML = standards.map(std => {
    const confidenceClass = (std.confidence || 'medium').toLowerCase();
    const confidenceLabels = { high: 'High ‚úì‚úì', medium: 'Medium ‚úì', low: 'Manual ‚ö†Ô∏è' };
    const link = std.sourceURL || std.sourceUrl || "https://www.cde.ca.gov/";
    const safeCode = (std.code || "").toString();
    const safeText = (std.text || "").toString();

    return `
      <div class="standard-card">
        <div class="standard-header"><div class="standard-number">${escapeHtml(safeCode)}</div></div>
        <div class="standard-text">${escapeHtml(safeText)}</div>
        <div class="standard-meta">
          <span class="confidence-badge ${confidenceClass}">${confidenceLabels[confidenceClass] || confidenceLabels.medium}</span>
          <a href="${link}" target="_blank" rel="noopener noreferrer" class="source-link">View Source</a>
        </div>
      </div>
    `;
  }).join('');
}

function reverifyStandards() {
  // Keep this best-effort. Regeneration uses the latest stored verifiedStandards.
  generateLesson({ feedback: null, strictRetry: false });
}

function reportError() {
  alert('Error reporting: Teachers can describe which standard appears incorrect. This feedback improves verification.');
}

function saveToLibrary() {
  const saved = localStorage.getItem('lessonData');
  if (!saved) return;

  const data = JSON.parse(saved);
  const lesson = {
    id: Date.now(),
    title: data.step1?.topic || 'Untitled Lesson',
    grade: data.step1?.grade || '5th Grade',
    subject: data.step1?.subject || 'Mathematics',
    duration: data.step1?.duration || 45,
    framework: data.step3?.framework || 'madeline-hunter',
    verifiedStandards: Array.isArray(data.verifiedStandards) ? data.verifiedStandards : verifiedStandards,
    savedAt: new Date().toISOString(),
    generatedLesson: lastLessonJSON || null,
    fullLesson: data
  };

  let savedLessons = [];
  const existing = localStorage.getItem('savedLessons');
  if (existing) savedLessons = JSON.parse(existing);

  savedLessons.push(lesson);
  localStorage.setItem('savedLessons', JSON.stringify(savedLessons));

  alert('Lesson saved to My Lessons!');
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>
