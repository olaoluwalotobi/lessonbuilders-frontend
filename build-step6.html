<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Preview & Export - LessonBuilders</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--navy:#0D2847;--orange:#FF8C42;--green:#10B981;--yellow:#F59E0B;--red:#EF4444;--blue:#3B82F6;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#F7FAFC 0%,#FFF 100%);color:#0D2847;}
.top-nav{background:white;border-bottom:2px solid rgba(13,40,71,0.1);padding:16px 40px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.nav-left{display:flex;align-items:center;gap:40px;}
.logo-text{font-family:'Crimson Pro',serif;font-size:24px;font-weight:700;color:var(--navy);text-decoration:none;}
.nav-menu{display:flex;gap:32px;align-items:center;}
.nav-link{text-decoration:none;color:#4A5568;font-weight:500;font-size:15px;transition:color 0.2s;}
.nav-link:hover{color:var(--navy);}
.nav-right{display:flex;align-items:center;gap:16px;}
.user-profile{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--orange),#FFB380);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px;cursor:pointer;}
.container{display:flex;max-width:1400px;margin:0 auto;}
.sidebar{width:280px;background:white;border-right:1px solid rgba(13,40,71,0.1);padding:30px 20px;}
.nav-step{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;border-left:3px solid transparent;text-decoration:none;color:#4A5568;}
.nav-step.active{background:rgba(255,140,66,0.1);border-left-color:var(--orange);color:var(--navy);font-weight:600;}
.nav-step.completed{color:#10B981;}
.step-number{width:28px;height:28px;border-radius:50%;background:#F7FAFC;border:2px solid #E2E8F0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:#999;}
.nav-step.active .step-number{background:var(--orange);border-color:var(--orange);color:white;}
.nav-step.completed .step-number{background:#10B981;border-color:#10B981;color:white;}
.main-content{flex:1;padding:40px 60px;max-width:900px;}
.page-title{font-family:'Crimson Pro',serif;font-size:42px;font-weight:700;margin-bottom:12px;color:var(--navy);}
.page-subtitle{font-size:18px;color:#4A5568;margin-bottom:26px;}
.progress-bar{height:6px;background:#E2E8F0;border-radius:3px;margin-bottom:26px;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--orange),#FFB380);border-radius:3px;}

/* Standards Verification Banner */
.verification-banner{background:rgba(16,185,129,0.05);border:2px solid rgba(16,185,129,0.2);border-radius:12px;padding:14px 18px;margin-bottom:18px;transition:all 0.3s;}
.verification-banner:hover{border-color:rgba(16,185,129,0.4);box-shadow:0 2px 8px rgba(16,185,129,0.1);}
.banner-header{display:flex;justify-content:space-between;align-items:center;gap:12px;}
.banner-left{display:flex;align-items:center;gap:10px;}
.banner-icon{font-size:20px;color:var(--green);display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;background:rgba(16,185,129,0.1);}
.banner-text{font-weight:600;color:var(--navy);font-size:15px;}
.banner-meta{font-size:13px;color:#718096;margin-left:42px;margin-top:2px;}
.view-details-btn{background:white;border:2px solid rgba(16,185,129,0.3);color:var(--green);padding:8px 14px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
.view-details-btn:hover{background:rgba(16,185,129,0.05);border-color:var(--green);transform:translateY(-1px);}
.details-icon{font-size:12px;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);}
.details-icon.expanded{transform:rotate(180deg);}

/* Expandable Details Section */
.details-section{max-height:0;overflow:hidden;transition:max-height 0.5s cubic-bezier(0.4,0,0.2,1);}
.details-section.show{max-height:1400px;padding-top:14px;}

/* Legend Bar */
.legend-bar{background:white;border:2px solid rgba(59,130,246,0.2);border-radius:10px;padding:12px 16px;margin-bottom:14px;display:flex;justify-content:center;align-items:center;gap:22px;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:#4A5568;font-weight:500;}

/* Standard Card */
.standard-card{background:white;border:2px solid #E2E8F0;border-radius:12px;padding:14px;margin-bottom:10px;transition:all 0.2s;}
.standard-card:hover{border-color:var(--orange);box-shadow:0 4px 12px rgba(255,140,66,0.1);}
.standard-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;}
.standard-number{font-weight:700;color:var(--orange);font-size:14px;background:rgba(255,140,66,0.1);padding:4px 10px;border-radius:6px;}
.standard-text{color:#4A5568;line-height:1.6;margin-bottom:12px;font-size:14px;}
.standard-meta{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding-top:10px;border-top:1px solid #E2E8F0;}
.confidence-badge{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
.confidence-badge.high{background:rgba(16,185,129,0.1);color:#059669;}
.confidence-badge.medium{background:rgba(245,158,11,0.1);color:#D97706;}
.confidence-badge.low{background:rgba(239,68,68,0.1);color:#DC2626;}
.source-link{color:var(--blue);text-decoration:none;font-size:13px;font-weight:600;transition:all 0.2s;display:inline-flex;align-items:center;gap:4px;}
.source-link:hover{color:var(--orange);}
.source-link::after{content:'‚Üí';transition:transform 0.2s;}
.source-link:hover::after{transform:translateX(3px);}

/* Details Footer */
.details-footer{margin-top:14px;padding-top:12px;border-top:1px solid #E2E8F0;display:flex;justify-content:center;gap:16px;flex-wrap:wrap;}
.btn-text{background:none;border:none;color:#718096;font-size:13px;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;font-weight:500;padding:8px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;}
.btn-text:hover{color:var(--orange);background:rgba(255,140,66,0.05);}

.lesson-preview{background:white;border:2px solid #E2E8F0;border-radius:16px;padding:26px;margin-bottom:20px;}
.lesson-title{font-size:28px;font-weight:700;color:var(--navy);margin-bottom:14px;text-align:center;}
.lesson-meta{text-align:center;color:#4A5568;margin-bottom:12px;padding-bottom:12px;border-top:2px solid #E2E8F0;}
.lesson-summary{text-align:center;color:#4A5568;font-size:15px;line-height:1.55;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #E2E8F0;}
.lesson-section{margin-bottom:18px;}
.lesson-section h3{font-size:20px;font-weight:700;color:var(--navy);margin-bottom:8px;}
.lesson-section p{color:#4A5568;line-height:1.6;margin-bottom:6px;}
.lesson-section ul{margin-left:18px;color:#4A5568;line-height:1.6;}
.lesson-section li{margin-bottom:6px;}

.procedure-box{background:#F7FAFC;border-left:4px solid var(--orange);border-radius:8px;padding:14px;margin-bottom:10px;}
.procedure-title{font-weight:700;color:var(--navy);margin-bottom:6px;display:flex;align-items:center;gap:8px;}
.time-badge{background:var(--orange);color:white;padding:2px 8px;border-radius:4px;font-size:12px;}

.btn{padding:14px 28px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s;text-decoration:none;display:inline-block;border:none;}
.btn-primary{background:linear-gradient(135deg,var(--orange),#FFB380);color:white;}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,140,66,0.35);}
.btn-secondary{background:white;border:2px solid #E2E8F0;color:var(--navy);}
.btn-secondary:hover{border-color:var(--orange);}
.btn-group{display:flex;gap:16px;margin-top:18px;flex-wrap:wrap;}
.btn-print{display:inline-block;}

.enhancement-box{background:rgba(59,130,246,0.05);border:2px solid rgba(59,130,246,0.3);border-radius:16px;padding:22px;margin-top:22px;text-align:center;}
.enhancement-title{font-size:18px;font-weight:700;color:var(--navy);margin-bottom:8px;}
.enhancement-text{color:#4A5568;line-height:1.5;margin-bottom:14px;font-size:14px;}
.enhancement-buttons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;}

.loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
.loading-overlay.hidden{display:none;}
.blocks-loader{position:relative;width:73px;height:66px;margin-bottom:18px;}
.block{position:absolute;border-radius:6px;opacity:0;animation-duration:2.6s;animation-timing-function:cubic-bezier(.2,.9,.2,1);animation-iteration-count:infinite;will-change:transform, opacity;}
.bl{width:48px;height:20px;left:0;bottom:0;background:var(--navy);animation-name:bl-in;}
.tl{width:22px;height:20px;left:26px;bottom:24px;background:var(--navy);animation-name:tl-in;}
.br{width:22px;height:44px;left:51px;bottom:0;background:var(--navy);animation-name:br-in;}
.tr{width:22px;height:20px;left:51px;top:0;background:var(--orange);animation-name:tr-in;}
@keyframes bl-in{0%{opacity:0;transform:translateX(16px);}12%{opacity:1;transform:translateX(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes br-in{0%,14%{opacity:0;transform:translateY(16px);}26%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes tl-in{0%,28%{opacity:0;transform:translateX(-16px);}40%{opacity:1;transform:translateX(0);}80%{opacity:1;}100%{opacity:0;}}
@keyframes tr-in{0%,42%{opacity:0;transform:translateY(-18px) scale(.96);}54%{opacity:1;transform:translateY(0) scale(1.06);}60%{transform:translateY(1px) scale(.99);}66%{transform:translateY(0) scale(1);}80%{opacity:1;}100%{opacity:0;}}
.loading-message{font-size:16px;color:var(--navy);font-weight:500;text-align:center;min-height:24px;padding:0 16px;}
@media (prefers-reduced-motion: reduce){.block{animation:none;opacity:1;transform:none;}}

@media print{
  body * {visibility: hidden;}
  .lesson-preview, .lesson-preview * {visibility: visible;}
  .lesson-preview {position: absolute;left: 0;top: 0;width: 100%;border: none;box-shadow: none;padding: 0;margin: 0;}
  .top-nav, .sidebar, .btn-group, .enhancement-box, .verification-banner, .page-title, .page-subtitle, .progress-bar, .main-content {display: none !important;}
  .source-link { display: none !important; } /* Print should NOT show Source links */
}
</style>
</head>
<body>
<nav class="top-nav">
  <div class="nav-left">
    <a href="index.html" class="logo-text">LessonBuilders</a>
    <div class="nav-menu">
      <a href="library.html" class="nav-link">My Lessons</a>
      <a href="discover.html" class="nav-link">Discover</a>
      <a href="about.html" class="nav-link">Help</a>
    </div>
  </div>
  <div class="nav-right">
    <div class="user-profile">JD</div>
  </div>
</nav>

<div class="container">
  <aside class="sidebar">
    <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#999;margin-bottom:16px;">BUILD LESSON</div>
    <a href="build-step1.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Basic Information</div></a>
    <a href="build-step2.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Teaching Style</div></a>
    <a href="build-step3.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Choose Template</div></a>
    <a href="build-step4.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Build Method</div></a>
    <a href="build-step5.html" class="nav-step completed"><div class="step-number">&#10003;</div><div>Assessments</div></a>
    <a href="build-step6.html" class="nav-step active"><div class="step-number">6</div><div>Preview & Export</div></a>
    <a href="build-step7.html" class="nav-step"><div class="step-number">7</div><div>Collaborate</div></a>
  </aside>

  <main class="main-content">
    <h1 class="page-title">Your lesson is ready</h1>
    <p class="page-subtitle">Review, download, then continue to collaborations</p>
    <div class="progress-bar"><div class="progress-fill" style="width:86%;"></div></div>

    <!-- Standards Verification Banner -->
    <div class="verification-banner" id="verificationBanner">
      <div class="banner-header">
        <div class="banner-left">
          <div class="banner-icon">‚úì</div>
          <div>
            <div class="banner-text" id="bannerText">Verifying California Standards...</div>
            <div class="banner-meta" id="bannerMeta">This will take 5-15 seconds</div>
          </div>
        </div>
        <button class="view-details-btn" id="viewDetailsBtn" onclick="toggleDetails()" style="display:none;">
          View Details
          <span class="details-icon" id="detailsIcon">‚ñº</span>
        </button>
      </div>

      <div class="details-section" id="detailsSection">
        <div class="legend-bar">
          <div class="legend-item">
            <span class="confidence-badge high">High ‚úì‚úì</span>
            <span>Exact match</span>
          </div>
          <div class="legend-item">
            <span class="confidence-badge medium">Medium ‚úì</span>
            <span>Partial match</span>
          </div>
          <div class="legend-item">
            <span class="confidence-badge low">Manual ‚ö†Ô∏è</span>
            <span>Verify manually</span>
          </div>
        </div>

        <div id="standardsContainer"></div>

        <div class="details-footer">
          <button class="btn-text" onclick="reportError()">‚ö†Ô∏è Report an Error</button>
          <button class="btn-text" onclick="reverifyStandards()">üîÑ Re-verify Standards</button>
        </div>
      </div>
    </div>

    <!-- Lesson Preview -->
    <div class="lesson-preview">
      <h2 class="lesson-title" id="lessonTitle">Loading...</h2>
      <div class="lesson-meta" id="lessonMeta"></div>
      <div class="lesson-summary" id="lessonSummary"></div>
      <div id="lessonContent"></div>
    </div>

    <!-- Regenerate / Feedback -->
    <div class="feedback-box" id="feedbackBox" style="display:none;background:white;border:2px solid #E2E8F0;border-radius:16px;padding:22px;margin-top:16px;margin-bottom:16px;">
      <div class="feedback-title" style="font-size:18px;font-weight:700;color:var(--navy);margin-bottom:6px;">Want to make changes?</div>
      <div class="feedback-subtitle" style="font-size:14px;color:#718096;margin-bottom:12px;">Example: tighten procedure steps, change pacing, add a hands-on demo...</div>
      <textarea id="feedbackTextarea" placeholder="Describe your changes here..." style="width:100%;padding:14px;border:2px solid #E2E8F0;border-radius:10px;font-size:15px;font-family:'DM Sans',sans-serif;resize:vertical;min-height:110px;"></textarea>
      <button class="btn btn-primary" style="width:100%;margin-top:12px;" onclick="regenerateLesson()">Update Lesson</button>
    </div>

    <!-- Actions -->
    <div class="btn-group">
      <button class="btn btn-secondary btn-print" id="printBtn" onclick="window.print()">&#128424; Print</button>
      <button class="btn btn-primary" onclick="continueToStep7()">Continue &rarr;</button>
    </div>

    <div class="enhancement-box" style="display:none;">
      <div class="enhancement-title">Collaborations happen in Step 7</div>
      <div class="enhancement-text">Click Continue to explore cross-curricular connections.</div>
    </div>
  </main>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay hidden" id="loadingOverlay" role="status" aria-live="polite">
  <div class="blocks-loader" aria-hidden="true">
    <div class="block bl"></div>
    <div class="block tl"></div>
    <div class="block br"></div>
    <div class="block tr"></div>
  </div>
  <div class="loading-message" id="loadingMessage">Building a great lesson, one block at a time</div>
</div>

<script>
/**
 * Step 6 (Single View)
 * - Verify standards via backend (local-first)
 * - Generate lesson via backend (Haiku + strict JSON enforced server-side)
 * - Print + Continue (Continue saves to library + goes to Step 7)
 */

const API_URL = (localStorage.getItem('API_URL') || "https://lessonbuilders-backend-production.up.railway.app").replace(/\/$/, "");

// Loading overlay messages
const messages = [
  "Building a great lesson, one block at a time",
  "Verifying California standards‚Ä¶",
  "Aligning to learning standards‚Ä¶",
  "Designing engaging activities‚Ä¶",
  "Finalizing your lesson plan‚Ä¶"
];
let msgIndex = 0;
let msgTimer;

function showLoading(){
  const overlay = document.getElementById("loadingOverlay");
  const msgEl = document.getElementById("loadingMessage");
  overlay.classList.remove("hidden");
  msgEl.textContent = messages[0];
  msgIndex = 0;
  clearInterval(msgTimer);
  msgTimer = setInterval(() => {
    msgIndex = (msgIndex + 1) % messages.length;
    msgEl.textContent = messages[msgIndex];
  }, 2200);
}

function hideLoading(){
  document.getElementById("loadingOverlay").classList.add("hidden");
  clearInterval(msgTimer);
}

let lessonData = {};
let verifiedStandards = [];
let lastLessonJSON = null;

const frameworkNames = {
  'madeline-hunter': 'Madeline Hunter',
  '5e-model': '5E Model',
  'ubd': 'Understanding by Design',
  'gradual-release': 'Gradual Release'
};

window.addEventListener('DOMContentLoaded', function() {
  const saved = localStorage.getItem('lessonData');
  if (saved) {
    lessonData = JSON.parse(saved);
    verifiedStandards = Array.isArray(lessonData.verifiedStandards) ? lessonData.verifiedStandards : [];
    generateLesson();
  } else {
    document.getElementById('lessonTitle').textContent = "Missing lesson data";
    document.getElementById('lessonSummary').textContent = "Go back to Step 1 to start building a lesson.";
  }
});

function toggleDetails() {
  const section = document.getElementById('detailsSection');
  const icon = document.getElementById('detailsIcon');
  const btn = document.getElementById('viewDetailsBtn');

  section.classList.toggle('show');
  icon.classList.toggle('expanded');

  if (section.classList.contains('show')) {
    btn.innerHTML = 'Hide Details <span class="details-icon expanded" id="detailsIcon">‚ñº</span>';
  } else {
    btn.innerHTML = 'View Details <span class="details-icon" id="detailsIcon">‚ñº</span>';
  }
}

function setBannerVerifying() {
  const bannerText = document.getElementById('bannerText');
  const bannerMeta = document.getElementById('bannerMeta');
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  const standardsContainer = document.getElementById('standardsContainer');

  bannerText.textContent = "Verifying California Standards...";
  bannerMeta.textContent = "This will take 5-15 seconds";
  viewDetailsBtn.style.display = "none";
  standardsContainer.innerHTML = "";
  document.getElementById('detailsSection').classList.remove('show');
}

function setBannerFallback(message) {
  const bannerText = document.getElementById('bannerText');
  const bannerMeta = document.getElementById('bannerMeta');
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');

  bannerText.textContent = "Standards verification unavailable";
  bannerMeta.textContent = message || "Continuing without verified standards.";
  viewDetailsBtn.style.display = "none";
  document.getElementById('standardsContainer').innerHTML = "";
  document.getElementById('detailsSection').classList.remove('show');
}

async function safeJson(res) {
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { _raw: text }; }
}

function persistVerifiedStandards(standardsArr) {
  try {
    if (!lessonData || typeof lessonData !== "object") lessonData = {};
    lessonData.verifiedStandards = Array.isArray(standardsArr) ? standardsArr : [];
    localStorage.setItem("lessonData", JSON.stringify(lessonData));
  } catch (e) {
    console.warn("Could not persist verifiedStandards:", e);
  }
}

function persistGeneratedLessonToLessonData(lessonObj){
  try{
    const saved = localStorage.getItem("lessonData");
    const data = saved ? JSON.parse(saved) : {};
    data.generatedLesson = lessonObj || null;  // ‚úÖ Step 7 should read this
    localStorage.setItem("lessonData", JSON.stringify(data));
    lessonData = data;
  } catch(e){
    console.warn("Could not persist generatedLesson:", e);
  }
}

function getStandardsForDisplay(lesson) {
  const a = Array.isArray(lesson?.verifiedStandards) ? lesson.verifiedStandards : null;
  const b = Array.isArray(lesson?.standards) ? lesson.standards : null;
  const c = Array.isArray(verifiedStandards) ? verifiedStandards : null;
  const d = Array.isArray(lessonData?.verifiedStandards) ? lessonData.verifiedStandards : null;
  return (a && a.length ? a : (b && b.length ? b : (c && c.length ? c : (d && d.length ? d : []))));
}

function renderStandardsSection(standardsArr) {
  if (!Array.isArray(standardsArr) || !standardsArr.length) return "";

  const items = standardsArr.map(std => {
    const code = escapeHtml((std.code || std.standardCode || std.id || "").toString());
    const text = escapeHtml((std.text || std.description || "").toString());
    const link = std.sourceURL || std.sourceUrl || "";
    const linkHtml = link ? ` <a href="${link}" target="_blank" rel="noopener noreferrer" class="source-link" style="font-size:12px;">Source</a>` : "";

    return `
      <li style="margin-bottom:8px;">
        ${code ? `<strong style="color:var(--navy);">${code}</strong>${linkHtml}<br>` : ""}
        <span style="color:#4A5568;line-height:1.55;">${text}</span>
      </li>
    `;
  }).join("");

  return `
    <div class="lesson-section">
      <h3>California Standards</h3>
      <ul>${items}</ul>
    </div>
  `;
}

function buildExportDocText(lesson){
  const blob = new Blob(
    [lessonToPlainText(lesson)],
    { type: "text/plain;charset=utf-8" }
  );
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${(lesson?.title || lessonData?.step1?.topic || "Lesson").replace(/[^\w\-]+/g,'_')}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function lessonToPlainText(lesson){
  const lines = [];
  const step1 = lessonData.step1 || {};
  lines.push(step1.topic || "Lesson");
  lines.push("");
  lines.push(`Grade: ${step1.grade || ""}`);
  lines.push(`Subject: ${step1.subject || ""}`);
  lines.push(`Duration: ${step1.duration || ""} minutes`);
  lines.push(`Framework: ${frameworkNames[(lessonData.step3||{}).framework] || (lessonData.step3||{}).framework || ""}`);
  lines.push("");

  const standards = getStandardsForDisplay(lesson);
  if (standards.length){
    lines.push("California Standards");
    standards.forEach(s => {
      const code = s.code || s.id || "";
      const text = s.text || s.description || "";
      lines.push(`- ${code}${code ? ": " : ""}${text}`);
    });
    lines.push("");
  }

  if (lesson.summary) {
    lines.push("Summary");
    lines.push(lesson.summary);
    lines.push("");
  }

  if (Array.isArray(lesson.objectives) && lesson.objectives.length){
    lines.push("Objectives");
    lesson.objectives.forEach(o => lines.push(`- ${o}`));
    lines.push("");
  }

  if (Array.isArray(lesson.materials) && lesson.materials.length){
    lines.push("Materials");
    lesson.materials.forEach(m => lines.push(`- ${m}`));
    lines.push("");
  }

  if (Array.isArray(lesson.keyVocabulary) && lesson.keyVocabulary.length){
    lines.push("Key Vocabulary");
    lesson.keyVocabulary.forEach(v => lines.push(`- ${v}`));
    lines.push("");
  }

  if (lesson.udlConnections){
    lines.push("UDL Connections");
    lines.push(`Engagement: ${lesson.udlConnections.engagement || ""}`);
    lines.push(`Representation: ${lesson.udlConnections.representation || ""}`);
    lines.push(`Action & Expression: ${lesson.udlConnections.actionExpression || ""}`);
    lines.push("");
  }

  if (Array.isArray(lesson.procedures) && lesson.procedures.length){
    lines.push("Procedures");
    lesson.procedures.forEach((p, i) => {
      lines.push(`${i+1}. ${p.name || "Step"} (${p.time ?? ""} min)`);
      lines.push(`${p.description || ""}`);
      lines.push("");
    });
  }

  if (lesson.assessmentSummary){
    lines.push("Assessment Summary");
    lines.push(lesson.assessmentSummary);
    lines.push("");
  }

  return lines.join("\n");
}

function generateLesson() {
  const step1 = lessonData.step1 || {};
  const step2 = lessonData.step2 || {};
  const step3 = lessonData.step3 || {};
  const step5 = lessonData.step5 || {};

  const topic = step1.topic || 'Untitled Lesson';
  const grade = step1.grade || '5th Grade';
  const subject = step1.subject || 'Mathematics';
  const duration = step1.duration || 45;
  const framework = step3.framework || 'madeline-hunter';

  document.getElementById('lessonTitle').textContent = topic;

  const metaHTML = `
    <p><strong>Grade:</strong> ${escapeHtml(grade)} | <strong>Subject:</strong> ${escapeHtml(subject)} | <strong>Duration:</strong> ${escapeHtml(String(duration))} minutes</p>
    <p><strong>Framework:</strong> ${escapeHtml(frameworkNames[framework] || framework)}</p>
  `;
  document.getElementById('lessonMeta').innerHTML = metaHTML;

  setBannerVerifying();
  showLoading();

  generateLessonViaBackend({ topic, grade, subject, duration, framework, step2, step5, feedback: null });
}

async function generateLessonViaBackend({ topic, grade, subject, duration, framework, step2, step5, feedback }) {
  try {
    // 1) Verify standards (best-effort)
    let standards = [];
    try {
      const verifyRes = await fetch(`${API_URL}/api/verify-standards`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ grade, subject, topic })
      });
      const verifyData = await safeJson(verifyRes);

      if (verifyRes.ok && verifyData && Array.isArray(verifyData.standards)) {
        standards = verifyData.standards;
        verifiedStandards = standards;
        persistVerifiedStandards(verifiedStandards);
        updateVerificationBanner(standards, verifyData.source);
      } else {
        setBannerFallback(verifyData?.message || "Continuing without verified standards.");
      }
    } catch (e) {
      console.warn("Standards verification failed (continuing):", e);
      setBannerFallback("Continuing without verified standards.");
    }

    // 2) Generate lesson
    const lessonPayload = {
      step1: { topic, grade, subject, duration },
      step2: step2 || { handsOn: 0, direct: 0, collaborative: 0, independent: 0, technology: 0 },
      step3: { framework },
      step5: step5 || { exitTicket: true, formativeChecks: true, homework: false, quiz: false },
      verifiedStandards: standards && standards.length ? standards : []
    };

    if (feedback) lessonPayload.feedback = feedback;

    const genRes = await fetch(`${API_URL}/api/generate-lesson`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(lessonPayload)
    });

    const genData = await safeJson(genRes);

    if (!genRes.ok) {
      throw new Error(genData?.error || genData?.details || genData?.message || "Lesson generation failed.");
    }

    // Backend now returns clean JSON lesson object
    const lesson = genData;
    lastLessonJSON = lesson;

    // Persist for Step 7
    persistGeneratedLessonToLessonData(lastLessonJSON);

    // Inject standards for renderer
    lesson.verifiedStandards = Array.isArray(standards) && standards.length ? standards : (Array.isArray(verifiedStandards) ? verifiedStandards : []);

    hideLoading();
    displayGeneratedLesson(lesson);
    document.getElementById('feedbackBox').style.display = 'block';

  } catch (error) {
    console.error("Error generating lesson:", error);
    hideLoading();
    alert("There was an error generating your lesson. Please try again.\n\n" + (error.message || ""));
    document.getElementById('feedbackBox').style.display = 'block';
  }
}

function updateVerificationBanner(standards, source) {
  const bannerText = document.getElementById('bannerText');
  const bannerMeta = document.getElementById('bannerMeta');
  const viewDetailsBtn = document.getElementById('viewDetailsBtn');
  const standardsContainer = document.getElementById('standardsContainer');

  const count = standards.length;
  const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

  bannerText.textContent = `${count} California Standard${count !== 1 ? 's' : ''} Verified`;
  bannerMeta.textContent = `Verified on ${today}${source ? ` (${source})` : ""}`;
  viewDetailsBtn.style.display = 'inline-flex';

  standardsContainer.innerHTML = standards.map(std => {
    const confidenceClass = (std.confidence || 'medium').toLowerCase();
    const confidenceLabels = {
      high: 'High Confidence ‚úì‚úì',
      medium: 'Medium Confidence ‚úì',
      low: 'Manual Check ‚ö†Ô∏è'
    };

    const link = std.sourceURL || std.sourceUrl || "https://www.cde.ca.gov/";
    const safeCode = (std.code || "").toString();
    const safeText = (std.text || "").toString();

    return `
      <div class="standard-card">
        <div class="standard-header">
          <div class="standard-number">${escapeHtml(safeCode)}</div>
        </div>
        <div class="standard-text">${escapeHtml(safeText)}</div>
        <div class="standard-meta">
          <span class="confidence-badge ${confidenceClass}">${confidenceLabels[confidenceClass] || confidenceLabels.medium}</span>
          <a href="${link}" target="_blank" rel="noopener noreferrer" class="source-link">View Source</a>
        </div>
      </div>
    `;
  }).join('');
}

function displayGeneratedLesson(lesson) {
  document.getElementById('lessonSummary').textContent = lesson.summary || "";

  const standardsForDoc = getStandardsForDisplay(lesson);
  const standardsHTML = renderStandardsSection(standardsForDoc);

  const objectives = Array.isArray(lesson.objectives) ? lesson.objectives : [];
  const materials = Array.isArray(lesson.materials) ? lesson.materials : [];
  const procedures = Array.isArray(lesson.procedures) ? lesson.procedures : [];
  const keyVocab = Array.isArray(lesson.keyVocabulary) ? lesson.keyVocabulary : [];

  const udl = lesson.udlConnections || null;

  const proceduresHTML = procedures.map((step, index) => `
    <div class="procedure-box">
      <div class="procedure-title">${escapeHtml(step.name || `Step ${index+1}`)} <span class="time-badge">${escapeHtml(String(step.time ?? ""))} min</span></div>
      <div style="color:#4A5568;line-height:1.55;">${escapeHtml(step.description || "")}</div>
    </div>
  `).join('');

  const keyVocabHTML = keyVocab.length ? `
    <div class="lesson-section">
      <h3>Key Vocabulary</h3>
      <ul>${keyVocab.map(w => `<li>${escapeHtml(w)}</li>`).join("")}</ul>
    </div>
  ` : "";

  const udlHTML = udl ? `
    <div class="lesson-section">
      <h3>UDL Connections</h3>
      <p><strong>Engagement:</strong> ${escapeHtml(udl.engagement || "")}</p>
      <p><strong>Representation:</strong> ${escapeHtml(udl.representation || "")}</p>
      <p><strong>Action &amp; Expression:</strong> ${escapeHtml(udl.actionExpression || "")}</p>
    </div>
  ` : "";

  const assessmentSummaryHTML = lesson.assessmentSummary ? `
    <div class="lesson-section">
      <h3>Assessment Summary</h3>
      <p>${escapeHtml(lesson.assessmentSummary)}</p>
    </div>
  ` : "";

  const content = `
    ${standardsHTML}

    <div class="lesson-section">
      <h3>Learning Objectives</h3>
      <ul>${objectives.map(obj => `<li>${escapeHtml(obj)}</li>`).join('')}</ul>
    </div>

    <div class="lesson-section">
      <h3>Materials Needed</h3>
      <ul>${materials.map(mat => `<li>${escapeHtml(mat)}</li>`).join('')}</ul>
    </div>

    ${keyVocabHTML}
    ${udlHTML}

    <div class="lesson-section">
      <h3>Procedures</h3>
      ${proceduresHTML}
    </div>

    ${assessmentSummaryHTML}
  `;

  document.getElementById('lessonContent').innerHTML = content;
}

function regenerateLesson() {
  const feedback = document.getElementById('feedbackTextarea').value.trim();
  if (!feedback) {
    alert('Please describe what changes you want to make.');
    return;
  }

  document.getElementById('feedbackBox').style.display = 'none';
  showLoading();

  const saved = localStorage.getItem('lessonData');
  if (saved) {
    const data = JSON.parse(saved);
    const step1 = data.step1 || {};
    const step2 = data.step2 || {};
    const step3 = data.step3 || {};
    const step5 = data.step5 || {};

    const topic = step1.topic || 'Untitled Lesson';
    const grade = step1.grade || '5th Grade';
    const subject = step1.subject || 'Mathematics';
    const duration = step1.duration || 45;
    const framework = step3.framework || 'madeline-hunter';

    generateLessonViaBackend({ topic, grade, subject, duration, framework, step2, step5, feedback });
  }
}

function saveToLibrary() {
  const saved = localStorage.getItem('lessonData');
  if (!saved) return;

  const data = JSON.parse(saved);

  const lesson = {
    id: Date.now(),
    title: data.step1?.topic || 'Untitled Lesson',
    grade: data.step1?.grade || '5th Grade',
    subject: data.step1?.subject || 'Mathematics',
    duration: data.step1?.duration || 45,
    framework: data.step3?.framework || 'madeline-hunter',
    verifiedStandards: Array.isArray(data.verifiedStandards) ? data.verifiedStandards : verifiedStandards,
    savedAt: new Date().toISOString(),
    generatedLesson: lastLessonJSON || data.generatedLesson || null,
    fullLesson: data
  };

  let savedLessons = [];
  const existing = localStorage.getItem('savedLessons');
  if (existing) savedLessons = JSON.parse(existing);

  savedLessons.push(lesson);
  localStorage.setItem('savedLessons', JSON.stringify(savedLessons));
}

function continueToStep7(){
  // Save to library + persist latest generated lesson to lessonData
  saveToLibrary();
  if (lastLessonJSON) persistGeneratedLessonToLessonData(lastLessonJSON);

  // Go to collaborate page
  window.location.href = 'build-step7.html';
}

function reportError() {
  alert('Error reporting: Teachers would describe which standard appears incorrect. This feedback improves the verification system.');
}

function reverifyStandards() {
  const step1 = lessonData.step1 || {};
  const topic = step1.topic || '';
  const grade = step1.grade || '';
  const subject = step1.subject || '';

  if (!topic || !grade || !subject) {
    alert("Missing topic/grade/subject. Go back to Step 1.");
    return;
  }

  setBannerVerifying();
  showLoading();

  (async () => {
    try {
      const verifyRes = await fetch(`${API_URL}/api/verify-standards`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ grade, subject, topic })
      });
      const verifyData = await safeJson(verifyRes);

      if (verifyRes.ok && verifyData && Array.isArray(verifyData.standards)) {
        verifiedStandards = verifyData.standards;
        persistVerifiedStandards(verifiedStandards);
        updateVerificationBanner(verifiedStandards, verifyData.source);
        hideLoading();

        if (lastLessonJSON) {
          lastLessonJSON.verifiedStandards = verifiedStandards;
          displayGeneratedLesson(lastLessonJSON);
        }
      } else {
        hideLoading();
        setBannerFallback(verifyData?.message || "Continuing without verified standards.");
      }
    } catch (e) {
      hideLoading();
      setBannerFallback("Continuing without verified standards.");
    }
  })();
}

// Simple export (TXT for now)
window.addEventListener("keydown", (e) => {
  // Ctrl+E to export quickly (optional)
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "e") {
    if (lastLessonJSON) buildExportDocText(lastLessonJSON);
  }
});

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>
</body>
</html>
