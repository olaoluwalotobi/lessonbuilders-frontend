<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assessments - LessonBuilders</title>

  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --orange-light:#FFB380;
      --green:#10B981;
      --gray-50:#F7FAFC;
      --gray-100:#EDF2F7;
      --gray-200:#E2E8F0;
      --gray-500:#718096;
      --gray-600:#4A5568;
      --blue:#3B82F6;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'DM Sans',sans-serif;
      background: linear-gradient(135deg, #F7FAFC 0%, #FFF 100%);
      color: var(--navy);
    }

    /* Top nav (matches your Step pages vibe) */
    .top-nav{
      background:#fff;
      border-bottom:2px solid rgba(13,40,71,0.08);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;
      font-weight:700;
      color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;
      color:var(--gray-600);
      font-weight:500;
      font-size:15px;
      transition:color 0.2s;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{
      color:var(--navy);
      font-weight:700;
      position:relative;
    }
    .nav-link.active::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:-18px;
      height:3px;
      border-radius:999px;
      background:linear-gradient(90deg,var(--orange),var(--orange-light));
    }

    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:14px;
      cursor:default;
    }

    /* Layout */
    .container{display:flex;max-width:1400px;margin:0 auto;}
    .sidebar{
      width:280px;
      background:#fff;
      border-right:1px solid rgba(13,40,71,0.08);
      padding:30px 20px;
    }

    .side-title{
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.6px;
      color:#999;
      margin-bottom:16px;
    }

    /* Left menu (Step 1–7 look) */
    .side-step{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      margin-bottom:8px;
      border-left:3px solid transparent;
      border-radius:10px;
      text-decoration:none;
      color:var(--gray-600);
      cursor:pointer;
      transition:all 0.2s;
      user-select:none;
    }
    .side-step:hover{
      background:rgba(255,140,66,0.08);
      color:var(--navy);
    }
    .side-step.active{
      background:rgba(255,140,66,0.12);
      border-left-color:var(--orange);
      color:var(--navy);
      font-weight:700;
    }
    .step-number{
      width:28px;height:28px;border-radius:50%;
      background:var(--gray-50);
      border:2px solid var(--gray-200);
      display:flex;align-items:center;justify-content:center;
      font-size:13px;font-weight:800;color:#999;
      flex:0 0 auto;
    }
    .side-step.active .step-number{
      background:var(--orange);
      border-color:var(--orange);
      color:#fff;
    }

    .main-content{flex:1;padding:40px 60px;max-width:980px;}
    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:42px;font-weight:700;
      margin-bottom:10px;color:var(--navy);
    }
    .page-subtitle{
      font-size:16px;
      color:var(--gray-600);
      margin-bottom:18px;
      line-height:1.5;
    }
    .progress-bar{height:6px;background:var(--gray-200);border-radius:3px;margin-bottom:18px;}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--orange-light));border-radius:3px;width:60%;}

    /* Card */
    .card{
      background:#fff;
      border:2px solid var(--gray-200);
      border-radius:16px;
      padding:18px;
      box-shadow:none;
    }
    .card + .card{margin-top:16px;}

    .card-title{
      font-size:18px;font-weight:800;color:var(--navy);
      margin-bottom:6px;
    }
    .card-subtitle{
      font-size:14px;color:var(--gray-500);
      margin-bottom:14px;
      line-height:1.5;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid-1{grid-template-columns: 1fr;}
    .field label{
      display:block;
      font-size:12px;
      font-weight:800;
      color:#6B7280;
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:6px;
    }
    .input, .select, .textarea{
      width:100%;
      border:2px solid var(--gray-200);
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      font-family:'DM Sans',sans-serif;
      color:var(--navy);
      background:#fff;
      outline:none;
      transition:border-color .15s;
    }
    .input:focus, .select:focus, .textarea:focus{
      border-color:var(--orange);
    }

    /* Teacher notes: auto-height + wrap + resizer handle */
    .textarea{
      min-height:110px;
      resize: vertical;               /* keep the resize handle */
      overflow:hidden;                /* JS will auto-size; no horizontal scrolling */
      white-space:pre-wrap;           /* wraps lines */
      overflow-wrap:anywhere;         /* prevents long strings from pushing right */
      word-break:break-word;
    }

    .hint{
      margin-top:8px;
      font-size:13px;
      color:var(--gray-500);
      line-height:1.45;
    }

    /* Buttons (outside the card like Steps 1–7) */
    .btn-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:14px;
      max-width: 980px;
    }
    .btn-spacer{flex:1;}

    .btn{
      padding:14px 22px;
      border-radius:10px;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      transition:all .2s;
      border:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      color:#fff;
    }
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(255,140,66,0.30);
    }
    .btn-secondary{
      background:#fff;
      border:2px solid var(--gray-200);
      color:var(--navy);
    }
    .btn-secondary:hover{border-color:var(--orange);}

    /* Output: keep EXACT keys you wanted */
    .output-card{
      background:#fff;
      border:2px solid var(--gray-200);
      border-radius:16px;
      padding:18px;
      margin-top:16px;
    }
    .output-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .pill{
      font-size:12px;
      font-weight:800;
      color:var(--navy);
      background:rgba(255,140,66,0.12);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,140,66,0.22);
      white-space:nowrap;
    }
    pre{
      width:100%;
      background: #0b1220;
      color: #e2e8f0;
      border-radius:14px;
      padding:14px;
      overflow:auto;
      font-size:13px;
      line-height:1.45;
      border:1px solid rgba(148,163,184,.25);
    }

    .hidden{display:none !important;}

    /* Mobile */
    @media (max-width: 900px){
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:16px;flex-wrap:wrap;}
      .container{flex-direction:column;max-width:100%;}
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid rgba(13,40,71,0.08);
        padding:14px 12px;
        display:flex;
        gap:10px;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
      }
      .side-title{display:none;}
      .side-step{
        flex:0 0 auto;
        margin-bottom:0;
        border-left:none;
        border-bottom:3px solid transparent;
      }
      .side-step.active{
        border-bottom-color:var(--orange);
        border-left:none;
      }
      .main-content{padding:22px 16px;max-width:100%;}
      .grid{grid-template-columns:1fr;}
      .page-title{font-size:34px;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link">My Lessons</a>
        <a href="assessments.html" class="nav-link active">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <div class="side-title">ASSESSMENTS</div>

      <div class="side-step active" id="tabCreate">
        <div class="step-number">1</div>
        <div>Create</div>
      </div>

      <div class="side-step" id="tabUpload">
        <div class="step-number">2</div>
        <div>Upload</div>
      </div>
    </aside>

    <main class="main-content">
      <h1 class="page-title">Assessments</h1>
      <p class="page-subtitle">
        Create assessments from a LessonBuilders lesson, or upload your own lesson and generate aligned assessments.
      </p>
      <div class="progress-bar"><div class="progress-fill"></div></div>

      <!-- =========================
           CREATE SECTION
           ========================= -->
      <section id="createSection">
        <div class="card">
          <div class="card-title">Create from a lesson</div>
          <div class="card-subtitle">
            Pick a lesson, choose an assessment type, and add optional teacher notes.
          </div>

          <div class="grid">
            <div class="field">
              <label for="lessonPicker">Lesson</label>
              <select id="lessonPicker" class="select"></select>
              <div class="hint">Pulls from your local “savedLessons” library (Step 6 Save).</div>
            </div>

            <div class="field">
              <label for="assessmentType">Assessment type</label>
              <select id="assessmentType" class="select">
                <option value="Exit tickets">Exit tickets</option>
                <option value="In class activity">In class activity</option>
                <option value="Homework assignment">Homework assignment</option>
                <option value="Quiz">Quiz</option>
              </select>
              <div class="hint">We’ll generate the draft in the format you requested.</div>
            </div>
          </div>

          <div class="grid grid-1" style="margin-top:14px;">
            <div class="field">
              <label for="teacherNotes">Teacher notes (optional)</label>
              <textarea
                id="teacherNotes"
                class="textarea"
                placeholder="Optional: constraints, reading level, number of questions, accommodations, etc."></textarea>
              <div class="hint">
                Tip: Example notes — “Make it 10 minutes.” “Include sentence frames.” “Use the selected standards explicitly.”
              </div>
            </div>
          </div>
        </div>

        <!-- Buttons OUTSIDE the card (like Steps 1–7) -->
        <div class="btn-row">
          <button class="btn btn-secondary" id="btnClearCreate" type="button">Clear</button>
          <div class="btn-spacer"></div>
          <button class="btn btn-primary" id="btnGenerateDraft" type="button">Generate Draft</button>
        </div>

        <div class="output-card hidden" id="draftOutputCard">
          <div class="output-head">
            <div class="card-title" style="margin:0;">Draft output</div>
            <div class="pill" id="draftPill">Ready</div>
          </div>

          <!-- EXACT keys you wanted: studentCopy, answerKey, rubric, metadata -->
          <pre id="draftJson">{}</pre>

          <!-- Buttons OUTSIDE output box too -->
          <div class="btn-row">
            <button class="btn btn-secondary" id="btnCopyJson" type="button">Copy JSON</button>
            <div class="btn-spacer"></div>
            <button class="btn btn-secondary" id="btnDownloadJson" type="button">Download .json</button>
          </div>
        </div>
      </section>

      <!-- =========================
           UPLOAD SECTION
           ========================= -->
      <section id="uploadSection" class="hidden">
        <div class="card">
          <div class="card-title">Upload a lesson</div>
          <div class="card-subtitle">
            Paste a lesson plan (or notes) and we’ll generate assessment drafts in your required output format.
          </div>

          <div class="grid grid-1">
            <div class="field">
              <label for="uploadedLessonText">Lesson text</label>
              <textarea
                id="uploadedLessonText"
                class="textarea"
                placeholder="Paste your lesson plan here..."></textarea>
              <div class="hint">If you include standards codes, we’ll reference them in metadata.</div>
            </div>
          </div>

          <div class="grid" style="margin-top:14px;">
            <div class="field">
              <label for="uploadAssessmentType">Assessment type</label>
              <select id="uploadAssessmentType" class="select">
                <option value="Exit tickets">Exit tickets</option>
                <option value="In class activity">In class activity</option>
                <option value="Homework assignment">Homework assignment</option>
                <option value="Quiz">Quiz</option>
              </select>
            </div>

            <div class="field">
              <label for="uploadTeacherNotes">Teacher notes (optional)</label>
              <input id="uploadTeacherNotes" class="input" placeholder="e.g., 8 questions, include rubric, 15 minutes" />
            </div>
          </div>
        </div>

        <!-- Buttons OUTSIDE the card (like Steps 1–7) -->
        <div class="btn-row">
          <button class="btn btn-secondary" id="btnClearUpload" type="button">Clear</button>
          <div class="btn-spacer"></div>
          <button class="btn btn-primary" id="btnGenerateUpload" type="button">Generate Draft</button>
        </div>

        <div class="output-card hidden" id="uploadOutputCard">
          <div class="output-head">
            <div class="card-title" style="margin:0;">Draft output</div>
            <div class="pill" id="uploadPill">Ready</div>
          </div>
          <pre id="uploadJson">{}</pre>

          <div class="btn-row">
            <button class="btn btn-secondary" id="btnCopyUploadJson" type="button">Copy JSON</button>
            <div class="btn-spacer"></div>
            <button class="btn btn-secondary" id="btnDownloadUploadJson" type="button">Download .json</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- initials bubble -->
  <script type="module">
    function initialsFromEmail(email) {
      if (!email) return "LB";
      const namePart = String(email).split("@")[0] || "";
      const tokens = namePart.split(/[.\-_]/).filter(Boolean);
      const a = tokens[0]?.[0] || "";
      const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
      const ini = (a + b).toUpperCase();
      return ini || "LB";
    }
    const el = document.getElementById("userProfile");
    if (el) {
      try {
        const raw = localStorage.getItem("lb_user") || localStorage.getItem("user") || "";
        if (raw) {
          const u = JSON.parse(raw);
          const email = u?.email || u?.user?.email;
          el.textContent = initialsFromEmail(email);
        } else {
          el.textContent = "LB";
        }
      } catch {
        el.textContent = "LB";
      }
    }
  </script>

  <script>
    // =========
    // Tabs
    // =========
    const tabCreate = document.getElementById("tabCreate");
    const tabUpload = document.getElementById("tabUpload");
    const createSection = document.getElementById("createSection");
    const uploadSection = document.getElementById("uploadSection");

    function setActiveTab(which){
      const isCreate = which === "create";
      tabCreate.classList.toggle("active", isCreate);
      tabUpload.classList.toggle("active", !isCreate);
      createSection.classList.toggle("hidden", !isCreate);
      uploadSection.classList.toggle("hidden", isCreate);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    tabCreate.addEventListener("click", () => setActiveTab("create"));
    tabUpload.addEventListener("click", () => setActiveTab("upload"));

    // =========
    // Auto-height textarea (keeps resize handle, wraps, no horizontal scroll)
    // =========
    function autoSizeTextarea(el){
      if (!el) return;
      el.style.height = "auto";
      el.style.height = (el.scrollHeight + 2) + "px";
    }

    const teacherNotes = document.getElementById("teacherNotes");
    const uploadedLessonText = document.getElementById("uploadedLessonText");
    [teacherNotes, uploadedLessonText].forEach(t => {
      if (!t) return;
      autoSizeTextarea(t);
      t.addEventListener("input", () => autoSizeTextarea(t));
    });

    // =========
    // Lesson dropdown (from localStorage savedLessons)
    // =========
    function safeParse(str){ try { return JSON.parse(str); } catch { return null; } }

    function getSavedLessons(){
      const raw = localStorage.getItem("savedLessons");
      const arr = raw ? (safeParse(raw) || []) : [];
      return Array.isArray(arr) ? arr : [];
    }

    function populateLessonPicker(){
      const picker = document.getElementById("lessonPicker");
      const lessons = getSavedLessons();

      picker.innerHTML = "";

      if (!lessons.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No saved lessons found (save one in Step 6 first)";
        picker.appendChild(opt);
        picker.disabled = true;
        return;
      }

      picker.disabled = false;

      // newest first
      lessons
        .slice()
        .sort((a,b) => String(b.savedAt || "").localeCompare(String(a.savedAt || "")))
        .forEach((l, idx) => {
          const title = l.title || l.fullLesson?.step1?.topic || `Lesson ${idx+1}`;
          const meta = `${l.grade || l.fullLesson?.step1?.grade || ""} • ${l.subject || l.fullLesson?.step1?.subject || ""}`;
          const opt = document.createElement("option");
          opt.value = String(l.id ?? idx);
          opt.textContent = `${title} — ${meta}`;
          picker.appendChild(opt);
        });
    }

    populateLessonPicker();

    // =========
    // Draft generation (MVP: local-only demo output shape)
    // Later: wire to backend endpoint /api/generate-assessment
    // =========
    function buildDraft({ type, lessonTitle, standardsCodes, teacherNotes }){
      // IMPORTANT: keys EXACTLY as you requested
      return {
        studentCopy: {
          title: `${type}: ${lessonTitle || "Untitled Lesson"}`,
          directions: "Follow the directions for each part. Answer in complete sentences when asked.",
          items: [
            { id: 1, prompt: "Guiding Question 1 (auto-generated placeholder)", responseType: "short-answer" },
            { id: 2, prompt: "Guiding Question 2 (auto-generated placeholder)", responseType: "short-answer" },
            { id: 3, prompt: "Guiding Question 3 (auto-generated placeholder)", responseType: "short-answer" }
          ],
          notesToStudents: "If you are unsure, refer back to today’s lesson notes and examples."
        },
        answerKey: {
          answers: [
            { id: 1, exemplar: "Example answer key placeholder." },
            { id: 2, exemplar: "Example answer key placeholder." },
            { id: 3, exemplar: "Example answer key placeholder." }
          ]
        },
        rubric: {
          scale: [
            { level: 4, label: "Exceeds", description: "Accurate, complete, uses evidence/examples." },
            { level: 3, label: "Meets", description: "Mostly accurate, complete, minor errors." },
            { level: 2, label: "Developing", description: "Some accuracy, missing key elements." },
            { level: 1, label: "Beginning", description: "Limited understanding, major gaps." }
          ],
          criteria: [
            { name: "Accuracy", levels: { 4:"", 3:"", 2:"", 1:"" } },
            { name: "Use of evidence/examples", levels: { 4:"", 3:"", 2:"", 1:"" } },
            { name: "Clarity", levels: { 4:"", 3:"", 2:"", 1:"" } }
          ]
        },
        metadata: {
          type,
          alignedTo: {
            lessonTitle: lessonTitle || "Untitled Lesson",
            standardsCodes: standardsCodes || []
          },
          teacherNotes: teacherNotes || "",
          generatedAt: new Date().toISOString()
        }
      };
    }

    function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(
        () => alert("Copied."),
        () => alert("Could not copy. (Clipboard blocked by browser)")
      );
    }

    function downloadJson(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // =========
    // Create actions
    // =========
    const btnClearCreate = document.getElementById("btnClearCreate");
    const btnGenerateDraft = document.getElementById("btnGenerateDraft");
    const draftOutputCard = document.getElementById("draftOutputCard");
    const draftJson = document.getElementById("draftJson");
    const draftPill = document.getElementById("draftPill");
    const btnCopyJson = document.getElementById("btnCopyJson");
    const btnDownloadJson = document.getElementById("btnDownloadJson");

    btnClearCreate.addEventListener("click", () => {
      document.getElementById("assessmentType").value = "Exit tickets";
      teacherNotes.value = "";
      autoSizeTextarea(teacherNotes);
      draftOutputCard.classList.add("hidden");
      draftJson.textContent = "{}";
      draftPill.textContent = "Ready";
      populateLessonPicker();
    });

    btnGenerateDraft.addEventListener("click", () => {
      const lessons = getSavedLessons();
      if (!lessons.length){
        alert("No saved lessons found. Save a lesson in Step 6 first.");
        return;
      }

      const picker = document.getElementById("lessonPicker");
      const pickId = picker.value;
      const lesson = lessons.find(l => String(l.id) === String(pickId)) || lessons[0];

      const type = document.getElementById("assessmentType").value;
      const title = lesson.title || lesson.fullLesson?.step1?.topic || "Untitled Lesson";

      const standards = Array.isArray(lesson.verifiedStandards)
        ? lesson.verifiedStandards
        : (Array.isArray(lesson.fullLesson?.verifiedStandards) ? lesson.fullLesson.verifiedStandards : []);

      const codes = standards
        .map(s => String(s.code || s.standardCode || s.id || "").trim())
        .filter(Boolean);

      const notes = teacherNotes.value.trim();

      draftPill.textContent = "Generated";
      const out = buildDraft({ type, lessonTitle: title, standardsCodes: codes, teacherNotes: notes });

      draftJson.textContent = JSON.stringify(out, null, 2);
      draftOutputCard.classList.remove("hidden");
      draftOutputCard.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    btnCopyJson.addEventListener("click", () => copyToClipboard(draftJson.textContent));
    btnDownloadJson.addEventListener("click", () => {
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      downloadJson(`assessment-draft-${ts}.json`, safeParse(draftJson.textContent) || {});
    });

    // =========
    // Upload actions
    // =========
    const btnClearUpload = document.getElementById("btnClearUpload");
    const btnGenerateUpload = document.getElementById("btnGenerateUpload");
    const uploadOutputCard = document.getElementById("uploadOutputCard");
    const uploadJson = document.getElementById("uploadJson");
    const uploadPill = document.getElementById("uploadPill");
    const btnCopyUploadJson = document.getElementById("btnCopyUploadJson");
    const btnDownloadUploadJson = document.getElementById("btnDownloadUploadJson");

    btnClearUpload.addEventListener("click", () => {
      uploadedLessonText.value = "";
      autoSizeTextarea(uploadedLessonText);
      document.getElementById("uploadAssessmentType").value = "Exit tickets";
      document.getElementById("uploadTeacherNotes").value = "";
      uploadOutputCard.classList.add("hidden");
      uploadJson.textContent = "{}";
      uploadPill.textContent = "Ready";
    });

    btnGenerateUpload.addEventListener("click", () => {
      const lessonText = uploadedLessonText.value.trim();
      if (!lessonText){
        alert("Paste a lesson first.");
        return;
      }

      const type = document.getElementById("uploadAssessmentType").value;
      const notes = String(document.getElementById("uploadTeacherNotes").value || "").trim();

      // naive standards detection (codes-like tokens) for metadata only
      const codes = Array.from(new Set(
        (lessonText.match(/\b[A-Z]{2,5}[-.]?\d{1,2}(?:\.\d+){0,3}\b/g) || [])
          .map(x => x.trim())
      ));

      uploadPill.textContent = "Generated";
      const out = buildDraft({
        type,
        lessonTitle: "Uploaded Lesson",
        standardsCodes: codes,
        teacherNotes: notes
      });

      uploadJson.textContent = JSON.stringify(out, null, 2);
      uploadOutputCard.classList.remove("hidden");
      uploadOutputCard.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    btnCopyUploadJson.addEventListener("click", () => copyToClipboard(uploadJson.textContent));
    btnDownloadUploadJson.addEventListener("click", () => {
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      downloadJson(`assessment-draft-upload-${ts}.json`, safeParse(uploadJson.textContent) || {});
    });

    // Initial autosize pass (so it never scrolls right)
    window.addEventListener("DOMContentLoaded", () => {
      autoSizeTextarea(teacherNotes);
      autoSizeTextarea(uploadedLessonText);
    });
  </script>
</body>
</html>
