<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assessments - LessonBuilders</title>

  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --orangeLight:#FFB380;
      --green:#10B981;
      --blue:#3B82F6;
      --gray1:#F7FAFC;
      --gray2:#E2E8F0;
      --text:#0D2847;
      --muted:#4A5568;
      --muted2:#718096;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,#F7FAFC 0%, #FFF 100%);
      color:var(--text);
    }

    /* Top nav (matches your theme) */
    .top-nav{
      background:white;
      border-bottom:2px solid rgba(13,40,71,0.1);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;
      font-weight:700;
      color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;
      color:var(--muted);
      font-weight:500;
      font-size:15px;
      transition:color .2s;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{color:var(--navy);font-weight:700;}
    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),var(--orangeLight));
      display:flex;align-items:center;justify-content:center;
      color:white;font-weight:700;font-size:14px;
      cursor:default;
      user-select:none;
    }

    /* Layout */
    .container{display:flex;max-width:1400px;margin:0 auto;}
    .sidebar{
      width:280px;
      background:white;
      border-right:1px solid rgba(13,40,71,0.1);
      padding:30px 20px;
    }
    .sidebar-title{
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.6px;
      color:#999;
      margin-bottom:16px;
    }

    .nav-step{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      margin-bottom:8px;
      transition:all .2s;
      border-left:3px solid transparent;
      text-decoration:none;
      color:var(--muted);
      cursor:pointer;
      border-radius:10px;
    }
    .nav-step:hover{
      background:rgba(255,140,66,0.06);
      color:var(--navy);
    }
    .nav-step.active{
      background:rgba(255,140,66,0.10);
      border-left-color:var(--orange);
      color:var(--navy);
      font-weight:700;
    }
    .step-icon{
      width:28px;height:28px;border-radius:50%;
      background:var(--gray1);
      border:2px solid var(--gray2);
      display:flex;align-items:center;justify-content:center;
      font-size:13px;font-weight:800;color:#999;
      flex:0 0 auto;
    }
    .nav-step.active .step-icon{
      background:var(--orange);
      border-color:var(--orange);
      color:white;
    }

    .main-content{flex:1;padding:40px 60px;max-width:980px;}
    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:42px;
      font-weight:700;
      margin-bottom:10px;
      color:var(--navy);
    }
    .page-subtitle{
      font-size:18px;
      color:var(--muted);
      margin-bottom:18px;
      line-height:1.4;
    }
    .progress-bar{height:6px;background:var(--gray2);border-radius:3px;margin-bottom:18px;}
    .progress-fill{height:100%;width:40%;background:linear-gradient(90deg,var(--orange),var(--orangeLight));border-radius:3px;}

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background:white;
      border:2px solid var(--gray2);
      border-radius:16px;
      padding:18px;
    }
    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    .card-title{
      font-size:18px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:4px;
    }
    .card-subtitle{
      font-size:14px;
      color:var(--muted2);
      line-height:1.4;
    }

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .field{flex:1;min-width:240px;}
    .label{
      display:block;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
      color:var(--muted2);
      margin:10px 0 6px;
    }
    select, input[type="text"], input[type="file"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:2px solid var(--gray2);
      background:white;
      color:var(--navy);
      font-size:15px;
      font-family:'DM Sans',sans-serif;
    }
    select:focus, input:focus{
      outline:none;
      border-color:var(--orange);
      box-shadow:0 0 0 3px rgba(255,140,66,0.12);
    }

    .pill-group{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
    .pill{
      border:2px solid var(--gray2);
      background:white;
      color:var(--navy);
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:all .2s;
      user-select:none;
    }
    .pill:hover{border-color:var(--orange);}
    .pill.active{
      border-color:var(--orange);
      background:rgba(255,140,66,0.10);
    }

    .btn-row{display:flex;align-items:center;gap:12px;margin-top:14px;flex-wrap:wrap;}
    .btn{
      padding:12px 16px;
      border-radius:12px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      transition:all .25s;
      border:none;
      font-family:'DM Sans',sans-serif;
      user-select:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),var(--orangeLight));
      color:white;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 26px rgba(255,140,66,0.22);
    }
    .btn-secondary{
      background:white;
      border:2px solid var(--gray2);
      color:var(--navy);
    }
    .btn-secondary:hover{border-color:var(--orange);}
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none !important;
    }

    .hint{
      font-size:13px;
      color:var(--muted2);
      margin-top:8px;
      line-height:1.4;
    }

    /* Right preview (optional stub) */
    .preview{
      margin-top:14px;
      background:rgba(13,40,71,0.03);
      border:2px dashed rgba(13,40,71,0.18);
      border-radius:16px;
      padding:14px;
    }
    .preview-title{
      font-weight:900;
      color:var(--navy);
      margin-bottom:6px;
    }
    .preview-body{
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    /* Tabs (main content) */
    .tab{display:none;}
    .tab.active{display:block;}

    /* Responsive */
    @media (max-width: 900px){
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:16px;flex-wrap:wrap;}
      .container{flex-direction:column;max-width:100%;}
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid rgba(13,40,71,0.1);
        padding:14px 12px;
        display:flex;
        gap:10px;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
      }
      .sidebar-title{display:none;}
      .nav-step{
        flex:0 0 auto;
        margin-bottom:0;
        border-left:none;
        border-bottom:3px solid transparent;
        border-radius:12px;
        background:#fff;
        white-space:nowrap;
      }
      .nav-step.active{
        border-bottom-color:var(--orange);
      }
      .main-content{padding:22px 16px;max-width:100%;}
    }
    @media (max-width: 520px){
      .page-title{font-size:32px;}
      .page-subtitle{font-size:15px;}
      .field{min-width: 100%;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link">My Lessons</a>
        <a href="assessments.html" class="nav-link active">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-title">ASSESSMENTS</div>

      <div class="nav-step active" id="tabBtnCreate" onclick="switchTab('create')">
        <div class="step-icon">A</div>
        <div>Create from Lesson</div>
      </div>

      <div class="nav-step" id="tabBtnUpload" onclick="switchTab('upload')">
        <div class="step-icon">↑</div>
        <div>Upload Existing</div>
      </div>
    </aside>

    <main class="main-content">
      <h1 class="page-title">Assessments</h1>
      <p class="page-subtitle">Create classroom-ready assessments from your lessons — or upload what you already have and enhance it.</p>
      <div class="progress-bar"><div class="progress-fill"></div></div>

      <!-- =========================
           TAB: CREATE FROM LESSON
           ========================= -->
      <section class="tab active" id="tab-create">
        <div class="grid">

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Create from a lesson</div>
                <div class="card-subtitle">Choose a saved lesson (or your current build) and generate an assessment draft.</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label class="label" for="lessonSelect">Select lesson</label>
                <select id="lessonSelect"></select>
                <div class="hint" id="lessonHint"></div>
              </div>

              <div class="field">
                <label class="label" for="assessmentNotes">Teacher notes (optional)</label>
                <input id="assessmentNotes" type="text" placeholder="Ex: focus on vocabulary + guided practice outcomes" />
                <div class="hint">Tip: Use this to steer difficulty, format, or focus.</div>
              </div>
            </div>

            <label class="label" style="margin-top:12px;">Assessment type</label>
            <div class="pill-group" id="typePills">
              <div class="pill active" data-type="exit_ticket">Exit Ticket</div>
              <div class="pill" data-type="in_class_activity">In-Class Activity</div>
              <div class="pill" data-type="homework_assignment">Homework Assignment</div>
              <div class="pill" data-type="quiz">Quiz</div>
            </div>

            <div class="btn-row">
              <button class="btn btn-primary" id="btnGenerate" onclick="mockGenerate()">Generate Draft</button>
              <button class="btn btn-secondary" onclick="clearPreview()">Clear</button>
            </div>

            <div class="preview" id="previewBox" style="display:none;">
              <div class="preview-title">Preview (UI stub)</div>
              <div class="preview-body" id="previewText"></div>
            </div>

            <div class="hint" style="margin-top:10px;">
              Note: This page currently shows a UI preview. When you’re ready, we’ll wire this to your backend endpoint (e.g., <code>/api/generate-assessment</code>).
            </div>
          </div>

        </div>
      </section>

      <!-- =========================
           TAB: UPLOAD EXISTING
           ========================= -->
      <section class="tab" id="tab-upload">
        <div class="grid">

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Upload an existing assessment</div>
                <div class="card-subtitle">Bring what you already use. Later we can generate an answer key, rubric, and standards alignment.</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label class="label" for="uploadFile">Upload file</label>
                <input id="uploadFile" type="file" accept=".pdf,.doc,.docx,.txt" />
                <div class="hint">Accepted: PDF, DOC/DOCX, TXT (MVP UI). Upload processing comes next.</div>
              </div>

              <div class="field">
                <label class="label" for="uploadMeta">Optional notes</label>
                <input id="uploadMeta" type="text" placeholder="Ex: Grade 4 math, focus on fractions + word problems" />
                <div class="hint">This helps later when we build the enhancement tools.</div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn btn-primary" onclick="mockUpload()">Save Upload (UI stub)</button>
              <button class="btn btn-secondary" onclick="resetUpload()">Reset</button>
            </div>

            <div class="preview" id="uploadPreview" style="display:none;">
              <div class="preview-title">Upload captured (UI stub)</div>
              <div class="preview-body" id="uploadPreviewText"></div>
            </div>
          </div>

        </div>
      </section>

    </main>
  </div>

  <script>
    // -----------------------------
    // Top-right initials bubble
    // -----------------------------
    function initialsFromEmail(email) {
      if (!email) return "LB";
      const namePart = String(email).split("@")[0] || "";
      const tokens = namePart.split(/[.\-_]/).filter(Boolean);
      const a = tokens[0]?.[0] || "";
      const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
      const ini = (a + b).toUpperCase();
      return ini || "LB";
    }
    (function setInitials(){
      const el = document.getElementById("userProfile");
      if (!el) return;
      try{
        const raw = localStorage.getItem("lb_user") || localStorage.getItem("user") || "";
        if (raw) {
          const u = JSON.parse(raw);
          const email = u?.email || u?.user?.email;
          el.textContent = initialsFromEmail(email);
        } else {
          el.textContent = "LB";
        }
      } catch { el.textContent = "LB"; }
    })();

    // -----------------------------
    // Tabs (left nav)
    // -----------------------------
    function switchTab(which){
      const createBtn = document.getElementById("tabBtnCreate");
      const uploadBtn = document.getElementById("tabBtnUpload");
      const createTab = document.getElementById("tab-create");
      const uploadTab = document.getElementById("tab-upload");

      if (which === "upload") {
        createBtn.classList.remove("active");
        uploadBtn.classList.add("active");
        createTab.classList.remove("active");
        uploadTab.classList.add("active");
      } else {
        uploadBtn.classList.remove("active");
        createBtn.classList.add("active");
        uploadTab.classList.remove("active");
        createTab.classList.add("active");
      }
    }

    // -----------------------------
    // Lesson dropdown (better looking + useful)
    // Pulls from:
    // - localStorage.savedLessons (from Step 6 saveToLibrary)
    // - fallback: localStorage.lessonData (current build)
    // -----------------------------
    function safeParse(jsonStr){ try { return JSON.parse(jsonStr); } catch { return null; } }

    function getSavedLessons(){
      const raw = localStorage.getItem("savedLessons");
      const arr = raw ? safeParse(raw) : null;
      return Array.isArray(arr) ? arr : [];
    }

    function getCurrentLessonData(){
      const raw = localStorage.getItem("lessonData");
      const obj = raw ? safeParse(raw) : null;
      return obj && typeof obj === "object" ? obj : null;
    }

    function labelFromLessonItem(item){
      // item might be a saved lesson object OR lessonData structure
      const title = item?.title || item?.step1?.topic || "Untitled Lesson";
      const grade = item?.grade || item?.step1?.grade || "";
      const subject = item?.subject || item?.step1?.subject || "";
      const parts = [title];
      const meta = [grade, subject].filter(Boolean).join(" • ");
      if (meta) parts.push(`(${meta})`);
      return parts.join(" ");
    }

    function buildLessonSelect(){
      const sel = document.getElementById("lessonSelect");
      const hint = document.getElementById("lessonHint");
      if (!sel) return;

      const saved = getSavedLessons();
      const current = getCurrentLessonData();

      const options = [];

      if (current && (current?.step1?.topic || current?.generatedLesson)) {
        options.push({ key:"current", label:`Most recent build — ${labelFromLessonItem(current)}`, data: current });
      }

      // Most recent first
      saved.slice().reverse().forEach((s, idx) => {
        options.push({ key:`saved_${idx}`, label: labelFromLessonItem(s), data: s });
      });

      sel.innerHTML = "";
      if (!options.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No lessons found yet (build one first)";
        sel.appendChild(opt);
        sel.disabled = true;
        hint.textContent = "Go build a lesson and click Continue on Step 6 so it saves to 'My Lessons'.";
        return;
      }

      options.forEach((o, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = o.label;
        sel.appendChild(opt);
      });

      sel.disabled = false;
      hint.textContent = "Tip: saved lessons come from Step 6 → Continue (it writes to localStorage.savedLessons).";

      // stash
      window.__LB_ASSESSMENT_OPTIONS__ = options;
    }

    // -----------------------------
    // Type pills selection
    // -----------------------------
    function getSelectedType(){
      const pills = Array.from(document.querySelectorAll("#typePills .pill"));
      const active = pills.find(p => p.classList.contains("active"));
      return active ? active.getAttribute("data-type") : "exit_ticket";
    }
    function setupTypePills(){
      const pills = Array.from(document.querySelectorAll("#typePills .pill"));
      pills.forEach(p => {
        p.addEventListener("click", () => {
          pills.forEach(x => x.classList.remove("active"));
          p.classList.add("active");
        });
      });
    }

    // -----------------------------
    // UI stubs (no backend yet)
    // These are placeholders so you can SEE the page today.
    // -----------------------------
    function mockGenerate(){
      const sel = document.getElementById("lessonSelect");
      const notes = document.getElementById("assessmentNotes").value || "";
      const previewBox = document.getElementById("previewBox");
      const previewText = document.getElementById("previewText");

      const options = window.__LB_ASSESSMENT_OPTIONS__ || [];
      const idx = Number(sel?.value || 0);
      const chosen = options[idx]?.data || null;

      const type = getSelectedType();
      const typeLabel = ({
        exit_ticket:"Exit Ticket",
        in_class_activity:"In-Class Activity",
        homework_assignment:"Homework Assignment",
        quiz:"Quiz"
      })[type] || "Assessment";

      const title = chosen?.title || chosen?.step1?.topic || "Untitled Lesson";
      const grade = chosen?.grade || chosen?.step1?.grade || "";
      const subject = chosen?.subject || chosen?.step1?.subject || "";
      const std = Array.isArray(chosen?.verifiedStandards || chosen?.fullLesson?.verifiedStandards)
        ? (chosen.verifiedStandards || chosen.fullLesson.verifiedStandards)
        : (Array.isArray(chosen?.verifiedStandards) ? chosen.verifiedStandards : []);

      const stdCodes = (std || []).map(s => s.code || s.id).filter(Boolean).slice(0,3).join(", ");

      const out = [
        `${typeLabel} — Draft (UI Preview)`,
        `Lesson: ${title}`,
        [grade, subject].filter(Boolean).join(" • "),
        stdCodes ? `Aligned (codes): ${stdCodes}` : "Aligned (codes): —",
        notes ? `Teacher notes: ${notes}` : "",
        "",
        "Next step: wire this button to /api/generate-assessment",
        "Return shape will be:",
        "- studentCopy",
        "- answerKey",
        "- rubric",
        "- metadata (alignment, difficulty, etc.)"
      ].filter(Boolean).join("\n");

      previewText.textContent = out;
      previewBox.style.display = "block";
    }

    function clearPreview(){
      const previewBox = document.getElementById("previewBox");
      const previewText = document.getElementById("previewText");
      previewText.textContent = "";
      previewBox.style.display = "none";
      document.getElementById("assessmentNotes").value = "";
    }

    function mockUpload(){
      const file = document.getElementById("uploadFile")?.files?.[0] || null;
      const meta = document.getElementById("uploadMeta")?.value || "";
      const box = document.getElementById("uploadPreview");
      const text = document.getElementById("uploadPreviewText");

      if (!file){
        alert("Please choose a file first.");
        return;
      }

      text.textContent = [
        "Upload captured (UI Preview)",
        `File: ${file.name}`,
        `Size: ${Math.round(file.size/1024)} KB`,
        meta ? `Notes: ${meta}` : "",
        "",
        "Next step: wire this to an endpoint like /api/assessments/upload",
        "Then allow enhancements: answer key, rubric, standards alignment."
      ].filter(Boolean).join("\n");

      box.style.display = "block";
    }

    function resetUpload(){
      const input = document.getElementById("uploadFile");
      const meta = document.getElementById("uploadMeta");
      const box = document.getElementById("uploadPreview");
      const text = document.getElementById("uploadPreviewText");
      if (input) input.value = "";
      if (meta) meta.value = "";
      if (text) text.textContent = "";
      if (box) box.style.display = "none";
    }

    // -----------------------------
    // Init
    // -----------------------------
    window.addEventListener("DOMContentLoaded", () => {
      buildLessonSelect();
      setupTypePills();
    });
  </script>
</body>
</html>
