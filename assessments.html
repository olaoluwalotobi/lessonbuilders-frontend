<!-- assessments.html  (drop into the same folder as your other pages) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Assessments - LessonBuilders</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --orange-light:#FFB380;
      --green:#10B981;
      --blue:#3B82F6;
      --slate:#4A5568;
      --muted:#718096;
      --border:#E2E8F0;
      --bg:#F7FAFC;
      --card:#ffffff;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,var(--bg) 0%,#FFF 100%);
      color:var(--navy);
    }

    /* Top Nav */
    .top-nav{
      background:white;
      border-bottom:2px solid rgba(13,40,71,0.1);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;font-weight:700;color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;color:var(--slate);
      font-weight:500;font-size:15px;transition:color .2s;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{color:var(--navy);font-weight:700;}
    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      display:flex;align-items:center;justify-content:center;
      color:white;font-weight:700;font-size:14px;
      cursor:default;
    }

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:34px 40px 80px;}
    .header{
      display:flex;justify-content:space-between;align-items:flex-start;
      gap:20px;margin-bottom:18px;
    }
    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:44px;font-weight:700;color:var(--navy);
      margin-bottom:6px;line-height:1.1;
    }
    .page-subtitle{
      font-size:16px;color:var(--muted);max-width:720px;line-height:1.5;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,140,66,.10);
      color:var(--navy);
      font-weight:700;font-size:13px;
      border:1px solid rgba(255,140,66,.25);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:22px;
      align-items:start;
      margin-top:18px;
    }

    .card{
      background:var(--card);
      border:2px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.03);
    }

    .card-title{
      font-size:16px;font-weight:800;color:var(--navy);
      margin-bottom:6px;
    }
    .card-subtitle{
      font-size:13px;color:var(--muted);
      margin-bottom:12px;line-height:1.45;
    }
    .divider{height:1px;background:var(--border);margin:14px 0;}

    /* Inputs */
    label{display:block;font-size:12px;font-weight:800;color:var(--navy);margin:10px 0 6px;}
    .input, .select, .textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:2px solid var(--border);
      background:#fff;
      color:var(--navy);
      font-size:14px;
      outline:none;
    }
    .textarea{min-height:90px;resize:vertical;}
    .input:focus, .select:focus, .textarea:focus{border-color:rgba(255,140,66,.75);}

    .row{display:flex;gap:10px;align-items:center;}
    .row > * {flex:1;}

    /* Buttons */
    .btn{
      padding:12px 14px;border-radius:12px;
      font-size:14px;font-weight:800;cursor:pointer;
      transition:all .25s;border:none;
      display:inline-flex;align-items:center;justify-content:center;
      text-decoration:none;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      color:white;
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 24px rgba(255,140,66,.25);
    }
    .btn-secondary{
      background:white;border:2px solid var(--border);color:var(--navy);
    }
    .btn-secondary:hover{border-color:rgba(255,140,66,.65);}

    .btn-muted{
      background:#F8FAFC;border:2px solid var(--border);color:var(--slate);
    }

    /* Assessment type cards */
    .type-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .type{
      border:2px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      transition:all .2s;
      min-height:82px;
      display:flex;flex-direction:column;gap:6px;
    }
    .type:hover{border-color:rgba(255,140,66,.60);box-shadow:0 8px 20px rgba(0,0,0,0.04);}
    .type.active{
      border-color:var(--orange);
      background:rgba(255,140,66,.08);
    }
    .type-name{font-weight:900;color:var(--navy);font-size:14px;}
    .type-desc{color:var(--muted);font-size:12px;line-height:1.35;}

    /* Right side output */
    .right-top{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:12px;flex-wrap:wrap;
    }
    .lesson-chip{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      font-size:13px;color:var(--muted);
    }
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:700;color:var(--slate);
    }

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      padding:10px 12px;border-radius:999px;
      border:2px solid var(--border);
      background:#fff;
      font-weight:900;font-size:13px;
      color:var(--slate);
      cursor:pointer;
      transition:all .2s;
    }
    .tab.active{
      border-color:var(--orange);
      color:var(--navy);
      background:rgba(255,140,66,.08);
    }

    .output{
      border:2px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:14px;
      min-height:360px;
    }
    pre{
      white-space:pre-wrap;
      word-wrap:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      color:#111827;
      line-height:1.45;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    .status{
      margin-top:10px;
      font-size:12px;
      min-height:18px;
      color:var(--muted);
    }
    .status.ok{color:#059669;font-weight:700;}
    .status.err{color:#ef4444;font-weight:700;}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr; }
      .wrap{padding:22px 16px 70px;}
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:16px;flex-wrap:wrap;}
      .page-title{font-size:34px;}
      .type-grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link">My Lessons</a>
        <a href="assessments.html" class="nav-link active">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="wrap">
    <div class="header">
      <div>
        <h1 class="page-title">Assessments</h1>
        <p class="page-subtitle">
          Turn a lesson into student-ready work in one click. Choose a lesson (or upload one),
          select an assessment type, and generate a Student Copy, Answer Key, Rubric, and Metadata.
        </p>
      </div>
      <div class="pill">MVP • LocalStorage now • DB later</div>
    </div>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <div class="card-title">1) Choose a lesson</div>
        <div class="card-subtitle">
          Pick from <b>My Lessons</b> (saved from Step 6) or upload a lesson JSON.
        </div>

        <label for="lessonSelect">From My Lessons</label>
        <select id="lessonSelect" class="select">
          <option value="">Loading lessons…</option>
        </select>

        <div class="divider"></div>

        <div class="card-title" style="margin-top:2px;">Or upload a lesson</div>
        <div class="card-subtitle">Upload the JSON you export/save (lessonData or savedLessons entry).</div>

        <input id="fileInput" type="file" class="input" accept=".json,application/json" />
        <div class="row" style="margin-top:10px;">
          <button class="btn btn-muted" id="btnUseCurrent">Use Current (lessonData)</button>
          <button class="btn btn-secondary" id="btnClear">Clear</button>
        </div>

        <div class="divider"></div>

        <div class="card-title">2) Choose assessment type</div>
        <div class="card-subtitle">Start simple. These are the four core types.</div>

        <div class="type-grid" id="typeGrid">
          <div class="type active" data-type="exit_ticket">
            <div class="type-name">Exit Ticket</div>
            <div class="type-desc">Quick check for understanding (5–10 mins).</div>
          </div>
          <div class="type" data-type="in_class_activity">
            <div class="type-name">In-Class Activity</div>
            <div class="type-desc">Hands-on task aligned to the lesson steps.</div>
          </div>
          <div class="type" data-type="homework_assignment">
            <div class="type-name">Homework Assignment</div>
            <div class="type-desc">Practice + transfer at home (15–25 mins).</div>
          </div>
          <div class="type" data-type="quiz">
            <div class="type-name">Quiz</div>
            <div class="type-desc">Short quiz (mixed item types) + key.</div>
          </div>
        </div>

        <label for="notes" style="margin-top:12px;">Teacher Notes (optional)</label>
        <textarea id="notes" class="textarea" placeholder="Example: Make it shorter, add reading passage, focus on vocabulary…"></textarea>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-secondary" id="btnPreviewPrompt">Preview Prompt</button>
          <button class="btn btn-primary" id="btnGenerate">Generate Assessment</button>
        </div>

        <div class="status" id="status"></div>
        <div class="hint">
          <b>Note:</b> This UI works now. If your backend endpoint isn’t live yet, it will show a clean
          “demo output” so you can see the layout.
        </div>
      </div>

      <!-- RIGHT: Output -->
      <div class="card">
        <div class="right-top">
          <div>
            <div class="card-title" style="margin-bottom:4px;">Output</div>
            <div class="lesson-chip" id="lessonChip">
              <span class="chip">No lesson selected</span>
            </div>
          </div>
          <div class="row" style="max-width:420px;">
            <button class="btn btn-secondary" id="btnCopy">Copy Tab</button>
            <button class="btn btn-secondary" id="btnDownload">Download JSON</button>
          </div>
        </div>

        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="studentCopy">Student Copy</button>
          <button class="tab" data-tab="answerKey">Answer Key</button>
          <button class="tab" data-tab="rubric">Rubric</button>
          <button class="tab" data-tab="metadata">Metadata</button>
        </div>

        <div class="output">
          <pre id="outputPre">Select a lesson, choose an assessment type, and click “Generate Assessment”.</pre>
        </div>

        <div class="hint">
          You can link this page from Step 6 with a “Create Assessments” button later.
          For now, it pulls from <code>localStorage.savedLessons</code> and <code>localStorage.lessonData</code>.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Helpers
    // ----------------------------
    function safeParse(str){ try { return JSON.parse(str); } catch { return null; } }
    function pretty(obj){ return JSON.stringify(obj, null, 2); }
    function escapeText(s){ return String(s ?? ""); }

    function initialsFromEmail(email) {
      if (!email) return "LB";
      const namePart = String(email).split("@")[0] || "";
      const tokens = namePart.split(/[.\-_]/).filter(Boolean);
      const a = tokens[0]?.[0] || "";
      const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
      const ini = (a + b).toUpperCase();
      return ini || "LB";
    }

    function setProfileBubble(){
      const el = document.getElementById("userProfile");
      if (!el) return;
      try {
        const raw = localStorage.getItem("lb_user") || localStorage.getItem("user") || "";
        if (raw) {
          const u = JSON.parse(raw);
          const email = u?.email || u?.user?.email;
          el.textContent = initialsFromEmail(email);
        } else {
          el.textContent = "LB";
        }
      } catch {
        el.textContent = "LB";
      }
    }

    function getSavedLessons(){
      const raw = localStorage.getItem("savedLessons");
      const arr = raw ? (safeParse(raw) || []) : [];
      return Array.isArray(arr) ? arr : [];
    }

    function normalizeLessonObject(obj){
      // Accept either a savedLessons entry or raw lessonData export
      if (!obj) return null;

      // If it's a savedLessons entry:
      if (obj.fullLesson && obj.generatedLesson) {
        return {
          title: obj.title || obj.fullLesson?.step1?.topic || "Untitled Lesson",
          grade: obj.grade || obj.fullLesson?.step1?.grade || "",
          subject: obj.subject || obj.fullLesson?.step1?.subject || "",
          framework: obj.framework || obj.fullLesson?.step3?.framework || "",
          duration: obj.duration || obj.fullLesson?.step1?.duration || "",
          verifiedStandards: Array.isArray(obj.verifiedStandards) ? obj.verifiedStandards : (obj.fullLesson?.verifiedStandards || []),
          generatedLesson: obj.generatedLesson,
          fullLesson: obj.fullLesson
        };
      }

      // If it's lessonData (from localStorage.lessonData or upload):
      if (obj.step1 && (obj.generatedLesson || obj.generatedLesson === null || obj.step3 || obj.step5)) {
        return {
          title: obj.step1?.topic || "Untitled Lesson",
          grade: obj.step1?.grade || "",
          subject: obj.step1?.subject || "",
          framework: obj.step3?.framework || "",
          duration: obj.step1?.duration || "",
          verifiedStandards: Array.isArray(obj.verifiedStandards) ? obj.verifiedStandards : [],
          generatedLesson: obj.generatedLesson || null,
          fullLesson: obj
        };
      }

      // If it's already a normalized structure:
      if (obj.title && (obj.generatedLesson || obj.fullLesson)) return obj;

      return null;
    }

    function standardsCodes(arr){
      const s = Array.isArray(arr) ? arr : [];
      const codes = s.map(x => String(x.code || x.id || x.standardCode || "").trim()).filter(Boolean);
      return Array.from(new Set(codes)).slice(0, 10);
    }

    // ----------------------------
    // Assessment prompt builder (for preview)
    // ----------------------------
    function buildAssessmentPrompt({ lesson, typeKey, teacherNotes }){
      const gl = lesson?.generatedLesson || {};
      const codes = standardsCodes(lesson?.verifiedStandards);
      const summary = gl.summary || "";
      const objectives = Array.isArray(gl.objectives) ? gl.objectives : [];
      const vocab = Array.isArray(gl.keyVocabulary) ? gl.keyVocabulary : [];

      const typeNames = {
        exit_ticket: "Exit Ticket",
        in_class_activity: "In-Class Activity",
        homework_assignment: "Homework Assignment",
        quiz: "Quiz"
      };

      return `
You are LessonBuilders. Create an assessment aligned to the provided lesson.

Return ONLY valid JSON. No markdown. No extra text.
All line breaks inside strings MUST be escaped as \\n.

Assessment type: ${typeNames[typeKey] || typeKey}

Return JSON:
{
  "studentCopy":"string",
  "answerKey":"string",
  "rubric":"string",
  "metadata":{
    "type":"exit_ticket|in_class_activity|homework_assignment|quiz",
    "alignedStandards":["CODE1","CODE2"],
    "lessonTitle":"string",
    "grade":"string",
    "subject":"string",
    "notes":"string"
  }
}

Lesson snapshot (teacher-facing):
- Title: ${lesson?.title || ""}
- Grade: ${lesson?.grade || ""}
- Subject: ${lesson?.subject || ""}
- Standards Codes: ${codes.length ? codes.join(", ") : "None provided"}
- Summary: ${summary}
- Objectives: ${objectives.join(" | ")}
- Key Vocabulary: ${vocab.join(", ")}

Teacher notes (apply if present):
${teacherNotes || "None."}

Rules:
- studentCopy must be ready to print.
- answerKey must match studentCopy exactly.
- rubric should be simple and scorable (4 levels or points).
- metadata.alignedStandards must be codes only (no official wording).
      `.trim();
    }

    // ----------------------------
    // Demo generator (fallback until backend endpoint exists)
    // ----------------------------
    function demoAssessment({ lesson, typeKey, teacherNotes }){
      const codes = standardsCodes(lesson?.verifiedStandards);
      const title = lesson?.title || "Untitled Lesson";
      const grade = lesson?.grade || "";
      const subject = lesson?.subject || "";

      const typeLabel = ({
        exit_ticket: "Exit Ticket",
        in_class_activity: "In-Class Activity",
        homework_assignment: "Homework Assignment",
        quiz: "Quiz"
      })[typeKey] || typeKey;

      const studentCopy = [
        `${typeLabel} — ${title}`,
        grade || subject ? `(${[grade, subject].filter(Boolean).join(" • ")})` : "",
        "",
        "Directions: Answer the questions in complete sentences unless told otherwise.",
        "",
        "1) In 1–2 sentences, explain the main idea of today’s lesson.",
        "2) Use one key vocabulary term from the lesson correctly in a sentence.",
        "3) What evidence would prove you understand the concept?",
        "4) Write one question you still have.",
        "",
        teacherNotes ? `Teacher focus note: ${teacherNotes}` : ""
      ].filter(Boolean).join("\n");

      const answerKey = [
        `${typeLabel} — Answer Key`,
        "",
        "1) Main idea: (Sample) Students should describe the lesson’s central concept accurately.",
        "2) Vocabulary: (Sample) Uses a correct term and correct meaning in context.",
        "3) Evidence: (Sample) Provides a relevant example, explanation, or application.",
        "4) Question: Student-generated; evaluate for relevance."
      ].join("\n");

      const rubric = [
        "Rubric (4-point)",
        "",
        "4 — Accurate, complete, uses vocabulary precisely, strong evidence.",
        "3 — Mostly accurate, minor gaps, vocabulary mostly correct.",
        "2 — Partially accurate, unclear vocabulary use, weak evidence.",
        "1 — Incomplete or incorrect, minimal effort."
      ].join("\n");

      return {
        studentCopy,
        answerKey,
        rubric,
        metadata: {
          type: typeKey,
          alignedStandards: codes,
          lessonTitle: title,
          grade,
          subject,
          notes: teacherNotes || ""
        }
      };
    }

    // ----------------------------
    // State
    // ----------------------------
    const API_URL = (localStorage.getItem("API_URL") || "https://lessonbuilders-backend-production.up.railway.app").replace(/\/$/, "");
    let selectedType = "exit_ticket";
    let selectedLesson = null;
    let latestAssessment = null;
    let activeTab = "studentCopy";

    // ----------------------------
    // UI Elements
    // ----------------------------
    const lessonSelect = document.getElementById("lessonSelect");
    const fileInput = document.getElementById("fileInput");
    const btnUseCurrent = document.getElementById("btnUseCurrent");
    const btnClear = document.getElementById("btnClear");
    const btnGenerate = document.getElementById("btnGenerate");
    const btnPreviewPrompt = document.getElementById("btnPreviewPrompt");
    const notesEl = document.getElementById("notes");
    const statusEl = document.getElementById("status");
    const outputPre = document.getElementById("outputPre");
    const tabsEl = document.getElementById("tabs");
    const lessonChip = document.getElementById("lessonChip");
    const btnCopy = document.getElementById("btnCopy");
    const btnDownload = document.getElementById("btnDownload");

    function setStatus(msg, kind){
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (kind ? " " + kind : "");
    }

    function renderLessonChip(){
      if (!selectedLesson){
        lessonChip.innerHTML = `<span class="chip">No lesson selected</span>`;
        return;
      }
      const codes = standardsCodes(selectedLesson.verifiedStandards);
      const parts = [
        selectedLesson.title ? `<span class="chip"><b>${escapeText(selectedLesson.title)}</b></span>` : "",
        selectedLesson.grade ? `<span class="chip">${escapeText(selectedLesson.grade)}</span>` : "",
        selectedLesson.subject ? `<span class="chip">${escapeText(selectedLesson.subject)}</span>` : "",
        codes.length ? `<span class="chip">${codes.length} std</span>` : `<span class="chip">0 std</span>`
      ].filter(Boolean);
      lessonChip.innerHTML = parts.join("");
    }

    function renderOutput(){
      if (!latestAssessment){
        outputPre.textContent = "Select a lesson, choose an assessment type, and click “Generate Assessment”.";
        return;
      }
      const map = {
        studentCopy: latestAssessment.studentCopy,
        answerKey: latestAssessment.answerKey,
        rubric: latestAssessment.rubric,
        metadata: pretty(latestAssessment.metadata || {})
      };
      outputPre.textContent = map[activeTab] || "";
    }

    function setActiveTab(tab){
      activeTab = tab;
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.getAttribute("data-tab") === tab);
      });
      renderOutput();
    }

    // ----------------------------
    // Load lessons into dropdown
    // ----------------------------
    function loadLessonsDropdown(){
      const lessons = getSavedLessons();
      const opts = [];

      opts.push(`<option value="">Select a saved lesson…</option>`);
      if (!lessons.length){
        opts.push(`<option value="" disabled>No saved lessons found (save one from Step 6)</option>`);
      } else {
        lessons
          .slice()
          .reverse()
          .forEach((l, idx) => {
            const title = l.title || l.fullLesson?.step1?.topic || "Untitled Lesson";
            const meta = [l.grade, l.subject].filter(Boolean).join(" • ");
            opts.push(`<option value="${idx}">${title}${meta ? " — " + meta : ""}</option>`);
          });
      }

      lessonSelect.innerHTML = opts.join("");
      lessonSelect.value = "";
    }

    function selectLessonFromSaved(indexFromTop){
      const lessons = getSavedLessons().slice().reverse();
      const raw = lessons[indexFromTop];
      const norm = normalizeLessonObject(raw);
      selectedLesson = norm;
      latestAssessment = null;
      renderLessonChip();
      renderOutput();
    }

    function selectLessonFromLessonDataStorage(){
      const raw = localStorage.getItem("lessonData");
      if (!raw) {
        setStatus("No lessonData found in localStorage. Build a lesson first.", "err");
        return;
      }
      const obj = safeParse(raw);
      const norm = normalizeLessonObject(obj);
      if (!norm){
        setStatus("lessonData exists but format wasn’t recognized.", "err");
        return;
      }
      selectedLesson = norm;
      latestAssessment = null;
      renderLessonChip();
      renderOutput();
      setStatus("Loaded current lessonData.", "ok");
    }

    async function selectLessonFromUpload(file){
      const text = await file.text();
      const obj = safeParse(text);
      const norm = normalizeLessonObject(obj);
      if (!norm){
        setStatus("Uploaded JSON wasn’t recognized as a LessonBuilders lesson.", "err");
        return;
      }
      selectedLesson = norm;
      latestAssessment = null;
      renderLessonChip();
      renderOutput();
      setStatus("Uploaded lesson loaded.", "ok");
    }

    // ----------------------------
    // Generate Assessment
    // ----------------------------
    async function generateAssessment(){
      if (!selectedLesson){
        setStatus("Select a lesson first.", "err");
        return;
      }

      const teacherNotes = String(notesEl.value || "").trim();

      // This is the payload you’ll later send to a real endpoint:
      const payload = {
        type: selectedType,
        teacherNotes,
        lesson: {
          title: selectedLesson.title,
          grade: selectedLesson.grade,
          subject: selectedLesson.subject,
          framework: selectedLesson.framework,
          verifiedStandards: selectedLesson.verifiedStandards || [],
          generatedLesson: selectedLesson.generatedLesson || null
        }
      };

      setStatus("Generating…", "");
      btnGenerate.disabled = true;

      try{
        // If/when you add a backend endpoint, this is the call:
        // POST ${API_URL}/api/generate-assessment
        // For now: attempt it, then fallback to demo.
        let out = null;

        try{
          const res = await fetch(`${API_URL}/api/generate-assessment`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if (res.ok){
            const data = await res.json().catch(() => null);
            // Expecting: { studentCopy, answerKey, rubric, metadata }
            if (data && data.studentCopy && data.answerKey && data.rubric && data.metadata){
              out = data;
              setStatus("Generated from backend.", "ok");
            }
          }
        } catch {
          // ignore; fallback below
        }

        if (!out){
          out = demoAssessment({ lesson:selectedLesson, typeKey:selectedType, teacherNotes });
          setStatus("Backend endpoint not live yet — showing demo output (UI preview).", "ok");
        }

        latestAssessment = out;
        setActiveTab("studentCopy");
        renderLessonChip();
        renderOutput();
      } catch (e){
        console.error(e);
        setStatus("Generation failed. Check console/logs.", "err");
      } finally{
        btnGenerate.disabled = false;
      }
    }

    function previewPrompt(){
      if (!selectedLesson){
        setStatus("Select a lesson first to preview prompt.", "err");
        return;
      }
      const teacherNotes = String(notesEl.value || "").trim();
      const prompt = buildAssessmentPrompt({ lesson:selectedLesson, typeKey:selectedType, teacherNotes });
      latestAssessment = {
        studentCopy: prompt,
        answerKey: "(This tab shows the prompt preview. Not generated yet.)",
        rubric: "(This tab shows the prompt preview. Not generated yet.)",
        metadata: { preview: true, type: selectedType }
      };
      setStatus("Showing prompt preview in Student Copy tab.", "ok");
      setActiveTab("studentCopy");
      renderLessonChip();
      renderOutput();
    }

    function copyActiveTab(){
      const txt = outputPre.textContent || "";
      if (!txt) return;
      navigator.clipboard.writeText(txt).then(() => {
        setStatus("Copied to clipboard.", "ok");
      }).catch(() => {
        setStatus("Copy failed (browser permissions).", "err");
      });
    }

    function downloadAssessmentJSON(){
      if (!latestAssessment){
        setStatus("Nothing to download yet.", "err");
        return;
      }
      const title = (selectedLesson?.title || "assessment").replace(/[^\w\-]+/g,"_");
      const blob = new Blob([pretty(latestAssessment)], { type:"application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${title}__${selectedType}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("Downloaded JSON.", "ok");
    }

    // ----------------------------
    // Events
    // ----------------------------
    document.getElementById("typeGrid").addEventListener("click", (e) => {
      const t = e.target.closest(".type");
      if (!t) return;
      selectedType = t.getAttribute("data-type") || "exit_ticket";
      document.querySelectorAll(".type").forEach(x => x.classList.toggle("active", x === t));
      setStatus(`Type selected: ${selectedType.replaceAll("_"," ")}`, "ok");
    });

    lessonSelect.addEventListener("change", () => {
      const v = lessonSelect.value;
      if (v === ""){
        selectedLesson = null;
        latestAssessment = null;
        renderLessonChip();
        renderOutput();
        setStatus("", "");
        return;
      }
      const idx = Number(v);
      if (!Number.isFinite(idx)) return;
      selectLessonFromSaved(idx);
      setStatus("Lesson loaded from My Lessons.", "ok");
    });

    fileInput.addEventListener("change", async () => {
      const f = fileInput.files && fileInput.files[0];
      if (!f) return;
      await selectLessonFromUpload(f);
    });

    btnUseCurrent.addEventListener("click", () => selectLessonFromLessonDataStorage());
    btnClear.addEventListener("click", () => {
      selectedLesson = null;
      latestAssessment = null;
      lessonSelect.value = "";
      fileInput.value = "";
      notesEl.value = "";
      renderLessonChip();
      renderOutput();
      setStatus("Cleared.", "");
    });

    btnGenerate.addEventListener("click", generateAssessment);
    btnPreviewPrompt.addEventListener("click", previewPrompt);

    tabsEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".tab");
      if (!btn) return;
      setActiveTab(btn.getAttribute("data-tab"));
    });

    btnCopy.addEventListener("click", copyActiveTab);
    btnDownload.addEventListener("click", downloadAssessmentJSON);

    // ----------------------------
    // Init
    // ----------------------------
    window.addEventListener("DOMContentLoaded", () => {
      setProfileBubble();
      loadLessonsDropdown();
      renderLessonChip();
      renderOutput();
      setStatus("", "");

      // If they have lessonData and no savedLessons yet, nudge:
      const hasSaved = getSavedLessons().length > 0;
      const hasCurrent = !!localStorage.getItem("lessonData");
      if (!hasSaved && hasCurrent){
        setStatus("Tip: Click “Use Current (lessonData)” to load your latest build.", "ok");
      }
    });
  </script>
</body>
</html>
