<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>My Lessons - LessonBuilders</title>

  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --orange-light:#FFB380;
      --gray-50:#F7FAFC;
      --gray-100:#EDF2F7;
      --gray-200:#E2E8F0;
      --gray-500:#718096;
      --gray-600:#4A5568;
      --green:#10B981;
      --blue:#3B82F6;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,#F7FAFC 0%,#FFF 100%);
      color:var(--navy);
    }

    /* Top nav */
    .top-nav{
      background:#fff;
      border-bottom:2px solid rgba(13,40,71,0.08);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;font-weight:700;
      color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;
      color:var(--gray-600);
      font-weight:500;
      font-size:15px;
      transition:color 0.2s;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{
      color:var(--navy);
      font-weight:700;
      position:relative;
    }
    .nav-link.active::after{
      content:"";
      position:absolute;
      left:0; right:0;
      bottom:-18px;
      height:3px;border-radius:999px;
      background:linear-gradient(90deg,var(--orange),var(--orange-light));
    }
    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:14px;
      cursor:default;
    }

    /* Layout */
    .container{display:flex;max-width:1400px;margin:0 auto;}
    .sidebar{
      width:300px;
      background:#fff;
      border-right:1px solid rgba(13,40,71,0.08);
      padding:26px 18px;
    }
    .side-title{
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.6px;
      color:#999;
      margin-bottom:14px;
    }
    .filter-card{
      background:#fff;
      border:2px solid var(--gray-200);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }
    .filter-title{
      font-size:12px;
      font-weight:900;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:#6B7280;
      margin-bottom:10px;
    }
    .filter-row{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{
      border:1px solid var(--gray-200);
      background:#fff;
      color:var(--navy);
      font-size:13px;
      font-weight:700;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      transition:all .15s;
    }
    .chip:hover{border-color:rgba(255,140,66,.6);}
    .chip.active{
      background:rgba(255,140,66,0.12);
      border-color:rgba(255,140,66,.5);
    }

    .side-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      padding:12px 14px;
      border-radius:10px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      border:none;
      transition:all .2s;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),var(--orange-light));
      color:#fff;
    }
    .btn-secondary{
      background:#fff;
      border:2px solid var(--gray-200);
      color:var(--navy);
    }
    .btn-secondary:hover{border-color:var(--orange);}

    .main{
      flex:1;
      padding:34px 44px;
      max-width:1020px;
    }
    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:42px;
      font-weight:700;
      color:var(--navy);
      margin-bottom:8px;
    }
    .page-subtitle{
      font-size:16px;
      color:var(--gray-600);
      margin-bottom:16px;
      line-height:1.5;
    }
    .toolbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .search{
      flex:1;
      min-width:260px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      width:100%;
      border:2px solid var(--gray-200);
      border-radius:12px;
      padding:12px 12px;
      font-size:15px;
      outline:none;
      transition:border-color .15s;
    }
    .input:focus{border-color:var(--orange);}
    .select{
      border:2px solid var(--gray-200);
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      font-weight:700;
      outline:none;
      background:#fff;
      color:var(--navy);
    }
    .select:focus{border-color:var(--orange);}

    .grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:14px;
      margin-top:10px;
    }
    .card{
      background:#fff;
      border:2px solid var(--gray-200);
      border-radius:16px;
      padding:16px;
      transition:all .2s;
    }
    .card:hover{
      border-color:rgba(255,140,66,.55);
      box-shadow:0 8px 24px rgba(0,0,0,0.08);
      transform:translateY(-2px);
    }
    .card-title{
      font-size:16px;
      font-weight:900;
      color:var(--navy);
      margin-bottom:6px;
      line-height:1.25;
    }
    .card-meta{
      font-size:13px;
      color:var(--gray-600);
      line-height:1.45;
      margin-bottom:10px;
    }
    .pill-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
    .pill{
      font-size:12px;
      font-weight:900;
      color:var(--navy);
      background:rgba(255,140,66,0.12);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,140,66,0.22);
      white-space:nowrap;
    }
    .pill.gray{
      background:rgba(13,40,71,0.06);
      border-color:rgba(13,40,71,0.12);
      color:var(--navy);
    }
    .card-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top:8px;
    }

    .empty{
      background:#fff;
      border:2px dashed var(--gray-200);
      border-radius:16px;
      padding:18px;
      color:var(--gray-600);
      line-height:1.55;
    }

    @media (max-width: 900px){
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:16px;flex-wrap:wrap;}
      .container{flex-direction:column;}
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid rgba(13,40,71,0.08);
        padding:14px 12px;
      }
      .main{padding:22px 16px;max-width:100%;}
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link active">My Lessons</a>
        <a href="assessments.html" class="nav-link">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <div class="side-title">FILTER</div>

      <div class="filter-card">
        <div class="filter-title">By Subject</div>
        <div class="filter-row" id="subjectChips"></div>
      </div>

      <div class="filter-card">
        <div class="filter-title">By Template</div>
        <div class="filter-row" id="templateChips"></div>
      </div>

      <div class="filter-card">
        <div class="filter-title">By Grade</div>
        <div class="filter-row" id="gradeChips"></div>
      </div>

      <div class="side-actions">
        <button class="btn btn-secondary" id="btnClearFilters" type="button">Clear</button>
        <button class="btn btn-primary" onclick="window.location.href='build-step1.html'" type="button">New Lesson</button>
      </div>
    </aside>

    <main class="main">
      <h1 class="page-title">My Lessons</h1>
      <p class="page-subtitle">Your saved lesson library. Filter by subject, template, or grade.</p>

      <div class="toolbar">
        <div class="search">
          <input id="searchInput" class="input" placeholder="Search lesson titles, standards codes, or keywords..." />
        </div>
        <select id="sortSelect" class="select">
          <option value="newest">Sort: Newest</option>
          <option value="oldest">Sort: Oldest</option>
          <option value="titleAZ">Sort: Title A–Z</option>
          <option value="titleZA">Sort: Title Z–A</option>
        </select>
      </div>

      <div id="resultsMeta" class="page-subtitle" style="margin-bottom:10px;"></div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;"></div>
    </main>
  </div>

  <script type="module">
    function initialsFromEmail(email) {
      if (!email) return "LB";
      const namePart = String(email).split("@")[0] || "";
      const tokens = namePart.split(/[.\-_]/).filter(Boolean);
      const a = tokens[0]?.[0] || "";
      const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
      const ini = (a + b).toUpperCase();
      return ini || "LB";
    }
    const el = document.getElementById("userProfile");
    if (el) {
      try {
        const raw = localStorage.getItem("lb_user") || localStorage.getItem("user") || "";
        if (raw) {
          const u = JSON.parse(raw);
          const email = u?.email || u?.user?.email;
          el.textContent = initialsFromEmail(email);
        } else el.textContent = "LB";
      } catch { el.textContent = "LB"; }
    }
  </script>

  <script>
    // --- data helpers ---
    function safeParse(str){ try { return JSON.parse(str); } catch { return null; } }
    function getSavedLessons(){
      const raw = localStorage.getItem("savedLessons");
      const arr = raw ? (safeParse(raw) || []) : [];
      return Array.isArray(arr) ? arr : [];
    }

    function normalizeSubject(s){
      const t = String(s||"").toLowerCase();
      if (t.includes("science")) return "Science";
      if (t.includes("history") || t.includes("social")) return "History";
      if (t.includes("math")) return "Math";
      if (t.includes("ela") || t.includes("english")) return "ELA";
      if (t.includes("pe") || t.includes("physical")) return "PE";
      if (t.includes("art") || t.includes("vapa")) return "Arts";
      return s ? String(s) : "Unknown";
    }

    function normalizeGrade(g){
      const s = String(g||"").trim();
      if (!s) return "Unknown";
      const m = s.match(/\b(\d{1,2})\b/);
      if (m) return m[1];
      if (s.toLowerCase().includes("k")) return "K";
      if (s.toLowerCase().includes("ms")) return "MS";
      if (s.toLowerCase().includes("hs")) return "HS";
      return s;
    }

    function frameworkName(key){
      const k = String(key||"").toLowerCase();
      if (k.includes("madeline")) return "Madeline Hunter";
      if (k.includes("5e")) return "5E Model";
      if (k.includes("ubd")) return "UbD (Hybrid)";
      if (k.includes("gradual")) return "Gradual Release";
      return key ? String(key) : "Template";
    }

    function standardsCodes(lesson){
      const a = Array.isArray(lesson?.verifiedStandards) ? lesson.verifiedStandards : [];
      const b = Array.isArray(lesson?.fullLesson?.verifiedStandards) ? lesson.fullLesson.verifiedStandards : [];
      const s = (a.length ? a : b);
      return s.map(x => String(x.code || x.standardCode || x.id || "").trim()).filter(Boolean);
    }

    // --- state ---
    const state = {
      subject: null,
      template: null,
      grade: null,
      search: "",
      sort: "newest",
    };

    // --- UI refs ---
    const subjectChips = document.getElementById("subjectChips");
    const templateChips = document.getElementById("templateChips");
    const gradeChips = document.getElementById("gradeChips");
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const resultsMeta = document.getElementById("resultsMeta");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    // --- chips builder ---
    function buildChips(container, values, activeValue, onPick){
      container.innerHTML = "";
      const all = document.createElement("div");
      all.className = "chip" + (!activeValue ? " active" : "");
      all.textContent = "All";
      all.addEventListener("click", () => onPick(null));
      container.appendChild(all);

      values.forEach(v => {
        const c = document.createElement("div");
        c.className = "chip" + (activeValue === v ? " active" : "");
        c.textContent = v;
        c.addEventListener("click", () => onPick(v));
        container.appendChild(c);
      });
    }

    function uniqueSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
    }

    // --- render ---
    function applyFilters(allLessons){
      let list = allLessons.slice();

      if (state.subject){
        list = list.filter(l => normalizeSubject(l.subject || l.fullLesson?.step1?.subject) === state.subject);
      }
      if (state.template){
        list = list.filter(l => frameworkName(l.framework || l.fullLesson?.step3?.framework) === state.template);
      }
      if (state.grade){
        list = list.filter(l => normalizeGrade(l.grade || l.fullLesson?.step1?.grade) === state.grade);
      }
      if (state.search){
        const q = state.search.toLowerCase();
        list = list.filter(l => {
          const title = String(l.title || l.fullLesson?.step1?.topic || "").toLowerCase();
          const subj = String(l.subject || l.fullLesson?.step1?.subject || "").toLowerCase();
          const g = String(l.grade || l.fullLesson?.step1?.grade || "").toLowerCase();
          const codes = standardsCodes(l).join(" ").toLowerCase();
          return title.includes(q) || subj.includes(q) || g.includes(q) || codes.includes(q);
        });
      }

      // sorting
      const dateVal = (x) => Date.parse(x.savedAt || x.generatedAt || "") || 0;
      if (state.sort === "newest") list.sort((a,b)=>dateVal(b)-dateVal(a));
      if (state.sort === "oldest") list.sort((a,b)=>dateVal(a)-dateVal(b));
      if (state.sort === "titleAZ") list.sort((a,b)=>String(a.title||"").localeCompare(String(b.title||"")));
      if (state.sort === "titleZA") list.sort((a,b)=>String(b.title||"").localeCompare(String(a.title||"")));

      return list;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderCards(list){
      grid.innerHTML = "";

      if (!list.length){
        empty.style.display = "block";
        empty.innerHTML = `
          <div style="font-weight:900;color:var(--navy);margin-bottom:6px;">No lessons found</div>
          <div>Try clearing filters or saving a lesson from Step 6 (Preview & Export).</div>
        `;
        return;
      }
      empty.style.display = "none";

      list.forEach(l => {
        const title = l.title || l.fullLesson?.step1?.topic || "Untitled Lesson";
        const grade = l.grade || l.fullLesson?.step1?.grade || "";
        const subject = normalizeSubject(l.subject || l.fullLesson?.step1?.subject || "");
        const framework = frameworkName(l.framework || l.fullLesson?.step3?.framework || "");
        const dur = l.duration || l.fullLesson?.step1?.duration || "";
        const codes = standardsCodes(l);
        const date = l.savedAt ? new Date(l.savedAt).toLocaleDateString() : "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-title">${escapeHtml(title)}</div>
          <div class="card-meta">
            <div><b>Grade:</b> ${escapeHtml(String(grade))} &nbsp; | &nbsp; <b>Subject:</b> ${escapeHtml(subject)} &nbsp; | &nbsp; <b>Duration:</b> ${escapeHtml(String(dur))} min</div>
            <div style="margin-top:4px;"><b>Template:</b> ${escapeHtml(framework)} ${date ? `&nbsp; | &nbsp; <b>Saved:</b> ${escapeHtml(date)}` : ""}</div>
          </div>
          <div class="pill-row">
            <span class="pill">${escapeHtml(subject)}</span>
            <span class="pill gray">${escapeHtml(framework)}</span>
            ${codes.slice(0,3).map(c=>`<span class="pill gray">${escapeHtml(c)}</span>`).join("")}
            ${codes.length > 3 ? `<span class="pill gray">+${codes.length-3} more</span>` : ""}
          </div>
          <div class="card-actions">
            <button class="btn btn-secondary" data-action="copy" style="padding:10px 12px;">Copy JSON</button>
            <button class="btn btn-primary" data-action="open" style="padding:10px 12px;">Open</button>
          </div>
        `;

        card.querySelector('[data-action="copy"]').addEventListener("click", () => {
          const payload = l.fullLesson || l;
          navigator.clipboard?.writeText(JSON.stringify(payload, null, 2))
            .then(()=>alert("Copied lesson JSON."))
            .catch(()=>alert("Could not copy (clipboard blocked)."));
        });

        card.querySelector('[data-action="open"]').addEventListener("click", () => {
          // Minimal “open”: store selected lesson and jump to Step 6 preview
          localStorage.setItem("lessonData", JSON.stringify(l.fullLesson || l));
          window.location.href = "build-step6.html";
        });

        grid.appendChild(card);
      });
    }

    function refresh(){
      const lessons = getSavedLessons();

      // build chip options from existing lessons
      const subjects = uniqueSorted(lessons.map(l => normalizeSubject(l.subject || l.fullLesson?.step1?.subject)));
      const templates = uniqueSorted(lessons.map(l => frameworkName(l.framework || l.fullLesson?.step3?.framework)));
      const grades = uniqueSorted(lessons.map(l => normalizeGrade(l.grade || l.fullLesson?.step1?.grade)));

      buildChips(subjectChips, subjects, state.subject, (v)=>{ state.subject=v; refresh(); });
      buildChips(templateChips, templates, state.template, (v)=>{ state.template=v; refresh(); });
      buildChips(gradeChips, grades, state.grade, (v)=>{ state.grade=v; refresh(); });

      const filtered = applyFilters(lessons);
      resultsMeta.textContent = `${filtered.length} lesson${filtered.length!==1?"s":""} shown`;

      renderCards(filtered);
    }

    // events
    searchInput.addEventListener("input", (e)=>{ state.search = e.target.value.trim(); refresh(); });
    sortSelect.addEventListener("change", (e)=>{ state.sort = e.target.value; refresh(); });

    document.getElementById("btnClearFilters").addEventListener("click", ()=>{
      state.subject=null; state.template=null; state.grade=null; state.search=""; state.sort="newest";
      searchInput.value="";
      sortSelect.value="newest";
      refresh();
    });

    // init
    refresh();
  </script>
</body>
</html>
