<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>My Lessons - LessonBuilders</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --green:#10B981;
      --yellow:#F59E0B;
      --red:#EF4444;
      --blue:#3B82F6;
      --bg:#F7FAFC;
      --card:#FFFFFF;
      --line:rgba(13,40,71,0.10);
      --muted:#718096;
      --text:#0D2847;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html, body { height: 100%; }

    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,var(--bg) 0%,#FFF 100%);
      color:var(--text);
      display:flex;
      flex-direction:column;
    }

    .top-nav{
      background:#fff;
      border-bottom:2px solid var(--line);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;
      font-weight:700;
      color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;
      color:#4A5568;
      font-weight:600;
      font-size:15px;
      transition:color .2s;
      padding:8px 10px;
      border-radius:10px;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{color:var(--navy); background:rgba(255,140,66,0.10);}
    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),#FFB380);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:14px;
      cursor:default;
    }

    .container{
      display:flex;
      max-width:1400px;
      margin:0 auto;
      width:100%;
      flex:1;                /* ✅ full height layout */
      align-items:stretch;   /* ✅ stretch sidebar */
    }

    .sidebar{
      width:280px;
      background:#fff;
      border-right:1px solid var(--line);
      padding:26px 18px;
      min-height:100%;       /* ✅ full height white panel */
    }

    .side-title{
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.8px;
      color:#999;
      margin-bottom:14px;
    }

    .side-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-radius:12px;
      color:#4A5568;
      font-weight:700;
      cursor:pointer;
      transition:.2s;
      margin-bottom:8px;
      border:1px solid transparent;
    }
    .side-item:hover{background:rgba(255,140,66,0.08); border-color:rgba(255,140,66,0.12); color:var(--navy);}
    .side-item.active{background:rgba(255,140,66,0.12); color:var(--navy); border-color:rgba(255,140,66,0.25);}
    .side-dot{
      width:26px;height:26px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:#F7FAFC;
      border:2px solid #E2E8F0;
      font-size:12px;
      color:#888;
      flex:0 0 auto;
    }
    .side-item.active .side-dot{background:var(--orange);border-color:var(--orange);color:#fff;}

    .main{
      flex:1;
      padding:36px 54px;
      max-width:1040px;
      width:100%;
    }

    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:44px;
      font-weight:700;
      color:var(--navy);
      margin-bottom:8px;
    }
    .page-subtitle{color:#4A5568;font-size:16px;margin-bottom:18px;}
    .rule{
      height:6px;
      background:#E2E8F0;
      border-radius:999px;
      overflow:hidden;
      margin-bottom:20px;
    }
    .rule > div{
      height:100%;
      width:52%;
      background:linear-gradient(90deg,var(--orange),#FFB380);
    }

    .toolbar{
      display:flex;
      align-items:center;
      gap:14px;
      margin:14px 0 16px;
    }
    .search{
      flex:1;
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:12px;
      padding:12px 14px;
      font-size:15px;
      outline:none;
    }
    .search:focus{border-color:rgba(255,140,66,0.7);}

    .select{
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      font-weight:700;
      color:var(--navy);
      outline:none;
      min-width:170px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:16px;
      margin-top:10px;
    }

    .card{
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:16px;
      padding:16px 16px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }
    .card h3{
      font-size:18px;
      font-weight:800;
      color:var(--navy);
      margin-bottom:6px;
    }
    .meta{
      color:#4A5568;
      font-size:13px;
      margin-bottom:10px;
      line-height:1.4;
    }
    .pills{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-bottom:12px;
    }
    .pill{
      background:#F7FAFC;
      border:1px solid #E2E8F0;
      color:#2D3748;
      font-size:12px;
      font-weight:800;
      padding:7px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .btn-row{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
    }
    .btn{
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      border:none;
      transition:.2s;
      font-family:'DM Sans',sans-serif;
      font-size:14px;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),#FFB380);
      color:#fff;
    }
    .btn-primary:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(255,140,66,0.25);}
    .btn-secondary{
      background:#fff;
      border:2px solid #E2E8F0;
      color:var(--navy);
    }
    .btn-secondary:hover{border-color:rgba(255,140,66,0.55);}
    .btn-ghost{
      background:#fff;
      border:2px dashed #E2E8F0;
      color:#4A5568;
    }
    .btn-ghost:hover{border-color:rgba(255,140,66,0.55); color:var(--navy);}

    .empty{
      background:#fff;
      border:2px dashed #E2E8F0;
      border-radius:16px;
      padding:18px;
      color:#4A5568;
      margin-top:10px;
    }

    @media (max-width: 980px){
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:14px;flex-wrap:wrap;}
      .container{flex-direction:column;}
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid var(--line);
        padding:14px 12px;
        display:flex;
        gap:10px;
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
      }
      .side-title{display:none;}
      .side-item{flex:0 0 auto; margin-bottom:0;}
      .main{padding:22px 16px;max-width:100%;}
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link active">My Lessons</a>
        <a href="assessments.html" class="nav-link">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <div class="side-title">MY LESSONS</div>

      <div class="side-item active" data-filter="subject">
        <div class="side-dot">S</div>
        <div>By Subject</div>
      </div>

      <div class="side-item" data-filter="template">
        <div class="side-dot">T</div>
        <div>By Template</div>
      </div>

      <div class="side-item" data-filter="grade">
        <div class="side-dot">G</div>
        <div>By Grade</div>
      </div>
    </aside>

    <main class="main">
      <h1 class="page-title">My Lessons</h1>
      <p class="page-subtitle">Your saved lesson library. Filter by subject, template, or grade.</p>
      <div class="rule"><div></div></div>

      <div class="toolbar">
        <input id="search" class="search" placeholder="Search lesson titles, standards codes, or keywords..." />
        <select id="sort" class="select">
          <option value="newest" selected>Sort: Newest</option>
          <option value="oldest">Sort: Oldest</option>
          <option value="title">Sort: Title (A–Z)</option>
        </select>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">
        No saved lessons yet. Generate a lesson in Steps 1–7, then click Continue to save it here.
      </div>
    </main>
  </div>

  <script>
    // ---------------------------
    // Helpers / Storage contracts
    // ---------------------------
    const LS = {
      savedLessons: "savedLessons",
      discoverLessons: "discoverLessons",
      user: "lb_user"
    };

    function safeParse(s){ try{return JSON.parse(s);}catch{return null;} }
    function fmtDate(iso){
      if(!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",year:"numeric"});
      }catch{return "";}
    }
    function initialsFromEmail(email){
      if(!email) return "LB";
      const namePart = String(email).split("@")[0] || "";
      const tokens = namePart.split(/[.\-_]/).filter(Boolean);
      const a = tokens[0]?.[0] || "";
      const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
      const ini = (a + b).toUpperCase();
      return ini || "LB";
    }
    function getUserEmail(){
      try{
        const raw = localStorage.getItem(LS.user) || localStorage.getItem("user") || "";
        if(!raw) return "";
        const u = JSON.parse(raw);
        return u?.email || u?.user?.email || "";
      }catch{return "";}
    }
    document.getElementById("userProfile").textContent = initialsFromEmail(getUserEmail());

    function loadSavedLessons(){
      return safeParse(localStorage.getItem(LS.savedLessons)) || [];
    }
    function saveSavedLessons(arr){
      localStorage.setItem(LS.savedLessons, JSON.stringify(arr || []));
    }
    function loadDiscover(){
      return safeParse(localStorage.getItem(LS.discoverLessons)) || [];
    }
    function saveDiscover(arr){
      localStorage.setItem(LS.discoverLessons, JSON.stringify(arr || []));
    }

    // ---------------------------
    // Share logic (2 versions max)
    // ---------------------------
    function publishToDiscover(lesson){
      const discover = loadDiscover();

      const now = new Date().toISOString();
      const shareSnapshot = {
        versionAt: now,
        title: lesson.title,
        grade: lesson.grade,
        subject: lesson.subject,
        duration: lesson.duration,
        framework: lesson.framework,
        standards: Array.isArray(lesson.verifiedStandards) ? lesson.verifiedStandards : [],
        // Keep a lightweight snapshot that can reproduce/preview later:
        generatedLesson: lesson.generatedLesson || null,
        fullLesson: lesson.fullLesson || null
      };

      const existingIdx = discover.findIndex(x => x.lessonId === lesson.id);
      if(existingIdx === -1){
        discover.unshift({
          lessonId: lesson.id,
          author: lesson.author || "",
          sharedAt: now,
          lastSharedAt: now,
          versions: [shareSnapshot] // start
        });
      }else{
        const item = discover[existingIdx];
        const versions = Array.isArray(item.versions) ? item.versions : [];

        // Add new version to front, keep only 2
        versions.unshift(shareSnapshot);
        item.versions = versions.slice(0, 2);
        item.lastSharedAt = now;

        // keep top-level display
        item.author = lesson.author || item.author || "";
        item.sharedAt = item.sharedAt || now;

        discover[existingIdx] = item;
      }

      saveDiscover(discover);
      return now;
    }

    // Share button visibility rule:
    // - show if not shared yet
    // - OR lesson.updatedAt is newer than lesson.lastSharedAt
    function shouldShowShare(lesson){
      const lastShared = lesson.lastSharedAt ? new Date(lesson.lastSharedAt).getTime() : 0;
      const updated = lesson.updatedAt ? new Date(lesson.updatedAt).getTime() : 0;
      return !lesson.isShared || (updated > lastShared);
    }

    // ---------------------------
    // UI state (filters)
    // ---------------------------
    let activeFilter = "subject";

    document.querySelectorAll(".side-item").forEach(item=>{
      item.addEventListener("click", ()=>{
        document.querySelectorAll(".side-item").forEach(x=>x.classList.remove("active"));
        item.classList.add("active");
        activeFilter = item.getAttribute("data-filter") || "subject";
        render();
      });
    });

    document.getElementById("search").addEventListener("input", render);
    document.getElementById("sort").addEventListener("change", render);

    function matchesSearch(lesson, q){
      if(!q) return true;
      const s = q.toLowerCase().trim();
      const fields = [
        lesson.title,
        lesson.subject,
        lesson.grade,
        lesson.framework,
        ...(Array.isArray(lesson.verifiedStandards) ? lesson.verifiedStandards : [])
      ].join(" ").toLowerCase();
      return fields.includes(s);
    }

    function sortLessons(arr, mode){
      const a = [...arr];
      if(mode === "oldest") a.sort((x,y)=> new Date(x.savedAt||0) - new Date(y.savedAt||0));
      if(mode === "newest") a.sort((x,y)=> new Date(y.savedAt||0) - new Date(x.savedAt||0));
      if(mode === "title") a.sort((x,y)=> String(x.title||"").localeCompare(String(y.title||"")));
      return a;
    }

    function pill(text){
      return `<span class="pill">${escapeHtml(text)}</span>`;
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      const grid = document.getElementById("grid");
      const empty = document.getElementById("empty");
      const q = document.getElementById("search").value || "";
      const sortMode = document.getElementById("sort").value || "newest";

      const lessons = loadSavedLessons();
      const filtered = sortLessons(
        lessons.filter(l => matchesSearch(l, q)),
        sortMode
      );

      if(!filtered.length){
        grid.innerHTML = "";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      grid.innerHTML = filtered.map(l=>{
        const standards = Array.isArray(l.verifiedStandards) ? l.verifiedStandards : [];
        const topStandards = standards.slice(0, 3);
        const moreCount = Math.max(0, standards.length - topStandards.length);

        const shareVisible = shouldShowShare(l);
        const shareLabel = (!l.isShared) ? "Share" : "Share Update";

        return `
          <div class="card" data-id="${l.id}">
            <h3>${escapeHtml(l.title || "Untitled Lesson")}</h3>
            <div class="meta">
              Grade: <b>${escapeHtml(l.grade || "")}</b>
              &nbsp;|&nbsp; Subject: <b>${escapeHtml(l.subject || "")}</b>
              &nbsp;|&nbsp; Duration: <b>${escapeHtml(String(l.duration || ""))} min</b><br>
              Template: <b>${escapeHtml(l.framework || "")}</b>
              &nbsp;|&nbsp; Saved: <b>${escapeHtml(fmtDate(l.savedAt))}</b>
            </div>

            <div class="pills">
              ${pill(l.subject || "Subject")}
              ${pill(l.framework || "Template")}
              ${topStandards.map(s=>pill(s)).join("")}
              ${moreCount ? pill("+"+moreCount+" more") : ""}
            </div>

            <div class="btn-row">
              ${shareVisible ? `<button class="btn btn-secondary" data-action="share">${shareLabel}</button>` : ``}
              <button class="btn btn-primary" data-action="open">Open</button>
            </div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll("button[data-action]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const card = e.target.closest(".card");
          const id = Number(card?.getAttribute("data-id"));
          const action = e.target.getAttribute("data-action");
          if(!id) return;

          if(action === "open") openLesson(id);
          if(action === "share") shareLesson(id);
        });
      });
    }

    function openLesson(id){
      // Minimal MVP behavior: store selection; you can wire this to any view page you want later.
      localStorage.setItem("lb_open_lesson_id", String(id));
      // If you have a dedicated preview page later, route there. For now, go to step6 (preview/export) or keep on page.
      window.location.href = "build-step6.html";
    }

    function shareLesson(id){
      const lessons = loadSavedLessons();
      const idx = lessons.findIndex(l=>Number(l.id) === Number(id));
      if(idx === -1) return;

      const lesson = lessons[idx];

      // publish snapshot to discover, returns lastSharedAt
      const lastSharedAt = publishToDiscover({
        ...lesson,
        author: getUserEmail() || "LessonBuilders Teacher"
      });

      lesson.isShared = true;
      lesson.lastSharedAt = lastSharedAt;

      lessons[idx] = lesson;
      saveSavedLessons(lessons);

      alert("Shared to Discover ✅");
      render();
    }

    // Boot
    render();
  </script>
</body>
</html>
