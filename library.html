<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>My Lessons - LessonBuilders</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0D2847;
      --orange:#FF8C42;
      --bg:#F7FAFC;
      --line:rgba(13,40,71,0.10);
      --muted:#718096;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html, body{height:100%;}
    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,var(--bg) 0%,#FFF 100%);
      color:var(--navy);
      display:flex;
      flex-direction:column;
    }

    /* Top Nav */
    .top-nav{
      background:#fff;
      border-bottom:2px solid var(--line);
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .nav-left{display:flex;align-items:center;gap:40px;}
    .logo-text{
      font-family:'Crimson Pro',serif;
      font-size:24px;
      font-weight:700;
      color:var(--navy);
      text-decoration:none;
    }
    .nav-menu{display:flex;gap:32px;align-items:center;}
    .nav-link{
      text-decoration:none;
      color:#4A5568;
      font-weight:600;
      font-size:15px;
      transition:color .2s;
      padding:8px 10px;
      border-radius:10px;
    }
    .nav-link:hover{color:var(--navy);}
    .nav-link.active{color:var(--navy); background:rgba(255,140,66,0.10);}
    .nav-right{display:flex;align-items:center;gap:16px;}
    .user-profile{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--orange),#FFB380);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:14px;
      cursor:default;
    }

    /* Layout */
    .container{
      display:flex;
      max-width:1400px;
      margin:0 auto;
      width:100%;
      flex:1;
      align-items:stretch;
    }
    .sidebar{
      width:280px;
      background:#fff;
      border-right:1px solid var(--line);
      padding:26px 18px;
      min-height:100%;
    }

    .side-title{
      font-size:12px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.8px;
      color:#999;
      margin-bottom:14px;
    }

    .filter-block{
      border:2px solid #E2E8F0;
      border-radius:14px;
      padding:12px;
      margin-bottom:10px;
      transition:.2s;
      background:#fff;
    }
    .filter-block.active{
      border-color:rgba(255,140,66,0.55);
      background:rgba(255,140,66,0.06);
    }
    .filter-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .filter-left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#4A5568;
    }
    .filter-block.active .filter-left{ color:var(--navy); }
    .filter-dot{
      width:26px;height:26px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:#F7FAFC;border:2px solid #E2E8F0;
      font-size:12px;color:#888;flex:0 0 auto;
    }
    .filter-block.active .filter-dot{
      background:var(--orange);
      border-color:var(--orange);
      color:#fff;
    }
    .chev{
      font-weight:900;
      color:#A0AEC0;
      transition:transform .18s;
    }
    .filter-block.open .chev{ transform:rotate(180deg); }

    .filter-body{
      display:none;
      margin-top:10px;
    }
    .filter-block.open .filter-body{ display:block; }

    .filter-select{
      width:100%;
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      font-weight:800;
      color:var(--navy);
      outline:none;
    }
    .filter-select:focus{ border-color:rgba(255,140,66,0.7); }

    .filter-hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .reset-btn{
      width:100%;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      border:2px solid #E2E8F0;
      color:var(--navy);
      transition:.2s;
    }
    .reset-btn:hover{ border-color:rgba(255,140,66,0.55); }

    /* Main */
    .main{
      flex:1;
      padding:36px 54px;
      max-width:1040px;
      width:100%;
    }
    .page-title{
      font-family:'Crimson Pro',serif;
      font-size:44px;
      font-weight:700;
      color:var(--navy);
      margin-bottom:8px;
    }
    .page-subtitle{color:#4A5568;font-size:16px;margin-bottom:18px;}
    .rule{
      height:6px;
      background:#E2E8F0;
      border-radius:999px;
      overflow:hidden;
      margin-bottom:20px;
    }
    .rule > div{
      height:100%;
      width:52%;
      background:linear-gradient(90deg,var(--orange),#FFB380);
    }

    .toolbar{
      display:flex;
      align-items:center;
      gap:14px;
      margin:14px 0 16px;
    }
    .search{
      flex:1;
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:12px;
      padding:12px 14px;
      font-size:15px;
      outline:none;
    }
    .search:focus{border-color:rgba(255,140,66,0.7);}
    .sort{
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      font-weight:800;
      color:var(--navy);
      outline:none;
      min-width:170px;
    }

    .active-filter-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      font-weight:900;
      color:#2D3748;
      margin-top:8px;
    }
    .badge-dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--orange);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:16px;
      margin-top:10px;
    }
    .card{
      background:#fff;
      border:2px solid #E2E8F0;
      border-radius:16px;
      padding:16px 16px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }
    .card h3{
      font-size:18px;
      font-weight:900;
      color:var(--navy);
      margin-bottom:6px;
    }
    .meta{
      color:#4A5568;
      font-size:13px;
      margin-bottom:10px;
      line-height:1.4;
    }
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
    .pill{
      background:#F7FAFC;
      border:1px solid #E2E8F0;
      color:#2D3748;
      font-size:12px;
      font-weight:900;
      padding:7px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .btn-row{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
    }
    .btn{
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      border:none;
      transition:.2s;
      font-family:'DM Sans',sans-serif;
      font-size:14px;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--orange),#FFB380);
      color:#fff;
    }
    .btn-primary:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(255,140,66,0.25);}
    .btn-secondary{
      background:#fff;
      border:2px solid #E2E8F0;
      color:var(--navy);
    }
    .btn-secondary:hover{border-color:rgba(255,140,66,0.55);}

    .empty{
      background:#fff;
      border:2px dashed #E2E8F0;
      border-radius:16px;
      padding:18px;
      color:#4A5568;
      margin-top:10px;
    }

    @media (max-width: 980px){
      .top-nav{padding:12px 16px;flex-wrap:wrap;gap:10px;}
      .nav-left{gap:16px;flex-wrap:wrap;}
      .nav-menu{gap:14px;flex-wrap:wrap;}
      .container{flex-direction:column;}
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid var(--line);
        padding:14px 12px;
      }
      .main{padding:22px 16px;max-width:100%;}
      .grid{grid-template-columns:1fr;}
      .toolbar{flex-direction:column;align-items:stretch;}
      .sort{min-width:unset;}
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-left">
      <a href="index.html" class="logo-text">LessonBuilders</a>
      <div class="nav-menu">
        <a href="library.html" class="nav-link active">My Lessons</a>
        <!-- If your file is not named assessments.html, rename this link accordingly -->
        <a href="assessments.html" class="nav-link">Assessments</a>
        <a href="discover.html" class="nav-link">Discover</a>
        <a href="about.html" class="nav-link">Help</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-profile" id="userProfile">LB</div>
    </div>
  </nav>

  <div class="container">
    <aside class="sidebar">
      <div class="side-title">MY LESSONS</div>

      <!-- By Subject -->
      <div class="filter-block active open" id="fbSubject" data-type="subject">
        <div class="filter-head" role="button" aria-label="Filter by subject">
          <div class="filter-left">
            <div class="filter-dot">S</div>
            <div>By Subject</div>
          </div>
          <div class="chev">▼</div>
        </div>
        <div class="filter-body">
          <select id="selSubject" class="filter-select"></select>
          <div class="filter-hint">Pick a subject to filter your saved lessons.</div>
        </div>
      </div>

      <!-- By Template -->
      <div class="filter-block" id="fbTemplate" data-type="template">
        <div class="filter-head" role="button" aria-label="Filter by template">
          <div class="filter-left">
            <div class="filter-dot">T</div>
            <div>By Template</div>
          </div>
          <div class="chev">▼</div>
        </div>
        <div class="filter-body">
          <select id="selTemplate" class="filter-select"></select>
          <div class="filter-hint">Pick a template (framework) to filter.</div>
        </div>
      </div>

      <!-- By Grade -->
      <div class="filter-block" id="fbGrade" data-type="grade">
        <div class="filter-head" role="button" aria-label="Filter by grade">
          <div class="filter-left">
            <div class="filter-dot">G</div>
            <div>By Grade</div>
          </div>
          <div class="chev">▼</div>
        </div>
        <div class="filter-body">
          <select id="selGrade" class="filter-select"></select>
          <div class="filter-hint">Pick a grade to filter your library.</div>
        </div>
      </div>

      <button class="reset-btn" id="btnReset">Show All</button>
    </aside>

    <main class="main">
      <h1 class="page-title">My Lessons</h1>
      <p class="page-subtitle">Your saved lesson library. Filter by subject, template, or grade.</p>
      <div class="rule"><div></div></div>

      <div id="activeFilterBadge" class="active-filter-badge" style="display:none;">
        <span class="badge-dot"></span>
        <span id="activeFilterText"></span>
      </div>

      <div class="toolbar">
        <input id="search" class="search" placeholder="Search lesson titles, standards codes, or keywords..." />
        <select id="sort" class="sort">
          <option value="newest" selected>Sort: Newest</option>
          <option value="oldest">Sort: Oldest</option>
          <option value="title">Sort: Title (A–Z)</option>
        </select>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">
        No saved lessons yet. Generate a lesson in Steps 1–7, then click Continue to save it here.
      </div>
    </main>
  </div>

  <script>
    (function(){
      const LS = {
        savedLessons: "savedLessons",
        user: "lb_user"
      };

      function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }
      function escapeHtml(str){
        return String(str ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function initialsFromEmail(email){
        if(!email) return "LB";
        const namePart = String(email).split("@")[0] || "";
        const tokens = namePart.split(/[.\-_]/).filter(Boolean);
        const a = tokens[0]?.[0] || "";
        const b = tokens[1]?.[0] || tokens[0]?.[1] || "";
        const ini = (a + b).toUpperCase();
        return ini || "LB";
      }
      function getUserEmail(){
        try{
          const raw = localStorage.getItem(LS.user) || localStorage.getItem("user") || "";
          if(!raw) return "";
          const u = JSON.parse(raw);
          return u?.email || u?.user?.email || "";
        }catch{return "";}
      }
      document.getElementById("userProfile").textContent = initialsFromEmail(getUserEmail());

      function loadSavedLessons(){
        return safeParse(localStorage.getItem(LS.savedLessons)) || [];
      }

      function fmtDate(iso){
        if(!iso) return "";
        try{
          const d = new Date(iso);
          return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",year:"numeric"});
        }catch{return "";}
      }

      function pill(text){ return `<span class="pill">${escapeHtml(text)}</span>`; }

      // Filter State
      let filterType = "subject";  // subject | template | grade
      let filterValue = "ALL";     // selected value
      let searchValue = "";
      let sortMode = "newest";

      // Elements
      const grid = document.getElementById("grid");
      const empty = document.getElementById("empty");

      const badge = document.getElementById("activeFilterBadge");
      const badgeText = document.getElementById("activeFilterText");

      const selSubject = document.getElementById("selSubject");
      const selTemplate = document.getElementById("selTemplate");
      const selGrade = document.getElementById("selGrade");

      const fbSubject = document.getElementById("fbSubject");
      const fbTemplate = document.getElementById("fbTemplate");
      const fbGrade = document.getElementById("fbGrade");

      // Build dropdown options from saved lessons
      function uniqueSorted(arr){
        return Array.from(new Set(arr.filter(Boolean).map(x=>String(x).trim()).filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b));
      }

      function populateFilters(){
        const lessons = loadSavedLessons();

        const subjects = uniqueSorted(lessons.map(l => l.subject || l?.step1?.subject));
        const templates = uniqueSorted(lessons.map(l => l.framework || l?.step3?.framework));
        const grades = uniqueSorted(lessons.map(l => l.grade || l?.step1?.grade));

        selSubject.innerHTML = [`<option value="ALL">All Subjects</option>`]
          .concat(subjects.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`)).join("");

        selTemplate.innerHTML = [`<option value="ALL">All Templates</option>`]
          .concat(templates.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`)).join("");

        selGrade.innerHTML = [`<option value="ALL">All Grades</option>`]
          .concat(grades.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`)).join("");

        // keep selections consistent if possible
        if(filterType === "subject") selSubject.value = filterValue;
        if(filterType === "template") selTemplate.value = filterValue;
        if(filterType === "grade") selGrade.value = filterValue;
      }

      function setActiveBlock(type){
        const blocks = [
          { type:"subject", el: fbSubject },
          { type:"template", el: fbTemplate },
          { type:"grade", el: fbGrade },
        ];

        blocks.forEach(b=>{
          const isActive = b.type === type;
          b.el.classList.toggle("active", isActive);
          b.el.classList.toggle("open", isActive);
        });

        filterType = type;

        // sync filterValue from the right dropdown
        if(type === "subject") filterValue = selSubject.value || "ALL";
        if(type === "template") filterValue = selTemplate.value || "ALL";
        if(type === "grade") filterValue = selGrade.value || "ALL";

        render();
      }

      // Toggle open/close blocks (clicking header)
      function attachBlockToggle(blockEl, type){
        const head = blockEl.querySelector(".filter-head");
        head.addEventListener("click", ()=>{
          const isActive = blockEl.classList.contains("active");
          if(!isActive){
            setActiveBlock(type);
            return;
          }
          // If active, just toggle open state
          blockEl.classList.toggle("open");
        });
      }
      attachBlockToggle(fbSubject, "subject");
      attachBlockToggle(fbTemplate, "template");
      attachBlockToggle(fbGrade, "grade");

      // Dropdown change
      selSubject.addEventListener("change", ()=>{
        filterType = "subject";
        filterValue = selSubject.value || "ALL";
        setActiveBlock("subject");
      });
      selTemplate.addEventListener("change", ()=>{
        filterType = "template";
        filterValue = selTemplate.value || "ALL";
        setActiveBlock("template");
      });
      selGrade.addEventListener("change", ()=>{
        filterType = "grade";
        filterValue = selGrade.value || "ALL";
        setActiveBlock("grade");
      });

      document.getElementById("btnReset").addEventListener("click", ()=>{
        filterValue = "ALL";
        selSubject.value = "ALL";
        selTemplate.value = "ALL";
        selGrade.value = "ALL";
        badge.style.display = "none";
        render();
      });

      document.getElementById("search").addEventListener("input", (e)=>{
        searchValue = (e.target.value || "");
        render();
      });

      document.getElementById("sort").addEventListener("change", (e)=>{
        sortMode = e.target.value || "newest";
        render();
      });

      function matchesSearch(lesson, q){
        if(!q) return true;
        const s = q.toLowerCase().trim();
        const standards = Array.isArray(lesson.verifiedStandards) ? lesson.verifiedStandards : [];
        const fields = [
          lesson.title,
          lesson.subject,
          lesson.grade,
          lesson.framework,
          standards.join(" ")
        ].join(" ").toLowerCase();
        return fields.includes(s);
      }

      function matchesFilter(lesson){
        if(!filterValue || filterValue === "ALL") return true;

        const subject = String(lesson.subject || "");
        const grade = String(lesson.grade || "");
        const framework = String(lesson.framework || "");

        if(filterType === "subject") return subject.toLowerCase() === String(filterValue).toLowerCase();
        if(filterType === "grade") return grade.toLowerCase() === String(filterValue).toLowerCase();
        if(filterType === "template") return framework.toLowerCase() === String(filterValue).toLowerCase();
        return true;
      }

      function sortLessons(arr){
        const a = [...arr];
        if(sortMode === "oldest") a.sort((x,y)=> new Date(x.savedAt||0) - new Date(y.savedAt||0));
        if(sortMode === "newest") a.sort((x,y)=> new Date(y.savedAt||0) - new Date(x.savedAt||0));
        if(sortMode === "title") a.sort((x,y)=> String(x.title||"").localeCompare(String(y.title||"")));
        return a;
      }

      function updateBadge(){
        if(!filterValue || filterValue === "ALL"){
          badge.style.display = "none";
          return;
        }
        const label =
          filterType === "subject" ? "Subject" :
          filterType === "template" ? "Template" :
          "Grade";

        badgeText.textContent = `${label}: ${filterValue}`;
        badge.style.display = "inline-flex";
      }

      function render(){
        populateFilters();
        updateBadge();

        const lessons = loadSavedLessons();
        const filtered = sortLessons(
          lessons
            .filter(matchesFilter)
            .filter(l => matchesSearch(l, searchValue))
        );

        if(!lessons.length){
          grid.innerHTML = "";
          empty.style.display = "block";
          empty.textContent = "No saved lessons yet. Generate a lesson in Steps 1–7, then click Continue to save it here.";
          return;
        }

        if(!filtered.length){
          grid.innerHTML = "";
          empty.style.display = "block";
          empty.textContent = "No lessons match your current filter/search.";
          return;
        }

        empty.style.display = "none";

        grid.innerHTML = filtered.map(l=>{
          const standards = Array.isArray(l.verifiedStandards) ? l.verifiedStandards : [];
          const topStandards = standards.slice(0, 3);
          const moreCount = Math.max(0, standards.length - topStandards.length);

          return `
            <div class="card" data-id="${l.id}">
              <h3>${escapeHtml(l.title || "Untitled Lesson")}</h3>
              <div class="meta">
                Grade: <b>${escapeHtml(l.grade || "")}</b>
                &nbsp;|&nbsp; Subject: <b>${escapeHtml(l.subject || "")}</b>
                &nbsp;|&nbsp; Duration: <b>${escapeHtml(String(l.duration || ""))} min</b><br>
                Template: <b>${escapeHtml(l.framework || "")}</b>
                &nbsp;|&nbsp; Saved: <b>${escapeHtml(fmtDate(l.savedAt))}</b>
              </div>

              <div class="pills">
                ${pill(l.subject || "Subject")}
                ${pill(l.framework || "Template")}
                ${topStandards.map(s=>pill(s)).join("")}
                ${moreCount ? pill("+"+moreCount+" more") : ""}
              </div>

              <div class="btn-row">
                <button class="btn btn-primary" data-action="open">Open</button>
              </div>
            </div>
          `;
        }).join("");

        grid.querySelectorAll("button[data-action='open']").forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            const card = e.target.closest(".card");
            const id = card?.getAttribute("data-id");
            if(!id) return;
            localStorage.setItem("lb_open_lesson_id", String(id));
            // If you have a dedicated lesson view page, route there. Otherwise Step 6 preview.
            window.location.href = "build-step6.html";
          });
        });
      }

      // Initial render
      render();
    })();
  </script>
</body>
</html>
